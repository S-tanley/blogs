<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Using Clip to Music Generation</title>
      <link href="/blogs/2025/08/21/Using%20Clip%20to%20Music%20Generation/"/>
      <url>/blogs/2025/08/21/Using%20Clip%20to%20Music%20Generation/</url>
      
        <content type="html"><![CDATA[<p>最近看到了 CLIP，CLIP 应该算是多模态，或者算是 CV 那边的工作，但是我看到了非常多的把 CLIP 用到自己领域去做的文章，而且 CLIP 又很简单，最重要的一点是可以直接做 Zero-shot，我觉得我们可以直接尝试把 CLIP 模型用到我现在的这个 Music accompaniment generation 里。</p>]]></content>
      
      
      <categories>
          
          <category> Research Blogs </category>
          
      </categories>
      
      
        <tags>
            
            <tag> NLP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>理解 Zero-Shot, One-Shot, 和 Few-Shot 学习</title>
      <link href="/blogs/2025/08/16/%E7%90%86%E8%A7%A3%20Zero-Shot,%20One-Shot,%20%E5%92%8C%20Few-Shot%20%E5%AD%A6%E4%B9%A0/"/>
      <url>/blogs/2025/08/16/%E7%90%86%E8%A7%A3%20Zero-Shot,%20One-Shot,%20%E5%92%8C%20Few-Shot%20%E5%AD%A6%E4%B9%A0/</url>
      
        <content type="html"><![CDATA[<p>在机器学习，特别是计算机视觉领域，我们经常希望模型能够像人类一样，通过极少量的样本甚至仅仅通过描述就能认识新事物。Zero-Shot, One-Shot, 和 Few-Shot 学习就是旨在实现这一目标的关键技术。这些术语描述了模型在面对一个从未见过的“新类别”时，学习和识别它所需要的样本数量。</p><h3 id="基础：在“基类”上预训练">基础：在“基类”上预训练</h3><p>所有这些学习范式都有一个共同的起点：一个在大量标注数据（包含丰富的“基类”或“可见类”，Seen Classes）上预训练好的模型。这个预训练阶段的目的并非让模型记住这些基类，而是让它学习到一种通用的、可迁移的能力，例如：</p><ol><li>学会提取鲁棒且有意义的视觉特征。</li><li>学会如何“学习”和“比较”（即元学习或度量学习）。</li><li>学会关联图像的视觉空间和文字的语义空间。</li></ol><p>有了这个强大的预训练模型作为基础，我们才能讨论它如何应对“未见类别”。</p><h3 id="Zero-Shot-Learning-零样本学习">Zero-Shot Learning (零样本学习)</h3><p>当模型需要识别一个新类别，但<strong>没有任何</strong>（K=0）该类别的图像样本时，我们称之为零样本学习。</p><p>工作原理：</p><p>既然没有图像样本，模型依赖于辅助的语义信息 (Semantic Information) 来进行推理。这些信息为模型提供了关于新类别的描述性知识。</p><ul><li><strong>学习依据</strong>：通常是类别的<strong>属性描述</strong>（例如，“斑马”的属性是“有条纹”、“像马”、“黑白色”）或<strong>词向量</strong>（Word Vectors）。</li><li><strong>核心能力</strong>：<strong>视觉-语义匹配</strong>。模型必须是经过特殊设计的（例如，像CLIP这样的视觉-语言模型），它能够将输入图像的视觉特征，与不同类别的文字描述进行匹配，并找出匹配度最高的那个作为预测结果。</li><li><strong>关键点</strong>：一个标准的图像分类器（如在ImageNet上训练的ResNet）无法直接进行零样本学习，因为它不具备将视觉特征与任意语义描述关联的能力。</li></ul><p>简而言之，零样本学习是给模型一本“字典”（语义描述），让它去识别一本没有插图的“书”（新类别的图像）。</p><h3 id="One-Shot-与-Few-Shot-学习-一样本与小样本学习">One-Shot 与 Few-Shot 学习 (一样本与小样本学习)</h3><p>当模型在识别新类别时，被允许接触少量标注样本时，我们称之为小样本学习。</p><ul><li><strong>One-Shot Learning (K=1)</strong>：为每个新类别提供<strong>一个</strong>标注样本。</li><li><strong>Few-Shot Learning (K&gt;1)</strong>：为每个新类别提供<strong>少数几个</strong>（K个，通常K很小，如5或10）标注样本。</li></ul><p><strong>核心区别：并非Fine-tuning，而是“比对”</strong></p><p>一个常见的误区是认为 One-Shot/Few-Shot 学习就是用这 K 个样本对预训练模型进行微调 (Fine-tuning)。这种做法通常是不可行的，因为它会导致两个严重问题：</p><ol><li><strong>灾难性遗忘 (Catastrophic Forgetting)</strong>：模型会忘记在预训练阶段学到的通用知识。</li><li><strong>严重过拟合 (Severe Overfitting)</strong>：模型会完美记住这 K 个样本的全部细节，但无法泛化到同类别其他稍有不同的图像上。</li></ol><p>正确的范式是<strong>度量学习 (Metric Learning)</strong> 或<strong>元学习 (Meta-Learning)</strong>。在这个范式中，预训练模型的<strong>权重在测试阶段是冻结的</strong>，不进行更新。</p><ul><li><strong>学习依据</strong>：提供的 K 个标注样本被用作**“参考样本” (Support Samples)**。</li><li><strong>核心能力</strong>：<strong>特征相似度比较</strong>。模型作为一个强大的特征提取器和比较器，它会提取“查询样本”（待分类的图片）和“参考样本”的特征，并通过计算它们在特征空间中的距离来判断它们是否属于同一类别。</li></ul><p>一个很好的类比是人脸识别系统：系统通过学习数百万张人脸，掌握了“比较两张脸是否为同一个人”的能力（预训练）。当你录入一个新的人脸时，只需一张照片（One-Shot），系统会将其特征存为参考，而不会重新训练整个网络。之后，它通过比较新照片与参考照片的特征相似度来进行识别。</p><h3 id="总结对比">总结对比</h3><table><thead><tr><th>特性</th><th>Zero-Shot Learning (零样本)</th><th>One-Shot Learning (一样本)</th><th>Few-Shot Learning (小样本)</th></tr></thead><tbody><tr><td><strong>提供的新类别样本数 (K)</strong></td><td>K = 0</td><td>K = 1</td><td>K &gt; 1 (通常很小)</td></tr><tr><td><strong>学习依据</strong></td><td>语义描述、属性、词向量</td><td>1个标注的参考样本</td><td>K个标注的参考样本</td></tr><tr><td><strong>核心能力</strong></td><td>视觉-语义关联与匹配</td><td>特征相似度比较</td><td>更鲁棒的特征相似度比较</td></tr><tr><td><strong>模型权重 (测试阶段)</strong></td><td>冻结</td><td>通常冻结</td><td>通常冻结</td></tr></tbody></table><p>这些技术使得AI模型更加灵活和数据高效，向着仅需少量信息就能学习和泛化的目标迈出了重要一步，对于处理现实世界中类别众多且样本稀疏的场景至关重要。</p>]]></content>
      
      
      <categories>
          
          <category> Research Blogs </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CV </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Notes---苏剑林博客（词向量与Embedding技术）</title>
      <link href="/blogs/2025/08/14/Notes---%E8%8B%8F%E5%89%91%E6%9E%97%E5%8D%9A%E5%AE%A2%EF%BC%88%E8%AF%8D%E5%90%91%E9%87%8F%E4%B8%8EEmbedding%E6%8A%80%E6%9C%AF%EF%BC%89/"/>
      <url>/blogs/2025/08/14/Notes---%E8%8B%8F%E5%89%91%E6%9E%97%E5%8D%9A%E5%AE%A2%EF%BC%88%E8%AF%8D%E5%90%91%E9%87%8F%E4%B8%8EEmbedding%E6%8A%80%E6%9C%AF%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<p>这一篇 Notes 就是关于“<strong>词向量与Embedding技术</strong>”这个分类底下的 Blog，这个是第二个部分。</p><h2 id="词向量与Embedding究竟是怎么回事？">词向量与Embedding究竟是怎么回事？</h2><p>词向量可以说是语言模型最重要的基石之一，正是有了词向量，我们才有了一个比较好的方式来用数字表示语言。从某种意义上讲，语言到词向量的过程，就是把人类语言翻译成机器语言的过程。</p><p>我第一次知道词向量，差不多是 2023 年左右，我大二左右，然后要上物理</p>]]></content>
      
      
      <categories>
          
          <category> Study Blogs </category>
          
      </categories>
      
      
        <tags>
            
            <tag> notes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Notes---苏剑林博客（神经网络与深度学习基础）</title>
      <link href="/blogs/2025/08/11/Notes---%E8%8B%8F%E5%89%91%E6%9E%97%E5%8D%9A%E5%AE%A2%EF%BC%88%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E4%B8%8E%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80%EF%BC%89/"/>
      <url>/blogs/2025/08/11/Notes---%E8%8B%8F%E5%89%91%E6%9E%97%E5%8D%9A%E5%AE%A2%EF%BC%88%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E4%B8%8E%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<p>其实很久之前就看到过别人推荐他的 blog 了，但是一直没看，最近虽然也很忙，但是总是不想干“正事”，就忙里偷闲，看看能不能把他的 blog 读完吧。</p><p>我的 <a href="https://zhuanlan.zhihu.com/p/1935115608074196190">Reading List</a> 主要是根据知乎上一个同学（<a href="https://www.zhihu.com/people/er-ri-35">WhyWait</a>）整理的，所以也就按照他的分类来读了。</p><p>这一篇 Notes 就是关于“<strong>神经网络与深度学习基础</strong>”这个分类底下的 Blog，希望这一次自己能够坚持下来，至少把和自己相关的部分看完。</p><h2 id="闲聊：神经网络与深度学习">闲聊：神经网络与深度学习</h2><p>这篇博客写在 2015 年，但其实里面的很多想法到今天也很有用，从某种程度上从底层解释了神经网络从何而来，为什么能 work。</p><p>大部分人都知道，神经网络其实就是一个拟合函数，虽然网络里的单个节点只是一个非常简单的函数，但是大家也都知道我们已经证明了只要我们把足够多的这种简单函数复合到一起，可以拟合任意一种函数。</p><p>大部分也知道，很多时候神经网络其实干的事情是“抽特征”，如果你特征抽的好，只需要一个非常简单的 MLP 就可以去的很好的效果。</p><p>可其实大部分人都没有系统的知道，上面这两点就是我们的 key point，借用原文内容，就是“<strong>1、函数的自变量是什么？2、这个函数是什么？</strong>”。不管我们现在的 AI 发展到了多么 fancy 的地步，其实我们都是希望给他一个 input，他给我们一个我们想要的 output。那其实模型就是一个函数。既然如此其实我们要解决的问题就是上面这两个问题。</p><p>我的观点就是 DL 直接这两个问题一起解决了。函数的自变量他可以自己学到提取一个很好的特征，函数长什么样他也可以自己去学一个合适函数。最后的问题就是我们需要高质量的数据，这也是很多时候，我们想要训练一个 performance 更好的模型面临的瓶颈。</p><h2 id="浅谈神经网络中激活函数的设计">浅谈神经网络中激活函数的设计</h2><p>激活函数在神经网络里是很重要的，因为它往神经网路里加入非线性，而这个非线性能起到非常神奇的作用，可以说之所以神经网络能有今天的强大效果，很大程度上要归功于非线性的引入，就是最开始有人发现引入非线性之后，神经网络的效果大幅提升了，才有后来的这么多人持续的跟进，造就今天 AI 的局面。</p><p>但是虽然引入非线性的这个激活函数很重要，但是究竟什么样的激活函数效果最好，这很难如评判，我们最开始用 Sigmoid 函数，后来用 ReLu，其实现在大部分也是用 ReLu，因为我们现在基本上会认为换激活函数能起到的效果有限，只要有一定的非线性性就好。再后来有这个 Swish，以及苏神自己提出的激活函数，可能在不同的任务上会有不同的表现，但总的来说，我们不必放太多精力在激活函数上。</p><h2 id="从Boosting学习到神经网络：看山是山？">从Boosting学习到神经网络：看山是山？</h2><p>这里讲了 Boosting 算法，主要是拿 AdaBoost 算法举例子，怎么说呢，我确实是不太了解细节，但是组合模型我大概是知道的，就类似于 model ensemble。</p><p>这篇文章里又强调了一个观点，就是特征的重要性，只要有一个好的特征，就算是非常简单的回归模型，或者我们现在喜欢用 MLP都可以有非常高的精度。</p><p>苏神这里提出的观点是，我们不把模型看成模型，而把模型看成特征提取器。这样的话，我们用多个模型整出来的预测结果，组合起来其实就是一个新的特征，我们可以用这个特征再去训练一个模型，或者最简单，做个投票，来的到最后的结果。</p><p>不过这个到现在的话，其实也是一个比较“显然”的结论了，就像之前我也提到过，大家基本上都会把神经网络看成一个特征提取器，然后最后用一个简单的 FFN/MLP 去得到一个结果。</p>]]></content>
      
      
      <categories>
          
          <category> Study Blogs </category>
          
      </categories>
      
      
        <tags>
            
            <tag> notes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>多模态中的 Single String 与 Two String</title>
      <link href="/blogs/2025/08/05/%E5%A4%9A%E6%A8%A1%E6%80%81%E4%B8%AD%E7%9A%84%20Single%20String%20%E4%B8%8E%20Two%20String/"/>
      <url>/blogs/2025/08/05/%E5%A4%9A%E6%A8%A1%E6%80%81%E4%B8%AD%E7%9A%84%20Single%20String%20%E4%B8%8E%20Two%20String/</url>
      
        <content type="html"><![CDATA[<h3 id="多模态AI如何理解世界？一文读懂单序列与双序列模型">多模态AI如何理解世界？一文读懂单序列与双序列模型</h3><p>多模态人工智能的浪潮正在席卷而来，从能够理解图片和文字的 LLaVA，到能生成视频的 Sora，AI 正在以前所未有的方式将不同类型的信息联系起来。</p><p>那么，这些多模态模型究竟是如何将图像、文本等不同模态的信息融合在一起的呢？</p><p>目前，主流的架构可以归纳为两大阵营：**单序列（Single String）**和双序列（Two String）。理解这两种范式，就能抓住多模态模型的核心。</p><hr><h4 id="1-单序列（Single-String）方法：一次看懂，全局理解">1. 单序列（Single String）方法：一次看懂，全局理解</h4><p><strong>核心思想</strong>：将所有模态的数据都转化为同一种“语言”（Token），然后将它们像串珠子一样拼接成一个长长的序列，交给一个统一的 Transformer 模型进行处理。</p><p>这就像是“<strong>一图胜千言</strong>”。模型将图像视为一长串“视觉词汇”，将它们与文本中的普通词汇放在一起，在同一个注意力空间中进行交互和理解。</p><ul><li><strong>工作流程</strong>：<ol><li><strong>图像编码</strong>：将一张图片分割成许多小块（Patches）。</li><li><strong>特征投影</strong>：使用一个视觉编码器将这些 Patches 转化为一系列图像 Token，并投影到与文本 Token 相同的嵌入空间。</li><li><strong>序列拼接</strong>：将图像 Token 序列与文本 Token 序列拼接起来，通常还会用特殊分隔符（如 <code>[IMG_START]</code>）进行标记。</li><li><strong>统一处理</strong>：将拼接后的长序列一次性输入给一个统一的 Transformer 模型。</li></ol></li><li><strong>优点</strong>：<ul><li><strong>架构简单</strong>：只需一个 Transformer 模型，无需额外的复杂融合层。</li><li><strong>隐式对齐</strong>：模型通过全局自注意力机制，自然地学习图像和文本之间的对齐关系。</li></ul></li><li><strong>缺点</strong>：<ul><li><strong>计算成本高</strong>：自注意力机制的计算复杂度与序列长度的平方成正比。图像 Token 数量多，拼接后序列变得很长，导致计算量巨大。</li></ul></li><li><strong>代表模型</strong>：LLaVA, Flamingo, IDEFICS。</li></ul><hr><h4 id="2-双序列（Two-String）方法：分而治之，最后融合">2. 双序列（Two String）方法：分而治之，最后融合</h4><p><strong>核心思想</strong>：对不同模态的数据使用独立的、专门的编码器进行处理。在处理的后期，再通过一个专门的“融合”模块将不同模态的特征结合起来。</p><p>这就像是“<strong>分开阅读，再独立思考</strong>”。模型先独立地“看”图片，再独立地“读”文本，最后再“思考”如何将两者联系起来。</p><ul><li><strong>工作流程</strong>：<ol><li><strong>文本编码</strong>：使用一个文本编码器（如 BERT）将文本序列编码为文本特征。</li><li><strong>图像编码</strong>：使用一个图像编码器（如 ViT）将图像编码为图像特征。</li><li><strong>专门融合</strong>：将两个编码器输出的特征向量（或序列）送入一个融合层，通过**交叉注意力（Cross-Attention）**或简单的拼接，来学习和融合跨模态的信息。</li></ol></li><li><strong>优点</strong>：<ul><li><strong>计算高效</strong>：每个编码器处理较短的序列，计算成本更低。</li><li><strong>模态特化</strong>：可以为每个模态使用最适合的预训练模型和架构，灵活性高。</li></ul></li><li><strong>缺点</strong>：<ul><li><strong>架构复杂</strong>：需要设计和训练一个有效的融合机制，这比单流模型更具挑战性。</li><li><strong>对齐显式化</strong>：模型必须显式地学习如何对齐两个独立的特征，如果融合层设计不当，会限制性能。</li></ul></li><li><strong>代表模型</strong>：CLIP (经典的双编码器模型), VisualBERT。</li></ul><hr><h4 id="3-对比总结：如何选择？">3. 对比总结：如何选择？</h4><table><thead><tr><th>特性</th><th><strong>单序列（Single String）</strong></th><th><strong>双序列（Two String）</strong></th></tr></thead><tbody><tr><td><strong>核心思想</strong></td><td>统一所有模态为一长串 Token</td><td>分别编码，后期专门融合</td></tr><tr><td><strong>架构</strong></td><td>单个统一的 Transformer 模型</td><td>独立编码器 + 融合模块</td></tr><tr><td><strong>计算成本</strong></td><td>较高（与总序列长度的平方成正比）</td><td>较低（编码器内部并行，融合层成本可控）</td></tr><tr><td><strong>主要优势</strong></td><td>架构简单，对齐自然</td><td>灵活性高，计算更高效</td></tr><tr><td><strong>典型模型</strong></td><td>LLaVA, Flamingo, IDEFICS</td><td>CLIP, VisualBERT</td></tr></tbody></table><p><strong>如何选择？</strong></p><ul><li>如果你追求<strong>极致的性能</strong>，并且希望模型在多模态数据之间建立最细致的、隐式的联系，<strong>单序列模型</strong>可能是更好的选择。</li><li>如果你更看重<strong>计算效率、灵活性</strong>，希望在已有预训练模型上快速构建，或者需要将模型部署到资源受限的设备上，<strong>双序列模型</strong>可能更具优势。</li></ul><p>这两种范式都在不断演进，为我们打开了通往真正多模态AI世界的大门。</p>]]></content>
      
      
      <categories>
          
          <category> Research Blogs </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Multimodal </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>StreamMUSE</title>
      <link href="/blogs/2025/07/14/StreamMUSE/"/>
      <url>/blogs/2025/07/14/StreamMUSE/</url>
      
        <content type="html"><![CDATA[<h2 id="Fake-Offline">Fake Offline</h2><figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">fake_offline</span>():<br>model = load_from_checkpoint(model_path)<br>  <br>  <span class="hljs-comment"># Convert midi file to tensor</span><br>  <span class="hljs-comment"># midi file -&gt; [1, num_logical_ticks, max_polyphony*2]</span><br>  x_mel, x_acc = conter_midi_to_tensor(midi_path)<br>  <br>  <span class="hljs-comment"># fake inference round</span><br>  <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n_round):<br>    <span class="hljs-comment"># get right prompts</span><br>    prompt_length_i = prompt_length + i*gen_interval_ticks<br>  x_mel_pre = get_proper_mel_prompt_length(prompt_length_i)<br>    x_acc_pre = get_proper_acc_prompt_length(prompt_length_i)<br>    x = merge_mel_acc(x_mel_pre, x_acc_pre)<br>    <br>    <span class="hljs-comment"># generate output</span><br>    output = model.forward(x, gen_seq_len)<br>    <br>    <span class="hljs-comment"># seperate the output back to x_mel_pre and x_acc_pre</span><br>    x_mel_pre, x_acc_pre = seperate_output(output)<br>    <br>    <span class="hljs-comment"># if it&#x27;s first round, replace some acc with empty frame</span><br>    <span class="hljs-keyword">if</span> (i = <span class="hljs-number">0</span>):<br>      set_corresponding_frame_empty(x_acc_pre)<br>    <span class="hljs-keyword">else</span>:<br>      tem_start = prompt_length + i*gen_interval_ticks + latency<br>      tem_end = prompt_length + i*gen_interval_ticks + latency + gen_interval_ticks<br>    <br>    <span class="hljs-comment"># 拼接 tem_</span><br>    <br>  decode_output(output)<br></code></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Research Blogs </category>
          
      </categories>
      
      
        <tags>
            
            <tag> NLP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>标准卷积过程</title>
      <link href="/blogs/2025/07/12/%E6%A0%87%E5%87%86%E5%8D%B7%E7%A7%AF%E8%BF%87%E7%A8%8B/"/>
      <url>/blogs/2025/07/12/%E6%A0%87%E5%87%86%E5%8D%B7%E7%A7%AF%E8%BF%87%E7%A8%8B/</url>
      
        <content type="html"><![CDATA[<p>在看 MLSys 相关的东西的时候，经常能看到准对卷积操作做的优化，但是我总是忘卷积操作具体是怎么做的，在这里记一下。</p><h2 id="标准卷积计算过程">标准卷积计算过程</h2><ol><li><strong>输入图片的维度：</strong><ul><li>一张彩色图片通常有三个维度：<code>高度 (H) x 宽度 (W) x 输入通道数 (C_in)</code>。对于 RGB 图片，<code>C_in</code> 通常是 3。</li></ul></li><li><strong>单个卷积核的维度：</strong><ul><li>一个卷积核（或称为滤波器）的完整形状是 <code>核高 (K_H) x 核宽 (K_W) x 输入通道数 (C_in)</code>。</li><li>例如，如果输入图片有 3 个通道（RGB），并且你使用 3×3 的卷积核，那么一个卷积核的实际形状是 3×3×3。它包含了对应每个输入通道的 3×3 切片。</li></ul></li><li><strong>卷积操作的内部过程：</strong><ul><li>当一个卷积核在输入图片的某个局部区域滑动时，它会进行以下操作：<ul><li><strong>逐通道相乘：</strong> 卷积核的每个切片会与输入图片对应通道的局部区域进行逐元素的乘法。</li><li><strong>求和：</strong> 将所有通道上（例如 RGB 三个通道）的逐元素乘法结果<strong>立即相加</strong>，生成一个<strong>单一的数值</strong>。</li></ul></li><li>这个单一的数值就是输出特征图在当前滑动位置的一个像素值。</li></ul></li><li><strong>输出特征图的生成：</strong><ul><li>卷积核会以一定的步长在输入图片上滑动。每滑动到一个新位置，就重复上述的“逐通道相乘并求和”操作，得到一个新的输出像素值。</li><li>所有这些输出像素值组合起来，就形成了<strong>一个二维的输出特征图</strong>。</li></ul></li><li><strong>多个卷积核与输出通道：</strong><ul><li>如果一个卷积层需要生成<strong>多个输出通道 (Output Channels)</strong>，那么它就需要<strong>对应数量的独立的卷积核</strong>。</li><li><strong>有多少个输出通道，就对应有多少个独立的卷积核。</strong></li><li>每个独立的卷积核都会按照上述方式，生成一个二维的输出特征图。</li><li>最后，这些独立的二维输出特征图会沿通道维度<strong>堆叠起来</strong>，形成最终的输出张量，其形状为 <code>输出高 (H') x 输出宽 (W') x 输出通道数 (C_out)</code>。</li></ul></li></ol><h2 id="核心总结">核心总结</h2><ul><li><strong>一个卷积核</strong>处理所有输入通道，并产生<strong>一个输出通道</strong>。</li><li>如果需要<strong>多个输出通道</strong>，就需要<strong>相应数量的独立卷积核</strong>。</li></ul>]]></content>
      
      
      <categories>
          
          <category> Research Blogs </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CV </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Coding Diary(2025-7-8)</title>
      <link href="/blogs/2025/07/08/Coding%20Diary(2025-7-8)/"/>
      <url>/blogs/2025/07/08/Coding%20Diary(2025-7-8)/</url>
      
        <content type="html"><![CDATA[<p>又是好久没写了，训练模型训的确实是非常头痛啊，在这里做一些版本描述，虽然理论上 yaml 里面都是有描述，但是毕竟如果你要一个一个点开看太麻烦了。</p><p><strong>1.0.18</strong>，<strong>1.1.5</strong>，<strong>1.3.9</strong> 这几个都是为了 catch loss jump 训练的。</p>]]></content>
      
      
      <categories>
          
          <category> Coding Blogs </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 日记 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Coding Diary(2025-6-26)</title>
      <link href="/blogs/2025/06/26/Coding%20Diary(2025-6-26)/"/>
      <url>/blogs/2025/06/26/Coding%20Diary(2025-6-26)/</url>
      
        <content type="html"><![CDATA[<p>又是过的飞快的一周，还是有完成一些东西，而且确实学到了一些东西，把一些想起来的遇到问题记一下。</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">FileNotFoundError: [Errno 2] No such file or directory: <span class="hljs-string">&#x27;/tmp/tmpt3exafey&#x27;</span><br></code></pre></td></tr></table></figure><p>这个错误遇到过两次，第一次没在意，觉得可能是什么莫名其妙的故障，当时也查了一下 <code>tmp</code> 文件还有多少空间。</p><p>第二次再遇到的时候幡然醒悟，感觉应该是因为服务器会定期清除 <code>tmp</code> 文件夹里的文件，所以大家如果训练模型可能很久的话记得指定 <code>TMPDIR</code> 环境变量。</p>]]></content>
      
      
      <categories>
          
          <category> Coding Blogs </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 日记 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>rsync 命令总结</title>
      <link href="/blogs/2025/06/26/rsync%20%E5%91%BD%E4%BB%A4%E6%80%BB%E7%BB%93/"/>
      <url>/blogs/2025/06/26/rsync%20%E5%91%BD%E4%BB%A4%E6%80%BB%E7%BB%93/</url>
      
        <content type="html"><![CDATA[<p><code>rsync</code> (remote sync) 是一个用于在本地或远程系统之间高效地同步文件和目录的工具。它的核心优势是使用“增量算法”，只传输源和目标之间有差异的部分，从而大大减少数据传输量。</p><hr><h3 id="1-基本语法"><strong>1. 基本语法</strong></h3><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">rsync [选项] &lt;源路径&gt; &lt;目标路径&gt;<br></code></pre></td></tr></table></figure><ul><li><strong>源路径 (Source):</strong> 您要从中复制文件的地方。</li><li><strong>目标路径 (Destination):</strong> 您要将文件复制到的地方。</li><li>源和目标都可以是本地路径，或者是 <code>user@host:path</code> 格式的远程路径。</li></ul><p><strong>一个非常重要的细节：源目录末尾的斜杠 <code>/</code></strong></p><ul><li><code>rsync ... source/ destination</code>: 表示将 <code>source</code> 目录<strong>里面</strong>的内容复制到 <code>destination</code> 目录中。</li><li><code>rsync ... source destination</code>: 表示将 <code>source</code> 目录<strong>本身</strong>（连同文件夹一起）复制到 <code>destination</code> 目录中，最终路径会是 <code>destination/source/</code>。</li><li><strong>通常，您想要的是第一种行为。</strong></li></ul><hr><h3 id="2-常用选项-Options"><strong>2. 常用选项 (Options)</strong></h3><p>这些选项可以组合使用，例如 <code>-avh</code>。</p><ul><li><p><strong><code>-a, --archive</code> (归档模式)</strong></p><ul><li><p>这是最常用的选项，它是一个复合选项，相当于</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">-rlptgoD<br></code></pre></td></tr></table></figure><p>，包含了以下所有功能：</p><ul><li><code>-r, --recursive</code>: 递归地复制目录。</li><li><code>-l, --links</code>: 保留符号链接。</li><li><code>-p, --perms</code>: 保留文件权限。</li><li><code>-t, --times</code>: 保留文件修改时间。</li><li><code>-g, --group</code>: 保留文件的所属组。</li><li><code>-o, --owner</code>: 保留文件的所有者 (仅在 root 用户下有效)。</li><li><code>-D, --devices --specials</code>: 保留设备文件和特殊文件。</li></ul></li><li><p><strong>简单来说，使用 <code>-a</code> 就能尽可能地让目标文件和源文件一模一样。</strong></p></li></ul></li><li><p><strong><code>-v, --verbose</code> (详细模式)</strong></p><ul><li>显示更详细的输出，告诉您哪些文件正在被传输。</li></ul></li><li><p><strong><code>-h, --human-readable</code> (人类可读格式)</strong></p><ul><li>以 KB, MB, GB 等易于阅读的单位显示文件大小。</li></ul></li><li><p><strong><code>--progress</code> (显示进度)</strong></p><ul><li>为<strong>每一个正在传输的文件</strong>显示详细的进度条、速度和剩余时间。对于传输大文件非常有用。</li></ul></li><li><p><strong><code>-n, --dry-run</code> (演习模式)</strong></p><ul><li><strong>非常重要的安全选项！</strong> 它会模拟整个同步过程，详细列出它<strong>将会</strong>做的所有操作（复制、删除等），但<strong>实际上不会执行任何文件更改</strong>。是在执行一个有风险的命令前进行检查的最佳方法。</li></ul></li><li><p><strong><code>--delete</code> (删除多余文件)</strong></p><ul><li><strong>有风险的强大选项！</strong> 这个选项会将在<strong>源目录</strong>中不存在，但在<strong>目标目录</strong>中存在的文件<strong>删除掉</strong>。这可以用来创建一个与源完全一致的镜像备份。使用前请务必配合 <code>--dry-run</code> 进行测试。</li></ul></li><li><p><strong><code>--exclude='PATTERN'</code> (排除文件)</strong></p><ul><li>排除掉符合某种模式的文件或目录。</li><li><strong>示例：</strong> <code>--exclude='*.log'</code> (排除所有 .log 文件)，<code>--exclude='tmp/'</code> (排除 tmp 文件夹)。</li></ul></li><li><p><strong><code>--include='PATTERN'</code> (包含文件)</strong></p><ul><li>与 <code>--exclude</code> 配合使用，用于更精细地控制包含/排除规则。</li></ul></li><li><p><strong><code>-z, --compress</code> (压缩传输)</strong></p><ul><li>在传输过程中对数据进行压缩，可以减少网络带宽占用。对于文本类文件效果很好，但对于已经压缩过的文件（如 .zip, .jpg）效果不大，反而会消耗更多 CPU。</li></ul></li><li><p><strong><code>-P</code></strong></p><ul><li>这个选项相当于 <code>--partial --progress</code>。<code>--partial</code> 允许 <code>rsync</code> 保留传输中断的文件，以便下次可以断点续传。</li></ul></li></ul><hr><h3 id="3-常见用例"><strong>3. 常见用例</strong></h3><h4 id="本地文件夹同步"><strong>本地文件夹同步</strong></h4><p>将 <code>source_folder</code> 的内容同步到 <code>backup_folder</code>。</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">rsync -avh --progress /path/to/source_folder/ /path/to/backup_folder/<br></code></pre></td></tr></table></figure><h4 id="上传到远程服务器-Push"><strong>上传到远程服务器 (Push)</strong></h4><p>将本地的 <code>my_project</code> 文件夹上传到服务器。</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">rsync -avh --progress ./my_project/ your_username@your_server_ip:~/projects/<br></code></pre></td></tr></table></figure><h4 id="从远程服务器下载-Pull"><strong>从远程服务器下载 (Pull)</strong></h4><p>将服务器上的 <code>remote_logs</code> 文件夹下载到本地。</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">rsync -avh --progress your_username@your_server_ip:~/remote_logs/ ./local_logs/<br></code></pre></td></tr></table></figure><h4 id="创建镜像备份-删除目标端多余文件"><strong>创建镜像备份 (删除目标端多余文件)</strong></h4><p>让本地的 <code>backup</code> 文件夹与源文件夹 <code>source_data</code> 完全保持一致。</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 首先进行演习，检查哪些文件将被删除</span><br>rsync -avhn --progress --delete /path/to/source_data/ /path/to/backup/<br><br><span class="hljs-comment"># 确认无误后，去掉 -n 正式执行</span><br>rsync -avh --progress --delete /path/to/source_data/ /path/to/backup/<br></code></pre></td></tr></table></figure><h4 id="指定-SSH-端口和密钥"><strong>指定 SSH 端口和密钥</strong></h4><p>如果远程服务器使用非标准 SSH 端口或需要特定密钥。</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># -e 选项用于指定远程 shell 命令</span><br><span class="hljs-comment"># 假设端口是 2222，密钥是 my_key.pem</span><br>rsync -avh --progress -e <span class="hljs-string">&#x27;ssh -p 2222 -i /path/to/my_key.pem&#x27;</span> ./source/ user@host:/dest/<br></code></pre></td></tr></table></figure><p><code>rsync</code> 是一个功能极其丰富的工具，掌握好 <code>-avh --progress</code>、<code>--delete</code> 和 <code>--dry-run</code> 这几个核心选项，就能满足绝大多数的文件同步需求。</p>]]></content>
      
      
      <categories>
          
          <category> Tech Blogs </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Tools </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Coding Diary(2025-6-19)</title>
      <link href="/blogs/2025/06/19/Coding%20Diary(2025-6-19)/"/>
      <url>/blogs/2025/06/19/Coding%20Diary(2025-6-19)/</url>
      
        <content type="html"><![CDATA[<p>这一周可以说是过的飞快，真是学到了点东西，模型的训练也开始了。</p><p>系统方面的话，SGLang 还是基本没什么进展，但是对我们现在用的这个 music transformer 的架构是大致了解了。我们 mentor 现在是让我们从算子的结构画一个模型图出来，目前还没倒出空来干。</p><p>模型方面进展挺多的，处理了我们的新的、巨大的 dataset：Aria。现在用的是最简单的分离 melody 和 accompaniment 的方法，之后可能会试一试别的，比如 skyline。在最简单的分离方法得到的数据集上，我们已经训练了两轮模型了，一个没有 <code>interleave_pos</code> 这个参数，另外一个有。这个参数差不多意思就是序列交错，就是一个 acc 和 一个 mel 是交错的，有这个参数就是相当于告诉了模型这个数据训练的时候是交错的。</p><p>之所以这个系统方向进展比较缓慢，就在于我们都得首先熟悉模型，要不然系统也做不了。其次就是训练的时候遇到了一些问题，调了很久训练参数。再就是有一些工具的安装，比如说这个 <code>rclone</code>。</p><p>因为你模型训练好之后，就算这是个小模型，参数也是很大的，你想别的地方地方用你就得传到什么地方，这个 <code>rclone</code> 就是干这个的。我用 <code>scp</code> 可能 1 M/s 都没有，他这个直接 120 M/s。</p><p>再就是 merge 代码费了点时间。</p><p>得抓紧搞模型图了。</p>]]></content>
      
      
      <categories>
          
          <category> Coding Blogs </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 日记 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Nsight System &amp; Nsight Compute</title>
      <link href="/blogs/2025/06/15/Nsight%20System%20&amp;%20Nsight%20Compute/"/>
      <url>/blogs/2025/06/15/Nsight%20System%20&amp;%20Nsight%20Compute/</url>
      
        <content type="html"><![CDATA[<p>有关 Nsight System 和 Nsight Compute 的介绍与常用命令总结。</p><h2 id="Introduction">Introduction</h2><h3 id="核心定位：一个看“森林”，一个看“树木”">核心定位：一个看“森林”，一个看“树木”</h3><p>这是理解这两个工具最核心的一点。</p><ul><li><strong>Nsight Systems (<code>nsys</code>)</strong>: <strong>系统级性能分析器</strong>，负责看“森林”。它监控您的整个应用程序，告诉您CPU和GPU之间是如何交互的，时间都花在了哪些大的模块上（例如：哪个CUDA Kernel耗时最长、数据拷贝花了多久）。</li><li><strong>Nsight Compute (<code>ncu</code>)</strong>: <strong>Kernel级性能分析器</strong>，负责看“树木”。当<code>nsys</code>帮您找到最值得优化的那棵“树”（即耗时最长的Kernel）后，<code>ncu</code>会深入到这棵树的内部，详细分析它的每一个细节（例如：它的计算单元利用率如何？内存访问效率高不高？具体是哪一行代码拖慢了速度？）。</li></ul><p><strong>一个生动的比喻：</strong></p><ul><li><code>nsys</code> 就像<strong>城市交通地图</strong>，它告诉您哪条主干道（Kernel）发生了拥堵。</li><li><code>ncu</code> 就像<strong>汽车引擎诊断仪</strong>，它负责分析堵在路上的那辆车，告诉您它的引擎、油路、电路具体哪里出了问题。</li></ul><hr><h3 id="对比总结表">对比总结表</h3><table><thead><tr><th><strong>方面 (Aspect)</strong></th><th><strong>NVIDIA Nsight Systems</strong></th><th><strong>NVIDIA Nsight Compute</strong></th></tr></thead><tbody><tr><td><strong>命令行工具</strong></td><td><code>nsys</code></td><td><code>ncu</code></td></tr><tr><td><strong>核心定位</strong></td><td><strong>系统级 (System-Level)</strong> 瓶颈分析</td><td><strong>Kernel级 (Kernel-Level)</strong> 细节剖析</td></tr><tr><td><strong>主要回答的问题</strong></td><td>“我的程序瓶颈在哪里？是CPU、GPU还是数据传输？哪个Kernel最耗时？”</td><td>“我的这个特定Kernel为什么慢？是受限于计算还是内存？哪行代码是瓶颈？”</td></tr><tr><td><strong>分析对象</strong></td><td>整个应用程序的生命周期</td><td>单一或多个CUDA Kernel的单次执行</td></tr><tr><td><strong>报告文件后缀</strong></td><td><code>.nsys-rep</code></td><td><code>.ncu-rep</code></td></tr><tr><td><strong>GUI中主要看点</strong></td><td><strong>时间线 (Timeline)</strong>：&lt;br&gt;- CUDA API 调用序列&lt;br&gt;- Kernel启动顺序和耗时&lt;br&gt;- 内存拷贝(Memcpy)时序&lt;br&gt;- CPU/GPU并行情况</td><td><strong>详情页 (Details Page)</strong>：&lt;br&gt;- 性能瓶颈摘要 (Compute/Memory Bound)&lt;br&gt;- 源码与性能数据关联&lt;br&gt;- 内存层级分析 (L1/L2/DRAM)&lt;br&gt;- 调度器和占用率统计</td></tr><tr><td><strong>对程序性能影响</strong></td><td>较小 (主要为追踪开销)</td><td><strong>较大</strong> (通常会多次重放Kernel来收集不同指标)</td></tr></tbody></table><hr><h3 id="标准的性能优化工作流-Workflow">标准的性能优化工作流 (Workflow)</h3><p>一个专业且高效的GPU性能优化流程通常会结合使用这两个工具：</p><ol><li><strong>第一步：全局俯瞰 (使用 <code>nsys</code>)</strong><ul><li>运行 <code>nsys profile ./your_app</code> 来捕获整个应用的性能数据。</li><li>在Nsight Systems GUI中打开报告，查看时间线，<strong>找到耗时占比最高的CUDA Kernel(s)</strong>。</li></ul></li><li><strong>第二步：深入钻研 (使用 <code>ncu</code>)</strong><ul><li>针对第一步中找到的那个（或几个）“热点”Kernel，使用 <code>ncu</code> 进行深入分析。</li><li>运行 <code>ncu -k &lt;hot_kernel_name&gt; -o report_kernel ./your_app</code> 来收集该Kernel的详细数据。</li><li>在Nsight Compute GUI中打开报告，分析其瓶颈是计算密集还是内存密集，并定位到具体的源码行。</li></ul></li><li><strong>第三步：优化迭代</strong><ul><li>根据 <code>ncu</code> 的分析结果，修改您的CUDA代码（例如：优化内存访问模式、提高并行度等）。</li><li>完成修改后，<strong>回到第一步</strong>，再次使用 <code>nsys</code> 分析整个应用，确认您的修改是否带来了整体性能的提升，以及是否出现了新的瓶颈。</li></ul></li></ol><hr><h3 id="一句话总结">一句话总结</h3><ul><li><strong>Nsight Systems (<code>nsys</code>)</strong>: <strong>找方向、看全局</strong>。帮您定位到最值得优化的性能瓶颈点。</li><li><strong>Nsight Compute (<code>ncu</code>)</strong>: <strong>挖细节、做精修</strong>。帮您深入分析瓶颈点的内部原因并指导代码级优化。</li></ul><h2 id="常用命令总结">常用命令总结</h2><h3 id="NVIDIA-Nsight-Systems-nsys-命令总结">NVIDIA Nsight Systems (<code>nsys</code>) 命令总结</h3><p><strong>核心用途</strong>：对整个应用程序进行<strong>系统级</strong>性能分析，找到宏观瓶颈（如耗时最长的CUDA Kernel、CPU与GPU的交互问题等）。</p><p><strong>基础命令结构</strong>：<code>nsys profile [options] &lt;应用程序&gt; [应用程序参数]</code></p><h4 id="常用命令示例">常用命令示例</h4><ol><li><p>基础性能分析</p><p>这是最简单的命令，它会追踪大部分支持的API（CUDA, OpenGL, OS runtime）并生成一份报告。</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">nsys profile ./my_app<br></code></pre></td></tr></table></figure><ul><li><strong>说明</strong>：运行后会在当前目录生成一个名为 <code>report&lt;N&gt;.nsys-rep</code> 的报告文件。</li></ul></li><li><p>指定输出并强制覆盖（推荐用法）</p><p>为报告指定一个有意义的名称，并避免因文件已存在而报错。</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">nsys profile -o my_report --force-overwrite=<span class="hljs-literal">true</span> ./my_app<br></code></pre></td></tr></table></figure><ul><li><code>-o, --output &lt;文件名&gt;</code>：指定输出报告的名称。</li><li><code>--force-overwrite=true</code>：如果报告文件已存在，则自动覆盖。</li></ul></li><li><p>聚焦CUDA和NVTX分析</p><p>如果只关心GPU活动，可以通过 -t 参数减少追踪开销，让报告更清晰。</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">nsys profile -t cuda,nvtx -o my_cuda_report --force-overwrite=<span class="hljs-literal">true</span> ./my_app<br></code></pre></td></tr></table></figure><ul><li><code>-t, --trace &lt;API&gt;</code>：指定要追踪的API集合。<code>cuda</code> 是CUDA运行时和驱动API，<code>nvtx</code> 是NVIDIA工具扩展，允许您在代码中插入自定义的标记范围，非常强大。</li></ul></li><li><p>获取命令行统计摘要</p><p>有时您不想打开GUI，只想快速看一下各个Kernel的耗时统计。</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">nsys profile --stats=<span class="hljs-literal">true</span> ./my_app<br></code></pre></td></tr></table></figure><ul><li><code>--stats=true</code>：运行结束后，在命令行终端直接打印出一份性能统计摘要表格，包括CUDA Kernel耗时排序、API调用统计等。</li></ul></li><li><p>环境检查</p><p>用于验证 nsys 能否正确识别您的GPU、驱动和系统环境（我们之前用过的）。</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">nsys status --environment<br></code></pre></td></tr></table></figure></li></ol><h3 id="NVIDIA-Nsight-Compute-ncu-命令总结">NVIDIA Nsight Compute (<code>ncu</code>) 命令总结</h3><p><strong>核心用途</strong>：对<strong>单个CUDA Kernel</strong>进行深入、细致的性能剖析，找出微观瓶颈（如内存访问、计算单元效率等）。</p><p><strong>基础命令结构</strong>：<code>ncu [options] &lt;应用程序&gt; [应用程序参数]</code></p><h4 id="常用命令示例（推荐按工作流顺序使用）">常用命令示例（推荐按工作流顺序使用）</h4><ol><li><p>第一步：列出所有可分析的Kernel</p><p>在分析之前，先查看您的应用程序中包含哪些可以被 ncu 分析的Kernel。</p><p>Bash</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">ncu --list-kernels ./my_app<br></code></pre></td></tr></table></figure><ul><li><strong>说明</strong>：这将打印一个Kernel列表，方便您复制其确切名称用于下一步。</li></ul></li><li><p>第二步：分析指定的单个Kernel（最核心用法）</p><p>这是 ncu 最推荐的使用方式，精确、高效。</p><p>Bash</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">ncu -k &lt;Kernel的部分或完整名称&gt; -o my_kernel_report --force-overwrite=true ./my_app<br></code></pre></td></tr></table></figure><ul><li><code>-k, --kernel-name &lt;正则表达式&gt;</code>：指定要分析的Kernel名称，支持正则表达式匹配。</li><li><code>-o, --output &lt;文件名&gt;</code>：指定输出报告的名称，后缀为 <code>.ncu-rep</code>。</li></ul></li><li><p>分析一个Kernel的特定启动次数</p><p>如果一个Kernel被循环调用上千次，您可能只想分析其中某几次。</p><p>Bash</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">ncu -k my_kernel_name -c 10 -o my_kernel_report ./my_app<br></code></pre></td></tr></table></figure><ul><li><code>-c, --launch-count &lt;次数&gt;</code>：指定分析该Kernel的前10次启动。</li></ul></li><li><p>收集指定的性能指标集合（提高效率）</p><p>ncu 收集所有指标非常耗时。您可以只收集您关心的“指标集(Section)”。</p><p>Bash</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext"># 示例：只收集内存和调度器相关的指标<br>ncu --section MemoryWorkloadAnalysis --section SchedulerStats -k my_kernel_name -o my_kernel_report ./my_app<br></code></pre></td></tr></table></figure><ul><li><code>--section &lt;节名称&gt;</code>：指定要收集的数据集。您可以通过 <code>ncu --list-sections</code> 查看所有可用的节。</li></ul></li><li><p>分析整个应用（非常耗时，慎用）</p><p>不加任何过滤，分析程序中启动的所有Kernel。</p><p>Bash</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">ncu --set full -o full_app_report --force-overwrite=true ./my_app<br></code></pre></td></tr></table></figure><ul><li><code>--set full</code>：收集所有可用指标集，这会导致程序被极大地拖慢，因为每个Kernel都可能被重放（Replay）很多次。</li></ul></li></ol>]]></content>
      
      
      <categories>
          
          <category> Tech Blogs </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Tools </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Coding Diary(2025-6-12)</title>
      <link href="/blogs/2025/06/12/Coding%20Diary(2025-6-12)/"/>
      <url>/blogs/2025/06/12/Coding%20Diary(2025-6-12)/</url>
      
        <content type="html"><![CDATA[<h3 id="Issue-1-pip-install-module-not-found">Issue 1: pip install/module not found</h3><p>Basically, I am trying to set up the <a href="https://github.com/xinyueli2896/StreamMUSE">music transformer model</a>.</p><p>When we run</p><p><code>pip install -r requirements.txt</code></p><p>We encounter the error</p><img src="./Coding Diary(2025-6-12)/CleanShot 2025-06-12 at 18.20.50@2x.png" alt="CleanShot 2025-06-12 at 18.20.50@2x" style="zoom:33%;" /><p>But we just ignore.</p><p>Then, when we run this command</p><p><code>python extract_mid.py</code></p><p>We encountered this error</p><img src="./Coding Diary(2025-6-12)/CleanShot 2025-06-12 at 18.23.35@2x.png" alt="CleanShot 2025-06-12 at 18.23.35@2x" style="zoom:33%;" /><p>And if you try to solve it with <code>pip install mido</code>, you may not solve it.</p><p>This is because the pip you are using is not the pip in your virtual environment. Actually, if you use <code>venv</code>, you don’t have <code>pip</code>, instead, you have <code>pip3</code>.</p><p>So, I would recommend you redo all your <code>pip</code> commands above with <code>pip3</code>, since in this way, your package will be in your virtual environment.</p><p>Also, to ensure you are using the correct command, use <code>which pip/pip3</code> to check if you are using the right one.</p><h3 id="Issue-2-Where-to-put-POP909-Dataset">Issue 2: Where to put <code>POP909-Dataset</code></h3><p>You just put it anywhere you want, since we do not use it in the inference test.</p><h3 id="Issue-3-How-to-download-the-ckpt-file-from-the-Google-Drive">Issue 3: How to download the ckpt file from the Google Drive</h3><ol><li><strong>install tools</strong> (in the Python virtual environment):</li></ol><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">pip install gdown<br></code></pre></td></tr></table></figure><ol start="2"><li><strong>use <code>gdown</code> and <code>--id</code> symbol to download the file</strong>:</li></ol><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs Bash">gdown --<span class="hljs-built_in">id</span> 1mX4I8EsyKN5xjYqfDHhBS6ukGDN7kosY<br></code></pre></td></tr></table></figure><p>The id here is what <code>https://drive.google.com/file/d/....../view</code> the <code>......</code> represents for.</p><p>Like in our case, the link is <code>https://drive.google.com/file/d/1mX4I8EsyKN5xjYqfDHhBS6ukGDN7kosY/view,</code> the id is <code>1mX4I8EsyKN5xjYqfDHhBS6ukGDN7kosY</code>.</p><p><strong>Important note</strong>: the new link points to the Hugging Face instead of Google Drive, so this is not an issue for the project now. Still, in the future, you may need to download a file from Google Drive, so I just keep it here.</p><h3 id="Issue-4-No-module-named-‘preprocess-large-midi-dataset-private’">Issue 4: No module named ‘preprocess_large_midi_dataset_private’</h3><p>You can find <code>preprocess_large_midi_dataset.py</code> but you cannot find <code>preprocess_large_midi_dataset_private.py</code>.</p><p>If you go into the <code>.gitignore</code>, you’ll find out that <code>preprocess_large_midi_dataset_private.py</code> is actually in the <code>.gitignore</code>.</p><p>What I do is copy the <code>preprocess_large_midi_dataset.py</code> and name it as <code>preprocess_large_midi_dataset_private.py</code>. Also, you can change the code.</p><h3 id="Issue-5-How-to-download-a-file-from-Hugging-Face">Issue 5: How to download a file from Hugging Face</h3><p>Juanshu fixed the original Issue 5, now the link to the real ckpt file. So now, the issue has changed to how to download a file from Hugging Face to the Linux server directly.</p><ol><li>Log in to your Hugging Face account from your terminal.</li><li>Click “Copy download link”</li><li>Directly using the <code>wget</code> command</li></ol><h3 id="Issue-6-No-such-file-or-directory-‘-home-coder-laopo-StreamMUSE-input-mel’">Issue 6: No such file or directory: ‘/home/coder/laopo/StreamMUSE/input/mel’</h3><p>Very simple, you just change the pyth to your directory:</p><img src="./Coding Diary(2025-6-12)/CleanShot 2025-06-12 at 21.52.16@2x.png" alt="CleanShot 2025-06-12 at 21.52.16@2x" style="zoom:33%;" /><p>The code is in <code>m2a_transformer_inference.py</code></p><h3 id="Inference-Output">Inference Output</h3><p>It should be like this if everything is correct:</p><img src="./Coding Diary(2025-6-12)/CleanShot 2025-06-12 at 22.03.18@2x.png" alt="CleanShot 2025-06-12 at 22.03.18@2x" style="zoom:33%;" /><p>And you should see:</p><img src="./Coding Diary(2025-6-12)/CleanShot 2025-06-12 at 22.04.37@2x.png" alt="CleanShot 2025-06-12 at 22.04.37@2x" style="zoom:33%;" />]]></content>
      
      
      <categories>
          
          <category> Coding Blogs </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 日记 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>常用命令总结</title>
      <link href="/blogs/2025/06/12/%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%E6%80%BB%E7%BB%93/"/>
      <url>/blogs/2025/06/12/%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%E6%80%BB%E7%BB%93/</url>
      
        <content type="html"><![CDATA[<p>我的常用命令总结</p><h2 id="Linux">Linux</h2><h3 id="查找带某个关键字的进程"><strong>查找带某个关键字的进程</strong></h3><h4 id="方法一">方法一</h4><p><code>ps aux | grep -i code</code></p><p><strong>命令解释:</strong></p><ul><li><code>ps aux</code>: 列出系统上所有用户 (<code>a</code>) 正在运行的进程的详细信息 (<code>u</code>)，包括那些没有终端的进程 (<code>x</code>)。</li><li><code>|</code>: 这是管道符，将前一个命令的输出作为后一个命令的输入。</li><li><code>grep -i code</code>: 从输入中查找所有包含 “code” 的行，<code>-i</code> 表示不区分大小写（这样能同时匹配到 <code>code</code> 和 <code>Code</code>）。</li></ul><h4 id="方法二">方法二</h4><p><code>pgrep -afl code</code></p><p><strong>命令解释:</strong></p><ul><li><code>pgrep</code>: “process grep”，专门用于查找进程。</li><li><code>-a</code>: 显示完整的命令行。</li><li><code>-f</code>: 在整个命令行中搜索模式（而不仅仅是进程名）。</li><li><code>-l</code>: 显示进程名和PID。</li></ul><h3 id="kill-进程"><strong>kill 进程</strong></h3><p><code>pkill</code> 命令可以直接根据进程的名称或其他属性来杀死进程，比手动查找 PID 更方便。</p><ol><li><p><strong>直接根据名称或关键词杀死进程：</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">pkill -f <span class="hljs-string">&quot;程序相关的关键词&quot;</span><br></code></pre></td></tr></table></figure><ul><li><p><code>-f</code>: 这个选项非常有用，它会匹配<strong>完整的命令行</strong>，而不仅仅是进程名。</p></li><li><p>示例：</p><p>杀死所有包含 <code>my_script.py</code>的进程。</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">pkill -f my_script.py<br></code></pre></td></tr></table></figure></li><li><p>安全建议：</p><p>在执行 <code>pkill</code> 之前，最好先用 <code>pgrep</code> (或 <code>pkill -l</code>) 命令来预览将要被匹配到的进程，确保没有误伤。</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">pgrep -l -f my_script.py<br><span class="hljs-comment"># 或者</span><br>pkill -l -f my_script.py<br></code></pre></td></tr></table></figure></li></ul></li><li><p><strong>强制杀死：</strong> <code>pkill</code> 同样支持 <code>-9</code> 选项来强制杀死进程。</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">pkill -9 -f <span class="hljs-string">&quot;程序相关的关键词&quot;</span><br></code></pre></td></tr></table></figure></li></ol><h3 id="分配-workstation"><strong>分配 workstation</strong></h3><p><code>salloc -N1 -n12 --mem=24G</code></p><h3 id="下载文件的工具：gdown"><strong>下载文件的工具：<code>gdown</code></strong></h3><ul><li><p><strong>这是什么：</strong> 这是一款专门用来从 Google Drive <strong>下载</strong>单个文件或整个文件夹的 Python 工具。</p></li><li><p><strong>为什么用它：</strong> 它的优点是<strong>极其简单</strong>。您只需要提供 Google Drive 文件的分享链接或文件ID，它就能自动处理下载，包括绕过大文件下载时出现的“病毒扫描”确认页面。</p></li><li><p>安装命令：</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">pip install gdown<br></code></pre></td></tr></table></figure></li><li><p>使用命令：</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 使用文件ID下载</span><br>gdown --<span class="hljs-built_in">id</span> &lt;文件ID&gt;<br><span class="hljs-comment"># 或者下载整个文件夹</span><br>gdown <span class="hljs-string">&#x27;&lt;文件夹的分享链接&gt;&#x27;</span><br></code></pre></td></tr></table></figure></li></ul><h3 id="上传文件的工具：rclone"><strong>上传文件的工具：<code>rclone</code></strong></h3><ul><li><strong>这是什么：</strong> 这是一个功能非常强大的<strong>云存储管理工具</strong>。我们用它来实现从您的服务器<strong>上传</strong>文件到 Google Drive，以绕过您本地较慢的网络。</li><li><strong>为什么用它：</strong> 它不仅能上传，还能下载、同步、列出文件等，功能非常全面。对于大文件上传，它非常可靠，支持断点续传和进度显示。</li></ul><h4 id="使用命令">使用命令</h4><ol><li><p>(上传文件)</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 再次运行这个命令，它只会上传新文件和被修改过的文件</span><br>rclone copy /path/to/your/folder gdrive:YourDestinationFolder/ --progress<br></code></pre></td></tr></table></figure></li><li><p>列出您在配置文件中设置的所有远程连接的名称</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">rclone listremotes<br></code></pre></td></tr></table></figure></li></ol><h3 id="Linux-screen-命令核心用法总结"><strong>Linux <code>screen</code> 命令核心用法总结</strong></h3><p><code>screen</code> 是一个终端复用器，它允许您在一个 SSH 连接中创建多个虚拟终端窗口，并且在您断开连接后，这些窗口以及在其中运行的程序会持续在后台运行。</p><h4 id="1-创建会话-Creating-a-Session">1. 创建会话 (Creating a Session)</h4><ul><li><p>创建一个新的、未命名的会话：</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">screen<br></code></pre></td></tr></table></figure></li><li><p>创建一个新的、并给它起一个有意义的名字 (推荐！)：</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">screen -S &lt;session_name&gt;<br></code></pre></td></tr></table></figure><p><strong>示例：</strong> <code>screen -S training_job</code></p></li></ul><h4 id="2-脱离与连接会话-Detaching-Connecting">2. 脱离与连接会话 (Detaching &amp; Connecting)</h4><p>这是 <code>screen</code> 最核心的功能。</p><ul><li><p>从当前会话中脱离 (让它在后台运行)： 在 <code>screen</code> 会话内部，按下组合键 <strong><code>Ctrl + A</code></strong>，然后松开，再按下 <strong><code>D</code></strong> 键。(D for Detach)</p></li><li><p>列出所有正在运行的会话：</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">screen -<span class="hljs-built_in">ls</span><br><span class="hljs-comment"># 或者</span><br>screen -list<br></code></pre></td></tr></table></figure><p>输出会显示会话的 PID 和名称，以及它的状态（<code>Attached</code> 或 <code>Detached</code>）。</p></li><li><p>重新连接到一个已脱离 (Detached) 的会话：</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">screen -r &lt;session_name_or_pid&gt;<br></code></pre></td></tr></table></figure><p><strong>示例：</strong> <code>screen -r training_job</code> 或 <code>screen -r 12345</code></p></li><li><p>强制脱离一个已附着 (Attached) 的会话并连接：</p><p>当您发现一个会话显示为 <code>(Attached)</code> 但您找不到那个终端时，使用这个命令。</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">screen -d -r &lt;session_name_or_pid&gt;<br></code></pre></td></tr></table></figure></li></ul><h4 id="3-关闭-终止会话-Closing-Terminating-a-Session">3. 关闭/终止会话 (Closing/Terminating a Session)</h4><p>“关闭”和“删除”会话在 <code>screen</code> 的语境下通常指的是终止这个会话及其中的所有进程。</p><ul><li><p>方法一：从会话内部关闭</p><ol><li>首先用 <code>screen -r</code> 连接到您想关闭的会话中。</li><li>在会话的 Shell 提示符下，输入 <code>exit</code> 命令并按回车。</li><li>如果您在这个会话中创建了多个窗口（使用 <code>Ctrl+A, c</code>），您需要<strong>在每一个窗口中都输入 <code>exit</code></strong>。当最后一个窗口关闭时，整个 <code>screen</code> 会话就会自动终止。</li></ol></li><li><p>方法二：从会话外部“杀死” (推荐用于快速关闭) 这个方法不需要先连接进去。</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">screen -S &lt;session_name_or_pid&gt; -X quit<br></code></pre></td></tr></table></figure><ul><li><code>-X quit</code> 会向指定的 <code>screen</code> 会话发送一个“退出”指令，让它和它里面的所有程序优雅地关闭。</li></ul></li><li><p>方法三：使用 <code>kill</code> 命令 (强制删除) 如果 <code>screen</code> 会话卡死，无法响应 <code>quit</code> 指令，您可以使用 Linux 的 <code>kill</code> 命令来强制终止进程。</p><ol><li><p>用 <code>screen -ls</code> 找到会话的进程ID (PID)。</p></li><li><p>运行 <code>kill</code>命令：</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 尝试正常终止</span><br><span class="hljs-built_in">kill</span> &lt;PID&gt;<br><br><span class="hljs-comment"># 如果不行，就用最强硬的方式</span><br><span class="hljs-built_in">kill</span> -9 &lt;PID&gt;<br></code></pre></td></tr></table></figure></li></ol></li></ul><h4 id="4-清理无效的会话记录"><strong>4. 清理无效的会话记录</strong></h4><p>有时，即使您用 <code>kill</code> 命令杀死了进程，<code>screen -ls</code> 列表里可能还会残留一个 <code>(Dead ???)</code> 的条目。用这个命令来清理：</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">screen -wipe<br></code></pre></td></tr></table></figure><h3 id="Hugging-Face-CLI-上传文件">Hugging Face CLI 上传文件</h3><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">huggingface-cli upload-large-folder --repo-type=model S-tanley/M2A .<br></code></pre></td></tr></table></figure><h2 id="Mac">Mac</h2>]]></content>
      
      
      <categories>
          
          <category> Tech Blogs </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Tools </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Resource I Have for MLSys</title>
      <link href="/blogs/2025/06/10/Resource%20I%20have%20for%20MLSys/"/>
      <url>/blogs/2025/06/10/Resource%20I%20have%20for%20MLSys/</url>
      
        <content type="html"><![CDATA[<p>This is like a guidance page for the resources I know for MLSys, I’ll give a brief introduction to each of them and list the link here. The resources will contain books, papers, and notes I wrote.</p><h2 id="Books">Books</h2><h3 id="AI-System">AI System</h3><p>This book is more about the hardware. I think it’s a little bit like for ECE students. I haven’t read it all yet, but I think you can find some useful topics here, such as the introduction to Nvidia GPUs, the Tensor Core, stream multiprocessors, and how the GPU actually do to accelerates the computations. It’s an intro-level course, so you don’t need to have any background. However, since it involves lots of history, which seems not that useful. I think you can just go to the specific chapter to find out what you want instead of reading it from the beginning to the end.</p><p>Another reason I recommend this book it’s that it’s open source, and you can contribute to it. I actually am one of the top 10 contributors. It’s also a really good project for you to actually practice your git skills in a real-world work environment.</p><p>The book is not sophisticated now, so you may see some errors in the web version. The way I read it is to git clone it to your local, and use the VSCode preview to read the .md files.</p><p>Here is the link: <a href="https://github.com/chenzomi12/aisystem">https://github.com/chenzomi12/aisystem</a></p><h3 id="AI-Infrastructure">AI Infrastructure</h3><p>This is another book from the same author, and the content of this book, I think, is what we system guys really do. It’s less about the hardware and focuses more on the distributed training/inference systems.</p><p>Here is the link: <a href="https://github.com/chenzomi12/AIInfra">https://github.com/chenzomi12/AIInfra</a></p><h2 id="Papers">Papers</h2><p>I think my notes for the papers will be <a href="https://s-tanley.github.io/blogs/categories/Reading-Paper/">here</a>, but the blog site it’s like I created recently, so some of my previous notes aren’t in it. Still, I list the corresponding link below. If you see something interesting and it happens to have a link to my notes, you can have a look.</p><h3 id="Inference-System">Inference System</h3><h4 id="Orca">Orca</h4><p>This is the paper that Prof. Ma gave us. I think no one uses it anymore, but you can learn some basic concepts here. Also, it’s one of the base models the vLLM used to compare with</p><p>The paper: <a href="https://www.usenix.org/system/files/osdi22-yu.pdf">https://www.usenix.org/system/files/osdi22-yu.pdf</a></p><p>My notes: <a href="https://s-tanley.github.io/blogs/2025/05/15/Orca/">https://s-tanley.github.io/blogs/2025/05/15/Orca/</a></p><h4 id="vLLM">vLLM</h4><p>It’s one of the most popular inference serving systems nowadays, the core idea is the PagedAttention.</p><p>The paper: <a href="https://arxiv.org/abs/2309.06180">https://arxiv.org/abs/2309.06180</a></p><p>My notes: <a href="https://s-tanley.github.io/blogs/2025/05/27/vLLM/">https://s-tanley.github.io/blogs/2025/05/27/vLLM/</a></p><h4 id="SGLang">SGLang</h4><p>It’s the other one most popular inference serving system, and I think most of people use SGLang instead of vLLM now.</p><p>The paper: <a href="https://arxiv.org/abs/2312.07104">https://arxiv.org/abs/2312.07104</a></p><h3 id="Music">Music</h3><h4 id="ReaLchords">ReaLchords</h4><p>The paper: <a href="https://openreview.net/pdf?id=mUVydzrkgz">https://openreview.net/pdf?id=mUVydzrkgz</a></p><h4 id="Pop-Music-Transformer-REMI">Pop Music Transformer(REMI)</h4><p>The paper: <a href="https://arxiv.org/abs/2002.00212">https://arxiv.org/abs/2002.00212</a></p><h4 id="Structured-Multi-Track-Accompaniment-Arrangement">Structured Multi-Track Accompaniment Arrangement</h4><p>The paper: <a href="https://arxiv.org/abs/2310.16334">https://arxiv.org/abs/2310.16334</a></p><h3 id="MoE">MoE</h3><p>For now, these are papers recommended by another professor.</p><p>You can also see my notes <a href="https://github.com/S-tanley/MLsys-Paper-Notes">here</a>. I have also written a <a href="https://github.com/S-tanley/MLsys-Paper-Notes/blob/main/2025.1.13-2025.1.20/WeeklyReport.pdf">report</a>, and I think it’s kind of concise.</p><h4 id="MoE-Infinity">MoE-Infinity</h4><p>The paper: <a href="http://arxiv.org/abs/2401.14361">http://arxiv.org/abs/2401.14361</a></p><h4 id="ProMoE">ProMoE</h4><p>The paper: <a href="https://doi.org/10.48550/arXiv.2410.22134">https://doi.org/10.48550/arXiv.2410.22134</a></p><h4 id="TS-MoE">TS-MoE</h4><p>The paper: <a href="https://doi.org/10.48550/arXiv.2206.00277">https://doi.org/10.48550/arXiv.2206.00277</a></p><h4 id="DeepSpeed-FastGen">DeepSpeed-FastGen</h4><p>The paper: <a href="https://doi.org/10.48550/arXiv.2401.08671">https://doi.org/10.48550/arXiv.2401.08671</a></p><h4 id="DeepUM">DeepUM</h4><p>The paper: <a href="https://doi.org/10.1145/3575693.3575736">https://doi.org/10.1145/3575693.3575736</a></p><h4 id="GShard">GShard</h4><p>The paper: <a href="https://doi.org/10.48550/arXiv.2006.16668">https://doi.org/10.48550/arXiv.2006.16668</a></p><h4 id="MC-SMoE">MC-SMoE</h4><p>The paper: <a href="https://doi.org/10.48550/arXiv.2310.01334">https://doi.org/10.48550/arXiv.2310.01334</a></p><h3 id="Mu-Li’s-recommendation">Mu Li’s recommendation</h3><p>Mu Li is a really great researcher, and he has published lots of useful resources online, which you can access through <a href="https://space.bilibili.com/1567748478">Bilibili</a> or YouTube.</p><p>The <a href="https://space.bilibili.com/1567748478/lists/32744?type=season">collection</a> of the reading paper is really useful, it’s like my 101 course for researching.</p><p>He also has a GitHub <a href="https://github.com/mli/paper-reading">repo</a> for this list.</p><p>I also casually take some notes when I watch the video, but it’s like most of them are really bad, I mean, I think even I won’t read them again. Anyway, I also created a <a href="https://github.com/S-tanley/Notes-for-Mu-Li-s-recommendation">repo</a> for my notes, and in case you are interested.</p>]]></content>
      
      
      <categories>
          
          <category> Research Blogs </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MLSys </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Reading Notes for SGLang</title>
      <link href="/blogs/2025/05/27/SGLang/"/>
      <url>/blogs/2025/05/27/SGLang/</url>
      
        <content type="html"><![CDATA[]]></content>
      
      
      <categories>
          
          <category> Reading Paper </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MLSys </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Reading Notes for vLLM</title>
      <link href="/blogs/2025/05/27/vLLM/"/>
      <url>/blogs/2025/05/27/vLLM/</url>
      
        <content type="html"><![CDATA[<p>This is the reading note for the <em>Efficient Memory Management for Large Language Model Serving with PagedAttention</em>. vLLM is one of the most popular open-source inference serving systems nowadays. Basically, there are two mainstream inference serving systems: one is vLLM, and the other is SGLang.</p><h1>Summary</h1><h2 id="Abstract-Introduction-Background">Abstract &amp; Introduction &amp; Background</h2><p>This is a paper about the vLLM, a serving system for inference. The most important idea they propose is PagedAttention. vLLM with the PagedAttention &quot; achieves (1) near-zero waste in KV cache memory and (2) flexible sharing of KV cache within and across requests to further reduce memory usage.&quot;</p><img src="./vLLM/CleanShot 2025-06-08 at 17.54.40@2x.png" alt="CleanShot 2025-06-08 at 17.54.40@2x" style="zoom:37%;" /><p>In inference, we use a lot of memory to store keys and values since we’ll repeatedly use them in our iterations.</p><p>However, the previous algorithms waste a lot of memory.</p><img src="./vLLM/CleanShot 2025-06-08 at 17.59.20@2x.png" alt="CleanShot 2025-06-08 at 17.59.20@2x" style="zoom:33%;" /><p>Authors use PagedAttention to solve these limitations.</p><p>The background does not have too much to summarize, just a summary of the transformer model and the limitation of the current memory management strategy.</p><img src="./vLLM/CleanShot 2025-06-08 at 18.19.35@2x.png" alt="CleanShot 2025-06-08 at 18.19.35@2x" style="zoom:33%;" /><p>Figure 3 clearly shows why the reservation and the fragmentation waste too much memory.</p><h2 id="Method">Method</h2><p>The main idea of the PagedAttention is just like the virtual memory of the current OS.</p><img src="./vLLM/CleanShot 2025-06-08 at 20.17.37@2x.png" alt="CleanShot 2025-06-08 at 20.17.37@2x" style="zoom:33%;" /><p>For every query, the query just thinks the corresponding K/V is contiguous, and actually, we maintain a sheet to record the actual location of each fragment of the K/V.</p><img src="./vLLM/CleanShot 2025-06-08 at 20.21.32@2x.png" alt="CleanShot 2025-06-08 at 20.21.32@2x" style="zoom:33%;" /><p>Figure 5 shows how the K/V can be managed.</p><img src="./vLLM/CleanShot 2025-06-08 at 20.23.05@2x.png" alt="CleanShot 2025-06-08 at 20.23.05@2x" style="zoom:33%;" /><img src="./vLLM/CleanShot 2025-06-08 at 20.23.39@2x.png" alt="CleanShot 2025-06-08 at 20.23.39@2x" style="zoom:33%;" /><img src="./vLLM/CleanShot 2025-06-08 at 20.25.31@2x.png" alt="CleanShot 2025-06-08 at 20.25.31@2x" style="zoom:33%;" /><p>Figure 6, 7, 8, 9, and 10 tell us some details of PagedAttention. I think these figures are clear enough.</p><p>Also, a key challenge in serving Large Language Models is that as the outputs grow with each iteration, the system can run out of GPU’s physical blocks to store the newly generated KV cache. To address this, vLLM considers two main techniques to recover the KV cache for preempted requests:</p><ul><li>Swapping</li><li>Recomputation</li></ul><p>In the end, they talk a little about the distributed training.</p><h2 id="Implementation-Evaluation-Ablation-Studies">Implementation &amp; Evaluation &amp; Ablation Studies</h2><p>For the implementation, I think there are three techniques we should pay attention to:</p><ul><li>Fused reshape and block write</li><li>Fusing block read and attention</li><li>Fused block copy</li></ul><p>They also mention that they create many methods that should be enough for future development.</p><p>The evaluation part do not have too much to talk about, I just put their figure here:</p><img src="./vLLM/CleanShot 2025-06-11 at 10.25.51@2x.png" alt="CleanShot 2025-06-11 at 10.25.51@2x" style="zoom:33%;" /><img src="./vLLM/CleanShot 2025-06-11 at 10.26.42@2x.png" alt="CleanShot 2025-06-11 at 10.26.42@2x" style="zoom:33%;" /><img src="./vLLM/CleanShot 2025-06-11 at 10.27.02@2x.png" alt="CleanShot 2025-06-11 at 10.27.02@2x" style="zoom:33%;" /><img src="./vLLM/CleanShot 2025-06-11 at 10.27.25@2x.png" alt="CleanShot 2025-06-11 at 10.27.25@2x" style="zoom:33%;" /><img src="./vLLM/CleanShot 2025-06-11 at 10.27.49@2x.png" alt="CleanShot 2025-06-11 at 10.27.49@2x" style="zoom:33%;" /><img src="./vLLM/CleanShot 2025-06-11 at 10.28.06@2x.png" alt="CleanShot 2025-06-11 at 10.28.06@2x" style="zoom:33%;" /><p>Basically, what they do is just elaborate the figrues.</p><p>In the ablation study, they found that</p><ul><li><p>the kernal latency of PagedAttention is a little high but vLLM still way better in the end-to-end performance.</p></li><li><p>the best block size is typically 16.</p></li><li><p>the recompution and swapping is basically same when block size is from 16 to 64.</p></li></ul><h2 id="Discussion-Related-Work-Conclusion">Discussion &amp; Related Work &amp; Conclusion</h2><p>These part I think is already very concise, and also intersting, so I’ll not do the summaries.</p><h1>Thoughts</h1><p>In this paper, the author mentioned something called “cellular batching”. I searched a little, and it’s actually kind of similar to the Ideas(Thoughts &gt; Ideas) I wrote in the <a href="https://s-tanley.github.io/blogs/2025/05/15/Orca/">blog for Orca</a>.</p><h3 id="About-the-Swapping-and-Recomputation">About the Swapping and Recomputation</h3><ul><li><p>Swapping: This is just using the CPU memory, which is very common technique in current OS.</p></li><li><p>Recomputation: This is just throwing away all the K and V, only keeping the sequences we have already generated. We need to know that the recomputation is faster than the normal generation, since we only need one iteration to catch up. This is also very common in the current LLM training system. During the training process, we’ll get some intermediate computation results in the forward step, and these results are useful when we do the backward propagation. However, sometimes the GPU memory is not enough, so we’ll just throw away these results, and when we need them, we recompute them.</p><p>Basically, this is a way to use time for space. Actually, system work is all about suitable tradeoffs.</p></li></ul><h3 id="About-the-Disscussion-of-the-Paging-Technique">About the Disscussion of the Paging Technique</h3><p>This is actually interesing. The PagedAttention only work for the transformer architecture, this is obvious, since if you are not transformer, you even don’t have the attention. However, it’s actually more than that, the PagedAttenion is actually only very useful for LLM, the KV cache for LLM is dynamic. If we got some ViT, I think every output size is fixed, so the KV cache should be predictable.</p><p>Still, as long as the output sequence is flexible, unpredictable. The vLLM should work well.</p><p>Also, I think vLLM is kind of like using space for time. It’s like we make for room for KV cache, the result what we see is it’s faster, since it can batch more requests at one time.</p><h2 id="Confusion">Confusion</h2><p>No confusion in this paper😂.</p><h2 id="Ideas">Ideas</h2><h3 id="About-copy-on-write-mechanism">About <em>copy-on write</em> mechanism</h3><p>I just thought what if we just abandon the rest, and start two new blocks. I think we can calculate some probabilities about this idea.</p>]]></content>
      
      
      <categories>
          
          <category> Reading Paper </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MLSys </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux 系统硬件信息检查命令总结</title>
      <link href="/blogs/2025/05/22/Linux%20%E7%B3%BB%E7%BB%9F%E7%A1%AC%E4%BB%B6%E4%BF%A1%E6%81%AF%E6%A3%80%E6%9F%A5%E5%91%BD%E4%BB%A4%E6%80%BB%E7%BB%93/"/>
      <url>/blogs/2025/05/22/Linux%20%E7%B3%BB%E7%BB%9F%E7%A1%AC%E4%BB%B6%E4%BF%A1%E6%81%AF%E6%A3%80%E6%9F%A5%E5%91%BD%E4%BB%A4%E6%80%BB%E7%BB%93/</url>
      
        <content type="html"><![CDATA[<p>本文档总结了在 Linux 系统中查看各种硬件组件信息的常用命令。这些命令通常需要在终端中执行。</p><hr><h2 id="CPU-信息-🧠">CPU 信息 🧠</h2><ul><li><strong><code>lscpu</code></strong>: 显示 CPU 架构、核心数、线程数、速度、缓存等详细信息。  <figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">lscpu<br></code></pre></td></tr></table></figure></li><li><strong><code>cat /proc/cpuinfo</code></strong>: 查看更详细的 CPU 底层信息，每个逻辑核心都会有条目。  <figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> /proc/cpuinfo<br></code></pre></td></tr></table></figure></li><li><strong>通过 <code>dmidecode</code> 查看处理器详情</strong> (通常需要 <code>sudo</code>):  <figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">sudo</span> dmidecode -t processor<br></code></pre></td></tr></table></figure></li></ul><hr><h2 id="内存-RAM-信息-💾">内存 (RAM) 信息 💾</h2><ul><li><strong><code>free -h</code></strong>: 以人类可读格式显示总内存、已用、可用内存及交换空间情况。  <figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">free -h<br></code></pre></td></tr></table></figure></li><li><strong><code>cat /proc/meminfo</code></strong>: 查看详细的内存使用和内核统计信息。  <figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> /proc/meminfo<br></code></pre></td></tr></table></figure></li><li><strong><code>sudo dmidecode -t memory</code></strong> 或 <strong><code>sudo dmidecode -t 17</code></strong>: 查看每个物理内存条的详细信息，如制造商、型号、序列号、容量、速度、类型 (DDR4)、Rank、是否支持 ECC 等。  <figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">sudo</span> dmidecode -t memory<br></code></pre></td></tr></table></figure></li><li><strong><code>sudo lshw -class memory -short</code></strong>: 简要列出内存子系统信息。  <figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">sudo</span> lshw -class memory -short<br></code></pre></td></tr></table></figure></li></ul><hr><h2 id="硬盘-存储设备信息-HDD-SSD-💿">硬盘/存储设备信息 (HDD/SSD) 💿</h2><ul><li><strong><code>lsblk</code></strong>: 以树状结构显示块设备（硬盘、分区、LVM、loop 设备等）。  <figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">lsblk<br><span class="hljs-comment"># 推荐用法，显示型号和是否为旋转磁盘 (ROTA=1 为 HDD, ROTA=0 为 SSD)</span><br>lsblk -o NAME,SIZE,TYPE,MODEL,ROTA<br></code></pre></td></tr></table></figure></li><li><strong><code>df -h</code></strong>: 显示已挂载文件系统的磁盘空间使用情况。  <figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">df</span> -h<br></code></pre></td></tr></table></figure></li><li><strong><code>sudo fdisk -l</code></strong>: 列出所有磁盘及其分区表信息（MBR 或 GPT）。  <figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">sudo</span> fdisk -l<br></code></pre></td></tr></table></figure></li><li><strong><code>sudo lshw -class disk</code></strong>: 显示详细的磁盘硬件信息，包括产品型号、供应商等。  <figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">sudo</span> lshw -class disk<br></code></pre></td></tr></table></figure></li><li><strong><code>sudo smartctl -a /dev/sdx</code></strong>: 查看指定磁盘 (将 <code>/dev/sdx</code> 替换为实际设备名，如 <code>/dev/sda</code> 或 <code>/dev/nvme0n1</code>) 的 S.M.A.R.T. 健康状况和详细参数。需要先安装 <code>smartmontools</code> (<code>sudo apt install smartmontools</code>)。  <figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">sudo</span> smartctl -a /dev/sda<br></code></pre></td></tr></table></figure></li><li><strong>针对 NVMe SSD</strong>:<ul><li><code>sudo nvme list</code>: 列出所有 NVMe SSD。</li><li><code>sudo nvme smart-log /dev/nvme0n1</code>: 查看特定 NVMe SSD 的健康日志 (替换设备名)。</li><li>需要先安装 <code>nvme-cli</code> (<code>sudo apt install nvme-cli</code>)。</li></ul></li></ul><hr><h2 id="网卡-网络接口-信息-🌐">网卡 (网络接口) 信息 🌐</h2><ul><li><strong><code>ip addr show</code></strong> 或 <strong><code>ip a</code></strong>: 显示所有网络接口的配置，包括 IP 地址、MAC 地址、状态等。  <figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">ip a<br></code></pre></td></tr></table></figure></li><li><strong><code>lspci -k | grep -i -E &quot;ethernet|network&quot;</code></strong>: 查看 PCI 总线上的网络控制器及其正在使用的内核驱动。  <figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">lspci -k | grep -i -E <span class="hljs-string">&quot;ethernet|network&quot;</span><br></code></pre></td></tr></table></figure></li><li><strong><code>sudo lshw -class network</code></strong>: 显示详细的网络硬件报告，包括型号、供应商、速度能力等。  <figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">sudo</span> lshw -class network<br></code></pre></td></tr></table></figure></li><li><strong><code>sudo ethtool &lt;interface_name&gt;</code></strong>: 查看特定网络接口 (如 <code>eno1</code>) 的详细设置、支持的链路模式、当前速度、双工模式等。需要先安装 <code>ethtool</code> (<code>sudo apt install ethtool</code>)。  <figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">sudo</span> ethtool eno1<br></code></pre></td></tr></table></figure></li></ul><hr><h2 id="GPU-显卡-信息-🖥️">GPU (显卡) 信息 🖥️</h2><ul><li><strong><code>lspci | grep -i -E &quot;vga|3d|display|nvidia|amd|radeon|graphics&quot;</code></strong>: 初步判断系统是否识别到 GPU 作为 PCI 设备，并查看其型号。  <figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">lspci | grep -i -E <span class="hljs-string">&quot;vga|3d|display|nvidia|amd|radeon|graphics&quot;</span><br></code></pre></td></tr></table></figure></li><li><strong>针对 NVIDIA GPU</strong>:<ul><li><code>nvidia-smi</code>: 显示 NVIDIA GPU 的详细状态，包括驱动版本、温度、显存使用、GPU 利用率等。需要已正确安装 NVIDIA 驱动。  <figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">nvidia-smi<br></code></pre></td></tr></table></figure></li></ul></li><li><strong><code>sudo lshw -class display</code></strong>: 显示系统识别到的显示控制器的详细信息。  <figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">sudo</span> lshw -class display<br></code></pre></td></tr></table></figure></li></ul><hr><h2 id="其他硬件信息-🛠️">其他硬件信息 🛠️</h2><ul><li><strong><code>lsusb</code></strong>: 列出所有 USB 总线和连接的 USB 设备。  <figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">lsusb<br></code></pre></td></tr></table></figure></li><li><strong><code>sudo dmidecode</code></strong>: 显示所有 DMI (Desktop Management Interface) 信息，包含主板、BIOS、系统、机箱等非常全面的硬件底层数据。  <figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">sudo</span> dmidecode<br><span class="hljs-comment"># 查看主板型号</span><br><span class="hljs-built_in">sudo</span> dmidecode -t baseboard<br><span class="hljs-comment"># 查看BIOS信息</span><br><span class="hljs-built_in">sudo</span> dmidecode -t bios<br></code></pre></td></tr></table></figure></li><li><strong><code>sudo lshw</code></strong>: (List Hardware) 一个综合性的硬件信息查看工具，可以提供非常详细的硬件配置报告。<ul><li>安装：<code>sudo apt install lshw</code></li><li>查看简要信息：<code>sudo lshw -short</code></li><li>生成 HTML 报告：<code>sudo lshw -html &gt; hardware_report.html</code></li></ul></li></ul><hr><p><strong>注意:</strong> 很多命令（特别是直接访问硬件底层信息的，如 <code>dmidecode</code>, <code>lshw</code>, <code>smartctl</code>, <code>nvme</code>, <code>fdisk</code>, <code>ethtool</code>）需要使用 <code>sudo</code> 以管理员权限运行才能获取完整信息。</p>]]></content>
      
      
      <categories>
          
          <category> Tech Blogs </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Tools </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Coding Diary(2025-5-19)</title>
      <link href="/blogs/2025/05/19/Coding%20Diary(2025-5-19)/"/>
      <url>/blogs/2025/05/19/Coding%20Diary(2025-5-19)/</url>
      
        <content type="html"><![CDATA[<p>感觉我这个也不算是 coding diary，主要是就是技术方面的日志，好久没有写代码了。</p><p>这两天把服务器搞好了，虽然非常离谱的卖家已读不回，但毕竟啥都有，都能开机，就把我的 2080 ti 22 G 显卡直接装上开机了，声音是真的大，不得不说。第一次装显卡，真是小心翼翼的，一点都不敢乱动，而且还发现金手指背面倒数第二根少一块，真是吓死我了，我心思我这么轻的插拔都能有问题吗，还好搜完之后发现就是这么设计的。</p><p>ubuntu server 的安装也是非常简单，总体来讲都是一样的，就是把系统烧到一个 U 盘里，然后进 bios，选择启动盘，就 ok 了，整个过程都是比较 smooth 的。然后有一堆设置，就问 GPT 就完事了。</p><p>今天非常惨的一点是，我整 NAS，然后网太慢，就喊联通的来整网络，结果路由器整没了一个，相当于网关换了一个，直接连不上了，笑死了，然后我之前还整的静态内网 ip，直接完蛋，重装系统了直接。不过飞牛这个重装系统还是很好的，基本啥都没丢，因为他可以只格式化系统盘，所以原来的数据都还在，只要重新挂载一下就行。我之前备份的照片什么，还有外接硬盘里的电影啥的都在，就是昨天下的电影好像出问题了，给它删了，今天重新下一下试一试。</p><p>现在又买了一个网线，一个 switcher。等着到时候把服务器什么都放在车库了，希望到时候也会很好用👍。我还想加装硬盘来着，就是说不给机会，实在是没钱了。服务器我还想加装内存，感觉内存也不怎么值钱。</p><p>查了一下，发现天塌了，我现在是 4 条 8 G 内存，按我的想法是要上 32 G 内存，这样我可以慢慢加，这家伙直接没法用了，更天塌的是，我要是上 8 条 32 G 的内存的话，要 1600 大洋，现在拿不出来一点，😮‍💨。更天塌的是，我最好可以一下子上 8 条，否则下次再装更难受。因为我这个离谱服务器，电源版在一半的主板上面，也就是说要把电源板给卸下来，才能装内存，也就是我最好可以一下子装 8 条。</p>]]></content>
      
      
      <categories>
          
          <category> Coding Blogs </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 日记 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mac 好用的命令行工具总结</title>
      <link href="/blogs/2025/05/16/caffeinate%20%E5%91%BD%E4%BB%A4%E6%80%BB%E7%BB%93/"/>
      <url>/blogs/2025/05/16/caffeinate%20%E5%91%BD%E4%BB%A4%E6%80%BB%E7%BB%93/</url>
      
        <content type="html"><![CDATA[<p>把一些可能用到的比较好用的工具总结到了这里。</p><h2 id="使用-rsync-进行高效文件同步与恢复（macOS）"><strong>使用 rsync 进行高效文件同步与恢复（macOS）</strong></h2><p>rsync 是 macOS 和 Linux 系统中常用的命令行文件同步工具，支持断点续传、增量复制、排除文件等功能，非常适合拷贝大文件或进行数据迁移。</p><hr><h3 id="一、基本语法"><strong>一、基本语法</strong></h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">rsync [选项] 源路径 目标路径<br></code></pre></td></tr></table></figure><p>源路径和目标路径都可以是本地路径或远程路径（使用 SSH）。拷贝路径时注意 / 的使用影响结构，详见后文。</p><h3 id="二、常用选项说明"><strong>二、常用选项说明</strong></h3><table><thead><tr><th><strong>选项</strong></th><th><strong>含义</strong></th></tr></thead><tbody><tr><td>-a</td><td>归档模式（保留权限、时间戳、符号链接等）</td></tr><tr><td>-v</td><td>输出详细信息（verbose）</td></tr><tr><td>-h</td><td>以人类可读的方式显示大小（如 1K、20M）</td></tr><tr><td>–progress</td><td>显示每个文件的复制进度</td></tr><tr><td>–dry-run</td><td>预演命令但不执行操作，适合拷贝前查看将会做什么</td></tr><tr><td>–delete</td><td>删除目标路径中，源路径中已不存在的文件（谨慎使用）</td></tr><tr><td>–update</td><td>只复制源路径中比目标路径更新的文件</td></tr><tr><td>–exclude</td><td>排除某些文件或目录，例如 .DS_Store</td></tr></tbody></table><h3 id="三、路径末尾-的含义">三、路径末尾 / 的含义</h3><ul><li>不加 /：拷贝整个目录，包括文件夹本身</li></ul><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">rsync -avh /source /dest<br>→ 结果是 /dest/source/...<br></code></pre></td></tr></table></figure><ul><li>加上 /：仅拷贝目录内的内容</li></ul><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">rsync -avh /source/ /dest<br>→ 结果是 /dest/...<br></code></pre></td></tr></table></figure><p>建议源路径加 /，更符合我们拷贝“内容而不是文件夹”的直觉。</p><h3 id="四、典型使用示例">四、典型使用示例</h3><p><strong>复制整个目录并显示进度：</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">rsync -avh --progress /Volumes/SourceDisk/Movies/ /Volumes/TargetDisk/Movies/<br></code></pre></td></tr></table></figure><p><strong>预演会复制哪些内容（不实际执行）：</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">rsync -avh --dry-run /source/ /target/<br></code></pre></td></tr></table></figure><p><strong>跳过 .DS_Store 文件：</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">rsync -avh --progress --exclude=&quot;.DS_Store&quot; /source/ /target/<br></code></pre></td></tr></table></figure><p><strong>完全同步（删除目标中多余的文件）：</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">rsync -avh --delete /source/ /target/<br></code></pre></td></tr></table></figure><h3 id="五、-DS-Store-是什么？应不应该拷贝？">五、.DS_Store 是什么？应不应该拷贝？</h3><p>.DS_Store 是 macOS 用来保存文件夹显示设置的隐藏文件，例如图标排列方式、排序顺序等。它对文件内容无任何影响，在备份或传输到非 Mac 系统时通常建议排除。</p><p>可用 --exclude=“.DS_Store” 选项避免拷贝此类文件。</p><h3 id="六、输出信息的解释">六、输出信息的解释</h3><p>在拷贝过程中，你可能会看到如下信息：</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">xfer#6, to-check=60/399<br></code></pre></td></tr></table></figure><p>含义如下：</p><ul><li>xfer#6：当前第 6 个被复制的文件</li><li>to-check=60/399：还剩 60 个文件待检查，总共需检查 399 个</li></ul><p>只要某个文件显示 100%，就表示该文件已完整复制。</p><h3 id="七、总结">七、总结</h3><ul><li>rsync 是一个非常适合做备份、数据迁移和断点恢复的工具。</li><li>可跳过已存在文件，提高效率。</li><li>注意源路径 / 的使用决定结构层级。</li><li>使用 --dry-run 可以避免误操作。</li><li>对于 macOS，建议排除 .DS_Store 文件。</li></ul><h2 id="caffeinate-指令详解（macOS）"><code>caffeinate</code> 指令详解（macOS）</h2><p><code>caffeinate</code> 是 macOS 系统下用来防止系统睡眠的命令行工具。它可以保持系统、显示器、磁盘持续唤醒状态，常用于后台任务、模型训练、虚拟机运行等场景。</p><h3 id="一句话说明">一句话说明</h3><p><code>caffeinate</code> 是 mac 上的“咖啡因”，让你的 Mac 保持清醒不睡觉。</p><h3 id="常用语法">常用语法</h3><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">caffeinate [options]<br></code></pre></td></tr></table></figure><h3 id="常用参数说明">常用参数说明</h3><table><thead><tr><th>参数</th><th>含义</th><th>示例</th></tr></thead><tbody><tr><td><code>-d</code></td><td>防止显示器休眠</td><td><code>caffeinate -d</code></td></tr><tr><td><code>-i</code></td><td>防止系统因空闲进入休眠</td><td><code>caffeinate -i</code></td></tr><tr><td><code>-m</code></td><td>防止磁盘挂起</td><td><code>caffeinate -m</code></td></tr><tr><td><code>-s</code></td><td>防止系统睡眠（仅限接电源状态）</td><td><code>caffeinate -s</code></td></tr><tr><td><code>-t &lt;秒&gt;</code></td><td>指定保持唤醒的时间（单位为秒）</td><td><code>caffeinate -t 3600</code></td></tr><tr><td><code>-u</code></td><td>模拟用户活动（让系统以为你动了鼠标）</td><td><code>caffeinate -u -t 10</code></td></tr><tr><td><code>-w &lt;PID&gt;</code></td><td>跟随某个进程保持唤醒，进程结束后退出唤醒状态</td><td><code>caffeinate -w 1234</code></td></tr></tbody></table><h3 id="常见用法示例">常见用法示例</h3><h4 id="1-全面防止系统任何形式的睡眠">1. 全面防止系统任何形式的睡眠</h4><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">caffeinate -d -i -m -s<br></code></pre></td></tr></table></figure><h4 id="2-简单防止系统休眠（默认保持唤醒）">2. 简单防止系统休眠（默认保持唤醒）</h4><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">caffeinate<br></code></pre></td></tr></table></figure><h4 id="3-保持唤醒-1-小时">3. 保持唤醒 1 小时</h4><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">caffeinate -t 3600<br></code></pre></td></tr></table></figure><h4 id="4-只防止屏幕熄灭">4. 只防止屏幕熄灭</h4><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">caffeinate -d<br></code></pre></td></tr></table></figure><h4 id="5-跟随某个程序保持唤醒">5. 跟随某个程序保持唤醒</h4><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">caffeinate -w $(pgrep -f python)<br></code></pre></td></tr></table></figure><h3 id="如何停止？">如何停止？</h3><p>按下 <code>Ctrl + C</code> 或关闭运行 <code>caffeinate</code> 的终端窗口即可恢复正常休眠行为。</p><h3 id="应用场景建议">应用场景建议</h3><table><thead><tr><th>场景</th><th>推荐命令</th></tr></thead><tbody><tr><td>下载大文件 / 备份</td><td><code>caffeinate -i</code></td></tr><tr><td>深度学习 / 模型训练</td><td><code>caffeinate</code></td></tr><tr><td>运行虚拟机 / NAS 后台服务</td><td><code>caffeinate -d -i -m</code></td></tr><tr><td>视频播放保持亮屏</td><td><code>caffeinate -d</code></td></tr><tr><td>限时唤醒（如跑脚本）</td><td><code>caffeinate -t 1800</code></td></tr></tbody></table><h3 id="注意事项">注意事项</h3><ul><li><code>caffeinate</code> 不会修改系统设置，只在运行期间生效。</li><li>合盖是否睡眠还取决于系统设置和硬件支持（需借助工具如 InsomniaX 防盖板睡眠）。</li></ul>]]></content>
      
      
      <categories>
          
          <category> Tech Blogs </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Tools </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>生活日志(2025-5-16)</title>
      <link href="/blogs/2025/05/16/%E7%94%9F%E6%B4%BB%E6%97%A5%E5%BF%97(2025-5-16)/"/>
      <url>/blogs/2025/05/16/%E7%94%9F%E6%B4%BB%E6%97%A5%E5%BF%97(2025-5-16)/</url>
      
        <content type="html"><![CDATA[<p>最近又有好消息，可以跟 Professor Ma 做一些 MLsys 方向的东西，还不错，虽然不是纯 sys，而是有点偏应用的 project，但从应用方向开始也是不错的，并且老师表示可以让我多留一个月，她会提供 stipend，虽然还不知道有多少，但应该可以 cover，毕竟中东还是有钱。还有十几天就要去中东，不得不说这个暑假真是过于充实了。</p><p>TA 的录取 offer 终于下来了，虽然才 1500 的工资，但这应该算是我在校外的第一份正式拿钱的兼职，还是当 TA 这种我很喜欢的工作，现在就只剩 PM 的消息了，希望也能有好的结果，这个我是最期待的了。</p><p>回家之后也搞了很多有意思的东西，直接把我 300 淘来的 Mac mini 刷成飞牛了（详情可见这个 <a href="https://s-tanley.github.io/blogs/2025/05/07/300%20%E5%85%83%20Mac%20mini%20%E7%A7%92%E5%8F%98%E5%AE%B6%E7%94%A8%20Nas/?highlight=300">blog</a>）；又从闲鱼上买了一堆东西，花了真是贼多钱，算算账：</p><table><thead><tr><th>物品</th><th>价格（¥）</th></tr></thead><tbody><tr><td>奥睿科硬盘柜</td><td>350</td></tr><tr><td>希捷 12 T 机械硬盘</td><td>700</td></tr><tr><td>超微 7048GR-TR 平台 准平台</td><td>1500</td></tr><tr><td>给服务器配的相应的 CPU、内存和固态</td><td>500</td></tr><tr><td>2080 Ti 22 G 显存 涡轮版 * 2</td><td>2390 * 2</td></tr><tr><td>HDMI 2.1</td><td>7.9</td></tr><tr><td>网线</td><td>12.9</td></tr><tr><td>数据线储物包</td><td>17.5</td></tr><tr><td>2.5 G 有线网卡转 Type-C</td><td>44</td></tr><tr><td>HDMI 转 VGA</td><td>6.99</td></tr><tr><td>机柜</td><td>700</td></tr><tr><td><strong>总计</strong></td><td>8,619.29</td></tr></tbody></table><p>不算不知道，一算吓一跳，都快一万块了，确实烧钱。</p>]]></content>
      
      
      <categories>
          
          <category> Life Blogs </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 日记 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Reading Notes for Orca</title>
      <link href="/blogs/2025/05/15/Orca/"/>
      <url>/blogs/2025/05/15/Orca/</url>
      
        <content type="html"><![CDATA[<p>This is the reading notes for the <em>ORCA: A Distributed Serving System for Transformer-Based Generative Models</em>. This is an OSDI conference paper from 2022. Almost all the authors come from South Korea, and actually, this is the first time I have read papers written by Koreans.</p><h1>Summary</h1><h2 id="Abstract-Introduction-Background">Abstract &amp; Introduction &amp; Background</h2><p>The paper is focused on the inference serving, they point out that the existing system is not good enough for transformer-based models. So, they propose a new method called <strong>iteration-level scheduling</strong> and create a distributed system called <strong>ORCA</strong>.</p><p>Besides the scheduling thing, they also introduced a new batching method to fit with their scheduling method, which is called <strong>selective batching</strong>.</p><p>The background information they give is kind of detailed. The first part is about the transformer-based models, the second part is about the existing serving system.</p><img src="./Orca/CleanShot 2025-05-25 at 14.20.44@2x.png" alt="CleanShot 2025-05-25 at 14.20.44@2x" style="zoom:80%;" /><p>The Figure 1(a) actually brings me some confusion, and I talked about it in Thoughts &gt; About Figure 1.</p><p>The background information do not have too much to talk about.</p><p>There are also two figures about exising inference system.</p><img src="./Orca/CleanShot 2025-05-25 at 14.35.46@2x.png" alt="CleanShot 2025-05-25 at 14.35.46@2x" style="zoom:35%;" /><img src="./Orca/CleanShot 2025-05-25 at 14.36.19@2x.png" alt="CleanShot 2025-05-25 at 14.36.19@2x" style="zoom:35%;" /><p>Figure 2 is how the existing serving system work, and the Figure 3 is why the current serving system oot good enough. The figure is actually kind of clear.</p><p>Basically, we just combine requests in to a batch, the send the batch to the model, and after all the requests meet the end, we send them back. Some request may need more iteration, but the other requests can only wait. This is what the authors want to improve.</p><h2 id="Challenges-and-Proposed-Solutions">Challenges and Proposed Solutions</h2><p>Just two challenges and two corresponding solutions.</p><p>First about schedling and second about batching.</p><img src="./Orca/CleanShot 2025-05-25 at 14.44.21@2x.png" alt="CleanShot 2025-05-25 at 14.44.21@2x" style="zoom:35%;" /><p>They want for each iteration, we can choose the requests, so they create a request pool. Every iteration, they choose enough requests from the pool to make up a batch, and after only one iteration, the model sends the output back to the pool. The requests that are done can be sent back to the clients, and new requests can just be put in the pool.</p><img src="./Orca/CleanShot 2025-05-26 at 11.28.58@2x.png" alt="CleanShot 2025-05-26 at 11.28.58@2x" style="zoom:33%;" /><p>The second thing they do is the selective batching, just like Figure 5 shows above. The basic idea is simple, but there are some details I am confused about. I write them in Thoughts &gt; Confusion &gt; About batching.</p><h2 id="ORCA-Design-Implementation">ORCA Design &amp; Implementation</h2><p>The ORCA design basically contains two things: one is how we place our model on the GPUs, and the other one is what is the detail of the scheduling.</p><img src="./Orca/CleanShot 2025-05-26 at 22.31.56@2x.png" alt="CleanShot 2025-05-26 at 22.31.56@2x" style="zoom:33%;" /><p>The Figure 6 and 7 introduce how ORCA places the model on GPUs and what parallelization strategy ORCA uses. About parallelism, there are so many different terms about this, but they all represent the same thing.</p><img src="./Orca/CleanShot 2025-05-27 at 11.19.42@2x.png" alt="CleanShot 2025-05-27 at 11.19.42@2x" style="zoom:33%;" /><p>Here, for ORCA, every intra-layer will be set as one node, just like Figure 7 shows. It’s very clear, not like some other papers, very blurry about what a “worker” or “node” actually refers to.</p><p>For the scheduling algorithm, it’s just very detailed, and there’s no point I talking here. I have some questions about this, and write them in Thoughts &gt; Confusion &gt; About the scheduling algorithms.</p><p>The implementation is very short and do not have too much to talk about.</p><h2 id="Evaluation-Related-Work-and-Discussion-Conclusion">Evaluation &amp; Related Work and Discussion &amp; Conclusion</h2><p>The evaluation is just you set up a baseline and compare it with different setups, and show that your results are great.</p><h1>Thoughts</h1><p>The paper is kind of old, I think nowadays the support for the LLM inference is very sophisticated. I know two mainstream open-source projects focus on this area: vLLm and SGLang. I actually know some developers of SGLang. However, in this paper, none of them is mentioned 😂. I think this is because the paper is kind of old, and for the framework it mentions, I actually have no idea.</p><h2 id="Confusion">Confusion</h2><h3 id="About-Figure-1">About Figure 1</h3><p>Figure 1(a) was initially a little confusing for me, as it seemed that in the increment phase, we only needed the output from the last iteration. However, what I remember about how the transformer works is that you add the last iteration’s output to your last iteration’s input. Like in the initial phase, your input is “I think it”, the output is “is”, then the next iteration’s input will be “I think it is” and so on. If you read some other papers or some other blogs about the transformer, you’ll see some figures drawn in this way.</p><p>I think this is about two different ways to express the model. Each iteration definitely uses the information of the previous iteration’s input, but in this paper, the author may think this information is already in our K/V cache or K/V manager. It’s like not purely input, so they just ignore these. However, I think the most plausible answer to me is that omitting the previous input makes it easy to draw good figures😂.</p><p>This is actually related to another topic, which is “why in an inference system, we only need to store K/V?” There is a <a href="https://zhuanlan.zhihu.com/p/23553666052">blog</a> that talks about this issue.</p><h3 id="About-batching">About batching</h3><h4 id="How-to-batch-requests-together">How to batch requests together</h4><p>In this paper, it says that if we satisfy some strict conditions, we can batch different requests together, and I just a little bit confused about that, since for me it seems that there is no way we can do the attention process together.</p><h4 id="About-Figure-5">About Figure 5</h4><p>I just don’t know why the hidden dimension becomes 3H.</p><h3 id="About-the-scheduling-algorithms">About the scheduling algorithms</h3><h4 id="first-come-first-served-FCFS">first-come-first-served (FCFS)</h4><p>They mention that they make sure that the previous come requests must have greater or equal iteration times than the later requests. However, the detail is omitted, I just wonder how they do this, like sort the request pool every iteration? Just wondering.</p><h4 id="max-tokens-attribute"><em>max_tokens</em> attribute</h4><p>This is a very important attribute, but they do not state how they get this attribute. It seems that they just know the maximum output length of each requests from nowhere.</p><h2 id="Ideas">Ideas</h2><h3 id="About-the-iteration-level-scheduling">About the &quot;iteration level scheduling &quot;</h3><p>They basically run one iteration of work for a request, then check its status, managing all these requests in a central pool. This “iterate once, check once” model is efficient in some ways, but it sparked a thought: could we make it even smarter?</p><p>What if we could get a rough idea, right at the start, of how many iterations a particular request might need to finish? Maybe a small, lightweight predictive model – something like a mini neural network – could look at a request’s characteristics and make an educated guess. It could flag some as likely “quick wins” and others as “longer hauls.”</p><p>If we had that kind of foresight, we could then route requests into different processing pools based on their predicted effort. Imagine a pool for tasks expected to finish in just a few iterations, another for medium-length ones, and a third for those predicted to take a significant amount of time. The real tweak would then be how often we “check in” on the progress of requests in each pool. For the fast pool, frequent checks, similar to Orca’s current method, would make sense to maintain responsiveness. But for requests in the medium or long-haul pools, we could reduce the check-in frequency considerably. Instead of checking after every single iteration, perhaps we’d check after every K1 iterations for medium tasks, and an even larger K2 iterations for the long ones.</p><p>The potential upside here is a reduction in overhead. Constantly checking the status of a long-running task can be wasteful. By being more selective about when we check, especially for tasks we anticipate will take a while, the system could spend more of its resources actually <em>doing</em> the work rather than managing it. This could lead to better throughput for longer jobs without significantly impacting the latency of shorter ones. Naturally, the accuracy of the predictive model and the overhead of managing multiple pools with different check strategies would be key things to figure out, but it’s an intriguing possibility for optimizing such iterative processing systems. It’s just a thought bubble for now, but an interesting one!</p>]]></content>
      
      
      <categories>
          
          <category> Reading Paper </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MLSys </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>300 元 Mac mini 秒变家用 Nas</title>
      <link href="/blogs/2025/05/07/300%20%E5%85%83%20Mac%20mini%20%E7%A7%92%E5%8F%98%E5%AE%B6%E7%94%A8%20Nas/"/>
      <url>/blogs/2025/05/07/300%20%E5%85%83%20Mac%20mini%20%E7%A7%92%E5%8F%98%E5%AE%B6%E7%94%A8%20Nas/</url>
      
        <content type="html"><![CDATA[<p>最近一直想组一个 NAS，正好家里有闲鱼上二手淘来本来想用来当跳板机的 Mac mini，可以直接用上。</p><p>最开始本来想的是，用虚拟机装飞牛，当时想着刷一个初始化一下，结果把系统整没了，也装不回来了，直接一不做而不休，直接刷个飞牛，也不搞虚拟机了。整个过程比想象的简单多了，我基本上就参考了这一个 <a href="https://mp.weixin.qq.com/s/UcUPMy7zxa5GwCq41EHYxw">blog</a>，过程还是比较详细的。</p><p>制作引导 U 盘最好找一个 16 G 的，不过我用的都是 8 G 的，也是初中的时候剩下的，正好能用上，用的工具是 <a href="https://etcher.balena.io/#download-etcher">BalenaEtcher</a>，它有 Mac 版本，把飞牛的 iso 文件刷进去就可以了。我整个操作都非常丝滑，一点报错没有。</p><p>后面的装系统也是，就按照前面那个 blog 的流程走就行。</p><p>成品如下：</p><img src="./300 元 Mac mini 秒变家用 Nas/CleanShot 2025-05-16 at 07.12.50@2x.png" alt="CleanShot 2025-05-16 at 07.12.50@2x" style="zoom:80%;" /><p>目前有点问题的地方就是理论上我应该是一个千兆网口，不知道为什么是个飞牛识别出来是个百兆，不知道卡在哪里了。</p><p>其次就是家里没有 ipv6 这就意味着在外网看流畅看视频基本不太可能了，感觉再申请一个然后搞 DDNS 也挺麻烦，我在美国是有 ipv6 的，但是 DDNS 也没成功，虽然当时飞牛这个官方的内外穿透注册不上，不过传个图片应该是可以的，不知道有没有什么办法能测个速。</p><p>最后就是虽然我开启了手动配置 ip，也就是静态内网 ip，但是当我换到楼上，用另外一个网线的时候，好像还是不好用，因为楼上没有显示屏，我看不到 ip，车库有很老的显示屏，只有 VGA 接口，买了个 VGA 转 HDMI，两天之后见分晓。</p>]]></content>
      
      
      <categories>
          
          <category> Tech Blogs </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Nas </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>生活日志(2025-5-7)</title>
      <link href="/blogs/2025/05/07/%E7%94%9F%E6%B4%BB%E6%97%A5%E5%BF%97(2025-5-7)/"/>
      <url>/blogs/2025/05/07/%E7%94%9F%E6%B4%BB%E6%97%A5%E5%BF%97(2025-5-7)/</url>
      
        <content type="html"><![CDATA[<p>Final Week 了，最近可以说是非常忙碌了。回国的机票都买完了，要坐将近两天飞机，感觉也是蛮离谱的。CS 525 也考完了，感觉应该还行，应该可以拿 A。CS 475 和 STAT 333 就剩一个尾巴了，所以只剩一个复习 354 了，希望问题不大，还没开始复习，笑死了，感觉东西还是挺多的。</p><p>不过今天心情还蛮不错的，有点好消息。除了这些考试都要考完了，我非常久之前申请的暑期的线上 TA 实习也终于有消息了，还以为直接无了，现在至少是第一候选人了。MBZUAI 也终于回复我了一个邮件，说明一切应该都还在 in process，但是快 20 天才回也是怪离谱的。CS 354 的 PM 也面试完了，整整面试了一个小时，也是比较抽象了，我记得这个时间也是最后一个可选的时间段，可能会很快出结果吧，跟 instructor 还是挺熟的，希望能有好的结果🙏。</p><p>加油了，也不知道一天够不够复习的，感觉够呛啊哈哈哈哈哈哈，又要焦虑了，毕竟一个 quiz 就能写很久。</p><p>最近还一直在看组 nas 或者组 GPU，回家之后打算先把我的 Mac mini 小主机用上，组一个 nas 试一试看带宽什么的，再组一个 GPU 服务器，这样以后要跑什么训练啥的就能玩了，其实最好的选择还是，能够在川大里搞一个内网穿透，用 SCUPI 的 GPU 是最好不过了。</p>]]></content>
      
      
      <categories>
          
          <category> Life Blogs </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 日记 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Coding Diary(2025-4-29)</title>
      <link href="/blogs/2025/04/29/Coding%20Diary(2025-4-29)/"/>
      <url>/blogs/2025/04/29/Coding%20Diary(2025-4-29)/</url>
      
        <content type="html"><![CDATA[<p>继续我的 docker。</p><p>之前遇到一个报错：</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">Error: Failed to launch the browser process! undefined<br><br>[579:579:0430/015358.567760:ERROR:zygote_host_impl_linux.cc(105)] Running as root without --no-sandbox is not supported. See https://crbug.com/638180.<br><br><br><br><br><br>TROUBLESHOOTING: https://pptr.dev/troubleshooting<br><br><br><br> ❯ ChildProcess.onClose node_modules/@puppeteer/browsers/src/launch.ts:507:11<br><br><br><br>⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[1/1]⎯<br><br><br><br><br><br> Test Files  1 failed (1)<br><br>      Tests  2 skipped (2)<br><br>   Start at  01:53:46<br><br>   Duration  12.37s (transform 815ms, setup 0ms, collect 3.88s, tests 4.55s, environment 2ms, prepare 573ms)<br><br><br><br>npm notice<br><br>npm notice New major version of npm available! 10.8.2 -&gt; 11.3.0<br><br>npm notice Changelog: https://github.com/npm/cli/releases/tag/v11.3.0<br><br>npm notice To update run: npm install -g npm@11.3.0<br><br>npm notice<br></code></pre></td></tr></table></figure><p>Gemini 说是因为浏览器的问题。</p><p>正常我们在一个 docker image 里，我们都是 root，但是这个 Chromium 不允许我们以 root 的身份去运行。</p><p>然后他给出来了两个解决办法，一个就是改 vitest 的配置，我首先选择是改这个 vitest 的配置，但是改完之后还是报错，要继续改，好像是因为新版的 vitest 要用新的写法之类的，要改的太多了，我就直接去用另外一个方法了。</p><p>另外一个方法就是，更改用户的身份，不是 root 就行了。这个就是改了改 <code>dockerfile</code>。</p><p>用的命令是</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">docker build --platform=linux/amd64 -t my-test-env:dev .<br></code></pre></td></tr></table></figure><p>和</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">docker run -it --rm --platform=linux/amd64 -v &quot;$(pwd):/app&quot; -v /app/node_modules my-test-env:dev bash<br></code></pre></td></tr></table></figure><p>还是报错</p><img src="./Coding Diary(2025-4-29)/CleanShot 2025-04-29 at 22.03.32@2x.png" alt="CleanShot 2025-04-29 at 22.03.32@2x" style="zoom:75%;" /><p>我就试了一下直接下载</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">npx puppeteer browsers install chrome<br></code></pre></td></tr></table></figure><p>继续报错</p><img src="./Coding Diary(2025-4-29)/CleanShot 2025-04-29 at 22.11.28@2x.png" alt="CleanShot 2025-04-29 at 22.11.28@2x" style="zoom:80%;" /><p>询问 Gemini，告诉我还是要改 vitest 配置文件，兜兜转转又回去了，离谱。</p><p>这次改完之后可以运行了，但是遇到了下一个报错，timeout。</p><p>专门去搜了下文档，改了一下默认时间。</p><p>但是继续 timeout。</p><p>那这感觉就有很多可能性了。</p>]]></content>
      
      
      <categories>
          
          <category> Coding Blogs </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 日记 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>学习日志(2025-4-25)</title>
      <link href="/blogs/2025/04/25/%E5%AD%A6%E4%B9%A0%E6%97%A5%E5%BF%97(2025-4-25)/"/>
      <url>/blogs/2025/04/25/%E5%AD%A6%E4%B9%A0%E6%97%A5%E5%BF%97(2025-4-25)/</url>
      
        <content type="html"><![CDATA[<p>今天终于看完了 UCSD 的 CSE 234 的 <a href="https://mlsysbook.ai/contents/core/dnn_architectures/dnn_architectures.html">required reading 1.2</a>，足足一章，确实是内容很多，主要就是介绍了目前的四种主流模型，MLP、CNN、RNN 和 Transformer。确实算得上是详略得当，refresh my memory again。后面还有一些计算方面的介绍，虽然没有很深入，确实不错。</p>]]></content>
      
      
      <categories>
          
          <category> Study Blogs </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 日记 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Coding Diary(2025-4-24)</title>
      <link href="/blogs/2025/04/24/Coding%20Diary(2025-4-24)/"/>
      <url>/blogs/2025/04/24/Coding%20Diary(2025-4-24)/</url>
      
        <content type="html"><![CDATA[<p>最近这两天也算搞了点有意思的，除了不想学习，其他干啥都有意思，笑死了。</p><p>走通了怎么在 Mac 上用虚拟机装 NAS，不得不说还是有点成就感的，就是这个公网确实是有点烦躁，搞不出公网访问，看看周末有没有时间再搞一搞。</p><p>我用的是飞牛的系统，不得不说作为一个开源的系统确实是看上去很不错，很简单，能直接用。相关的具体流程，包括踩了什么坑之类的打算开一个 NAS 相关的文档去写，这里就不写了。</p><p>除了 NAS，今天也算是把我这个 blog 网站的搜索功能加上了，用的本地搜索，搜索速度还是很快的。</p><p>这两天尽量把那个 intern 的自动测试给整出来，总是不想做，😮‍💨。</p>]]></content>
      
      
      <categories>
          
          <category> Coding Blogs </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 日记 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>主流 AI 实际使用体验（组合学答题方面）</title>
      <link href="/blogs/2025/04/22/%E4%B8%BB%E6%B5%81%20AI%20%E5%AE%9E%E9%99%85%E4%BD%BF%E7%94%A8%E4%BD%93%E9%AA%8C%EF%BC%88%E7%BB%84%E5%90%88%E5%AD%A6%E7%AD%94%E9%A2%98%E6%96%B9%E9%9D%A2%EF%BC%89/"/>
      <url>/blogs/2025/04/22/%E4%B8%BB%E6%B5%81%20AI%20%E5%AE%9E%E9%99%85%E4%BD%BF%E7%94%A8%E4%BD%93%E9%AA%8C%EF%BC%88%E7%BB%84%E5%90%88%E5%AD%A6%E7%AD%94%E9%A2%98%E6%96%B9%E9%9D%A2%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<p>进入到了 2025 年，各家的 AI 模型可以说已经是强到不像话了，尤其是 DeepSeek 发布自己的模型之后，各家更是都要卷飞了，尤其是各个大厂，不仅卷性能，卷价格，使用体验上也可以说是卷飞了，正好最近高强度使用了 Google Gemini 2.5 Pro、DeepSeek R1（官网版本）和 ChatGPT o3，浅浅的评测一下。需要注意的是测试时间是 2025.4.22，模型性能可能会根据时间的不同而变化，所以这个评测结果是有时效性的。</p><h1>整体使用体验</h1><p>整体的使用体验，我觉得是 Google Gemini 2.5 Pro &gt; ChatGPT o3 &gt; DeepSeek R1。</p><h2 id="UI">UI</h2><p>UI 上 Gemini 和 ChatGPT 是真的有打磨的很好，但是 DeepSeek 就很粗糙了，但是这也很正常，毕竟 DeepSeek 这个官网模型就相当于是一个“样板间”一样的东西，甚至也没有收费这一说。</p><h2 id="生成速度">生成速度</h2><p>生成速度方面 Google Gemini 2.5 Pro 一骑绝尘，真的太快了，ChatGPT o3 也可以接受，但是 DeepSeek 除了偶尔连不上网络问题让你一会在请求，他的模型也动不动就思考个 400、500 秒，但是同样的题，Google Gemini 2.5 Pro 可能 20 秒就生成完了。具体思考时间如下表：</p><table><thead><tr><th></th><th>Google Gemini 2.5 Pro</th><th>ChatGPT o3</th><th>DeepSeek R1</th></tr></thead><tbody><tr><td>Q1</td><td></td><td>5s</td><td>81s</td></tr><tr><td>Q2</td><td>51s</td><td>120s</td><td>305s</td></tr><tr><td>Q3</td><td>58s</td><td>63s</td><td>233s</td></tr><tr><td>Q4</td><td>33s</td><td>10s</td><td>149s</td></tr><tr><td>Q5</td><td>50s</td><td>21s</td><td></td></tr><tr><td>Q6</td><td>52s</td><td>12s</td><td></td></tr><tr><td>Q7</td><td>31s</td><td>8s</td><td></td></tr><tr><td>Q8</td><td>18s</td><td>3s</td><td></td></tr><tr><td>Q9</td><td>46s</td><td>16s</td><td></td></tr><tr><td>Q10</td><td>30s</td><td>11s</td><td></td></tr></tbody></table><p>需要注意的是，Google Gemini 2.5 Pro 自己不会计时，所以是我手记的，但是我不仅记 reasoning 时间了，还记了最后生成 final answer 的时间，大概相当于多记了 10 来秒。</p><p>从表里可以发现 ChatGPT 其实也很快，甚至比 Gemini 还快，我有的时候觉得慢可能是因为这个账号当时正好还有别人用。</p><h2 id="图片上传与识别">图片上传与识别</h2><p>这个问题最大的是 DeepSeek，DeepSeek 上传一个图片的速度实在是太慢了，还经常失败。</p><h1>生成文本质量</h1><h2 id="内容格式">内容格式</h2><p>因为是数学题，所以会用到很多数学公式，但其实三个都会有数学公式渲染不正确，最后出来一堆 latex 代码的情况。</p><p>就我这十道题来看，各个模型渲染出错的次数如表</p><table><thead><tr><th>模型名称</th><th>数学公式渲染出错次数</th></tr></thead><tbody><tr><td>Google Gemini 2.5 Pro</td><td>0</td></tr><tr><td>ChatGPT o3</td><td>6</td></tr><tr><td>DeepSeek R1</td><td>0</td></tr></tbody></table><p>可以看到 ChatGPT o3 的这个数学表达式的渲染可以说是糟糕至极，基本上每一道需要大段数学表达式的地方，他总会有的地方没渲染到，很影响体验。</p><h2 id="内容">内容</h2><p>内容方面我觉得还是 Google Gemini 2.5 Pro &gt; ChatGPT o3 &gt; DeepSeek R1，因为只有 Google Gemini 2.5 Pro 最后呈现出来的内容是一直详略得当的，ChatGPT o3 有的时候就会最后呈现的东西太少，而 DeepSeek R1 属于是基本上每次都少，就导致我光看最后总结出来的内容看不懂，要不然就得看他的 reasoning 内容，要不然就还得再问。</p><p>这个感觉就是工程上的问题了，各个阶段的 prompt 都是怎么写的，Google 明显做的更好。</p>]]></content>
      
      
      <categories>
          
          <category> Tech Blogs </category>
          
      </categories>
      
      
        <tags>
            
            <tag> NLP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>学习日志(2025-4-21)</title>
      <link href="/blogs/2025/04/21/%E5%AD%A6%E4%B9%A0%E6%97%A5%E5%BF%97(2025-4-21)%20/"/>
      <url>/blogs/2025/04/21/%E5%AD%A6%E4%B9%A0%E6%97%A5%E5%BF%97(2025-4-21)%20/</url>
      
        <content type="html"><![CDATA[<p>今天基本上一直在写 Math 475 的 midterm 2，然后看了 UCSD 的 CSE 234 的 required reading 1.1，一本挺不错的<a href="https://mlsysbook.ai/">电子书</a>，哈佛的一本开源书，笑死了，而且还找到了一处笔误，在我的 notes：mlsysbook 里有写，之后用空可以提个 PR。感觉现在我能做的贡献全是这样的校对工作，虽然感觉没什么太大创造力，但感觉还是又一些意义。</p><p>Math 475 的 midterm 2 才写到第六题，但如果按照计划我应该给他写完，还有满打满算 5 个小时，加把劲！</p><p>晚上睡觉前也把 Stat 333 的 thesis statement 给交了，虽然基本不用时间。</p>]]></content>
      
      
      <categories>
          
          <category> Study Blogs </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 日记 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>学习日志(2025-4-20)</title>
      <link href="/blogs/2025/04/20/%E5%AD%A6%E4%B9%A0%E6%97%A5%E5%BF%97(2025-4-20)%20/"/>
      <url>/blogs/2025/04/20/%E5%AD%A6%E4%B9%A0%E6%97%A5%E5%BF%97(2025-4-20)%20/</url>
      
        <content type="html"><![CDATA[<p>今天上午踢了个球，基本上剩下的时间都在写这个 CS 525 的 HW5，写的真是头晕脑胀的，但不得不说感觉一些概念稍微清晰了一些，本来还打算读一读 UCSD 的 CSE 234 的 required reading，但感觉确实是学不动了。</p><p>本来踢完球应该洗个澡，但是当时想着晚上稍微早点回来，然后洗澡睡觉，但是被 Kan 拖住了，一直在图书馆。不得不说又发现了一个好地方，memorial library 的 computer lab，全是很好的显示器，晚上还没人，还里 domain 或者 route A bus stop 近，天选自习室。哎，啥时候国内也能有这样子的地方就太好了。</p><p>STAT 333 的 HW4 扣了 40 分，足足 40%，因为直接少了一块 visualization 的部分，下次在写这个作业我一定要小心，仔细读好要求。</p><p>感觉还是挺充实的，但是我的 intern 又没时间搞了，明天还要写 Math 475 的 take-home midterm 2，这个也是非常离谱的大作业，要花很长时间去慢慢做。</p><p>哎，情感上又遇到了大挫折，不过这是学习日志，就不在这里写了。</p>]]></content>
      
      
      <categories>
          
          <category> Study Blogs </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 日记 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>生活日志(2025-4-20)</title>
      <link href="/blogs/2025/04/20/%E7%94%9F%E6%B4%BB%E6%97%A5%E5%BF%97(2025-4-20)/"/>
      <url>/blogs/2025/04/20/%E7%94%9F%E6%B4%BB%E6%97%A5%E5%BF%97(2025-4-20)/</url>
      
        <content type="html"><![CDATA[<p>最近其实过的还挺正常的，也不能说正常吧，这两天算是重回正轨，室友被警察抓走了，还去保释他，也算是人生阅历又 +1 了。</p><p>不过认识了 Kan，然后现在基本每天都约着去图书馆，可以说是效率比较高了。</p><p>但是悲伤的事情就又来了，小鱼要跟我分手，真的一想到就好伤心好伤心，感觉她现在就像我生活中的底色一样，淡淡的，浅浅的，忙起来你就会忽视，但她一直都在。其实最开始就能感觉到她非常饱满情绪，她会表达出来，但我不会。我一直追求的平和的生活，似乎过于平和了，我希望我可以不情绪化，不管面对任何事都不情绪化，最后发现我好像已经丧失情绪化这个功能了。我好悲伤，但是只有刚想起来那一阵最为心痛，再之后这种情感好像就变淡了，可是这能说明我内心深处不珍视这段感情吗，可是如果这样的话我为什么这么舍不得呢？我不知道，感觉我也不会得到答案了。</p>]]></content>
      
      
      <categories>
          
          <category> Life Blogs </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 日记 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>学习日志(2025-4-19)</title>
      <link href="/blogs/2025/04/19/%E5%AD%A6%E4%B9%A0%E6%97%A5%E5%BF%97(2025-4-19)/"/>
      <url>/blogs/2025/04/19/%E5%AD%A6%E4%B9%A0%E6%97%A5%E5%BF%97(2025-4-19)/</url>
      
        <content type="html"><![CDATA[<p>今天又是充实的一天，把 UCSD 的 CSE 234 第一周的 slides 和 recording 看完了，不过 required reading 还没看，如果可以的话今天或者明天给他看完。不得不说 Hao 老师讲话真快，看过很多课的 recording 感觉这是唯一一个我看了没有一点开倍速欲望，甚至还有减速欲望的。</p><p>还有重温了一下 LSTM，之前只看过 LSTM 的论文，或者只看过李沐讲 LSTM，确实没看过 llya 在 NIPS 2014 上的 <a href="https://www.youtube.com/watch?v=9l9xGoyDhMM">talk</a>，很短，但还是挺 impresive 的。llya 的口音真是很神奇，就他说的非常流畅，也很清楚，而且甚至似乎还有点好听。</p>]]></content>
      
      
      <categories>
          
          <category> Study Blogs </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 日记 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Docker 概览 &amp; Docker 命令总结</title>
      <link href="/blogs/2025/04/17/Docker%20%E6%A6%82%E8%A7%88%20&amp;%20Docker%20%E5%91%BD%E4%BB%A4%E6%80%BB%E7%BB%93/"/>
      <url>/blogs/2025/04/17/Docker%20%E6%A6%82%E8%A7%88%20&amp;%20Docker%20%E5%91%BD%E4%BB%A4%E6%80%BB%E7%BB%93/</url>
      
        <content type="html"><![CDATA[<h2 id="Docker-概览-Docker-命令总结">Docker 概览 &amp; Docker 命令总结</h2><hr><h3 id="一、Docker-基础概念与原理">一、Docker 基础概念与原理</h3><h4 id="什么是-Docker？">什么是 Docker？</h4><p>Docker 是一个开源的容器平台，用于打包、分发和运行应用程序及其所有依赖项。</p><ul><li>把应用、运行环境、依赖打包成一个“镜像”</li><li>运行镜像就生成一个“容器”，容器彼此隔离，不影响宿主机</li></ul><h4 id="核心概念：">核心概念：</h4><table><thead><tr><th>名称</th><th>说明</th></tr></thead><tbody><tr><td>镜像 Image</td><td>应用 + 环境的静态模板</td></tr><tr><td>容器 Container</td><td>镜像的运行实例</td></tr><tr><td>Dockerfile</td><td>描述如何构建镜像的脚本</td></tr><tr><td>Registry</td><td>镜像仓库，例如 Docker Hub</td></tr></tbody></table><h4 id="Docker-工作原理（Linux-容器机制）">Docker 工作原理（Linux 容器机制）</h4><ul><li>利用 Linux 的 namespace（隔离）和 cgroups（资源限制）实现</li><li>容器共享宿主机内核，但拥有独立文件系统、网络、进程空间</li><li>启动速度极快，资源占用小</li></ul><hr><h3 id="二、Docker-镜像构建机制与实践">二、Docker 镜像构建机制与实践</h3><h4 id="镜像是分层构建的">镜像是分层构建的</h4><ul><li>每个 Dockerfile 指令都会生成一个只读的文件系统层</li><li>构建时 Docker 利用缓存提升效率</li></ul><h4 id="Dockerfile-最佳实践">Dockerfile 最佳实践</h4><ul><li>变动少的层放在前面，提高缓存命中率</li><li>合并多个 RUN 语句，减少层数</li><li>使用 <code>.dockerignore</code> 文件避免将无用文件打包进镜像</li><li>使用轻量基础镜像（如 alpine）减小体积</li></ul><h4 id="示例-Dockerfile">示例 Dockerfile</h4><figure class="highlight dockerfile"><table><tr><td class="code"><pre><code class="hljs Dockerfile"><span class="hljs-keyword">FROM</span> python:<span class="hljs-number">3.11</span>-slim<br><span class="hljs-keyword">WORKDIR</span><span class="language-bash"> /app</span><br><span class="hljs-keyword">COPY</span><span class="language-bash"> requirements.txt .</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> pip install -r requirements.txt</span><br><span class="hljs-keyword">COPY</span><span class="language-bash"> . .</span><br><span class="hljs-keyword">CMD</span><span class="language-bash"> [<span class="hljs-string">&quot;python&quot;</span>, <span class="hljs-string">&quot;main.py&quot;</span>]</span><br></code></pre></td></tr></table></figure><h4 id="dockerignore-示例">.dockerignore 示例</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">__pycache__/<br>.git<br>.env<br>*.log<br>node_modules/<br></code></pre></td></tr></table></figure><hr><h3 id="三、Docker-Compose">三、Docker Compose</h3><h4 id="Docker-Compose-是什么？">Docker Compose 是什么？</h4><ul><li>定义和运行多容器服务的工具（使用 docker-compose.yml）</li></ul><h4 id="示例">示例</h4><figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">&#x27;3.8&#x27;</span><br><span class="hljs-attr">services:</span><br>  <span class="hljs-attr">backend:</span><br>    <span class="hljs-attr">build:</span> <span class="hljs-string">./backend</span><br>    <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">./test_files:/app/test_files</span><br>  <span class="hljs-attr">redis:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">redis:7</span><br></code></pre></td></tr></table></figure><p>运行：</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">docker-compose up --build<br>docker-compose down<br></code></pre></td></tr></table></figure><hr><h3 id="四、Docker-常用命令">四、Docker 常用命令</h3><h4 id="镜像操作">镜像操作</h4><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">docker build -t my-image .<br>docker images<br>docker rmi image-id<br>docker pull image-name<br>docker tag <span class="hljs-built_in">source</span> target<br></code></pre></td></tr></table></figure><h4 id="容器操作">容器操作</h4><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">docker run image<br>docker run -it image bash<br>docker run --<span class="hljs-built_in">rm</span> image<br>docker run -v $(<span class="hljs-built_in">pwd</span>):/app image<br>docker run -p 8080:80 image<br>docker ps<br>docker ps -a<br>docker stop container-id<br>docker <span class="hljs-built_in">rm</span> container-id<br>docker <span class="hljs-built_in">exec</span> -it container-id bash<br></code></pre></td></tr></table></figure><h4 id="容器调试">容器调试</h4><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">docker logs container-id<br>docker <span class="hljs-built_in">cp</span> file.txt container:/path<br>docker <span class="hljs-built_in">cp</span> container:/path/file.txt ./<br>docker inspect container-id<br></code></pre></td></tr></table></figure><h4 id="清理命令">清理命令</h4><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">docker system prune<br>docker image prune<br>docker container prune<br>docker volume prune<br></code></pre></td></tr></table></figure><h4 id="资源限制示例">资源限制示例</h4><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">docker run --memory=512m --cpus=1 image<br></code></pre></td></tr></table></figure><hr><h3 id="五、Docker-的使用场景与优势">五、Docker 的使用场景与优势</h3><h4 id="适用场景">适用场景</h4><ul><li>团队统一开发环境</li><li>CI/CD 流程打包构建测试</li><li>微服务部署</li><li>数据科学/AI 项目环境隔离</li></ul><h4 id="相比虚拟机的优势">相比虚拟机的优势</h4><table><thead><tr><th>项目</th><th>Docker 容器</th><th>虚拟机</th></tr></thead><tbody><tr><td>启动速度</td><td>秒级</td><td>分钟级</td></tr><tr><td>占用资源</td><td>少（共享宿主机内核）</td><td>多（完整系统）</td></tr><tr><td>隔离性</td><td>中（内核级）</td><td>高（硬件级）</td></tr><tr><td>可移植性</td><td>高</td><td>一般</td></tr><tr><td>性能</td><td>几乎无损</td><td>有虚拟化开销</td></tr></tbody></table><hr><h3 id="六、实际开发中的-Docker-工作流">六、实际开发中的 Docker 工作流</h3><ol><li>编写 Dockerfile 定义环境和入口</li><li>使用 <code>docker build</code> 构建镜像</li><li>使用 <code>docker run</code> 启动镜像成为容器</li><li>容器内运行程序，无需本地配置依赖</li><li>可通过 <code>docker push</code> 发布镜像</li><li>与 CI/CD 工具（如 GitHub Actions）结合，形成自动化部署</li></ol><hr><p>如需进一步扩展，可了解多阶段构建、Docker 网络、Volume 数据持久化、Docker 安全与最佳实践等内容。</p>]]></content>
      
      
      <categories>
          
          <category> Tech Blogs </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Tools </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Coding Diary(2025-4-14)</title>
      <link href="/blogs/2025/04/14/Coding%20Diary(2025-4-14)/"/>
      <url>/blogs/2025/04/14/Coding%20Diary(2025-4-14)/</url>
      
        <content type="html"><![CDATA[<p>今天打算开始熟悉 SGLang，配置环境的过程果然出现问题了，就先记录一下。</p><p>Install from the source 的最后一步：</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">(sglang-dev) zhengbowen@MacBookPro sglang % pip install -e <span class="hljs-string">&quot;python[all]&quot;</span> --find-links https://flashinfer.ai/whl/cu124/torch2.5/flashinfer-python<br></code></pre></td></tr></table></figure><p>出现了问题。</p><p>报错如下：</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">INFO: pip is looking at multiple versions of sglang[srt] to determine <span class="hljs-built_in">which</span> version is compatible with other requirements. This could take a <span class="hljs-keyword">while</span>.<br>ERROR: Could not find a version that satisfies the requirement sgl-kernel==0.0.8.post3; extra == <span class="hljs-string">&quot;srt&quot;</span> (from sglang[srt]) (from versions: 0.0.1)<br>ERROR: No matching distribution found <span class="hljs-keyword">for</span> sgl-kernel==0.0.8.post3; extra == <span class="hljs-string">&quot;srt&quot;</span><br></code></pre></td></tr></table></figure><p>问了 GPT，GPT 表示这是因为这个版本在 PyPI 上根本没有，这个是关于 <code>sgl-kernel</code> 的部分，后面 GPT 又建议我直接去 <code>sgl-kernel</code> 内去安装。</p><p>但是我进去之后安装依赖还是会报错，感觉主要的原因还是我用的是 Mac，没有 GPU，所以 <code>sgl-kernel</code> 这部分就会有问题。</p><p>不过 GPT 还说我可以只安装需要的，不安装 <code>sgl-kernal</code> 相关的依赖，还没试，因为读到后面发现推荐我这样的新手从文档入手，就打算先去看看文档了。</p>]]></content>
      
      
      <categories>
          
          <category> Coding Blogs </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 日记 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Git 命令总结</title>
      <link href="/blogs/2025/04/10/Git%20%E5%91%BD%E4%BB%A4%E6%80%BB%E7%BB%93/"/>
      <url>/blogs/2025/04/10/Git%20%E5%91%BD%E4%BB%A4%E6%80%BB%E7%BB%93/</url>
      
        <content type="html"><![CDATA[<h1>Detail</h1><h2 id="同步-fork-与原始仓库（Upstream）">同步 fork 与原始仓库（Upstream）</h2><h3 id="第一次配置-upstream">第一次配置 upstream</h3><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">git remote add upstream https://github.com/original-user/original-repo.git<br></code></pre></td></tr></table></figure><blockquote><p>给 fork 的仓库添加原始仓库作为 <code>upstream</code></p></blockquote><h3 id="每次同步更新流程">每次同步更新流程</h3><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">git fetch upstream              <span class="hljs-comment"># 拉取原始仓库更新</span><br>git checkout main               <span class="hljs-comment"># 切换到 main 分支</span><br>git merge upstream/main         <span class="hljs-comment"># 合并 upstream 的 main 到本地 main</span><br>git push origin main            <span class="hljs-comment"># 推送更新后的 main 到 GitHub fork</span><br></code></pre></td></tr></table></figure><blockquote><p>用于保持 fork 与原始仓库同步</p></blockquote><h3 id="查看所有远程仓库">查看所有远程仓库</h3><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">git remote -v<br></code></pre></td></tr></table></figure><blockquote><p>显示当前配置的远程仓库地址，包括 <code>origin</code> 和 <code>upstream</code></p></blockquote><hr><h2 id="合并-main-到某个分支">合并 main 到某个分支</h2><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">git checkout feature-x          <span class="hljs-comment"># 切换到目标分支</span><br>git merge main                  <span class="hljs-comment"># 把 main 的更新合并进来</span><br></code></pre></td></tr></table></figure><blockquote><p>建议先更新 main（<code>git checkout main &amp;&amp; git pull</code>）后再执行，以确保最新</p></blockquote><hr><h2 id="从某个分支合并回-main">从某个分支合并回 main</h2><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">git checkout main               <span class="hljs-comment"># 切到 main 分支</span><br>git merge feature-x             <span class="hljs-comment"># 合并 feature-x 分支</span><br></code></pre></td></tr></table></figure><blockquote><p>若 feature-x 和其他分支有改动重叠，建议先 <code>git merge main</code> 到 feature-x 中，提前解决冲突</p></blockquote><hr><h2 id="删除分支（本地-远程）">删除分支（本地 &amp; 远程）</h2><h3 id="删除本地分支">删除本地分支</h3><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">git branch -d branch-name       <span class="hljs-comment"># 安全删除（分支已 merge）</span><br>git branch -D branch-name       <span class="hljs-comment"># 强制删除（未 merge）</span><br></code></pre></td></tr></table></figure><blockquote><p>注意：不能删除当前所在的分支，要先切换到其他分支</p></blockquote><h3 id="删除远程分支">删除远程分支</h3><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">git push origin --delete branch-name<br></code></pre></td></tr></table></figure><blockquote><p>正确格式是分支名，不是 <code>origin/branch-name</code></p></blockquote><hr><h1>总结命令速查表</h1><table><thead><tr><th>操作</th><th>命令</th></tr></thead><tbody><tr><td>添加 upstream</td><td><code>git remote add upstream URL</code></td></tr><tr><td>获取原始仓库更新</td><td><code>git fetch upstream</code></td></tr><tr><td>合并 upstream/main 到本地 main</td><td><code>git merge upstream/main</code></td></tr><tr><td>推送更新后的 main</td><td><code>git push origin main</code></td></tr><tr><td>合并 main 到某分支</td><td><code>git checkout branch &amp;&amp; git merge main</code></td></tr><tr><td>合并某分支到 main</td><td><code>git checkout main &amp;&amp; git merge branch</code></td></tr><tr><td>删除本地分支（安全/强制）</td><td><code>git branch -d name</code> / <code>git branch -D name</code></td></tr><tr><td>删除远程分支</td><td><code>git push origin --delete name</code></td></tr><tr><td>查看所有远程分支</td><td><code>git branch -r</code></td></tr><tr><td>查看远程仓库</td><td><code>git remote -v</code></td></tr><tr><td>查看当前用的是哪个 pip/python</td><td><code>which pip</code> / <code>which python</code></td></tr></tbody></table>]]></content>
      
      
      <categories>
          
          <category> Tech Blogs </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Tools </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Transformer</title>
      <link href="/blogs/2025/04/09/Transformer/"/>
      <url>/blogs/2025/04/09/Transformer/</url>
      
        <content type="html"><![CDATA[<p>本篇blog讲了transformer里的几个比较重要的概念，attention，multi-head attention， self-attention &amp; cross-attention 以及 encoder &amp; decoder。</p><ul><li>单头Attention最经典公式：</li></ul><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>Attention</mtext><mo stretchy="false">(</mo><mi>Q</mi><mo separator="true">,</mo><mi>K</mi><mo separator="true">,</mo><mi>V</mi><mo stretchy="false">)</mo><mo>=</mo><mtext>softmax</mtext><mrow><mo fence="true">(</mo><mfrac><mrow><mi>Q</mi><msup><mi>K</mi><mi>T</mi></msup></mrow><msqrt><msub><mi>d</mi><mi>k</mi></msub></msqrt></mfrac><mo fence="true">)</mo></mrow><mi>V</mi></mrow><annotation encoding="application/x-tex">\text{Attention}(Q, K, V) = \text{softmax}\left(\frac{QK^T}{\sqrt{d_k}}\right)V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Attention</span></span><span class="mopen">(</span><span class="mord mathnormal">Q</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4684em;vertical-align:-0.95em;"></span><span class="mord text"><span class="mord">softmax</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.5183em;"><span style="top:-2.2528em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8572em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.8172em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewBox="0 0 400000 1080" preserveAspectRatio="xMinYMin slice"><path d="M95,702c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429c69,-144,104.5,-217.7,106.5,-221l0 -0c5.3,-9.3,12,-14,20,-14H400000v40H845.2724s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47zM834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1828em;"><span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">Q</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.93em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">)</span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span></span></p><ul><li>多头Attention（Transformer中常用）：</li></ul><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>MultiHead</mtext><mo stretchy="false">(</mo><mi>Q</mi><mo separator="true">,</mo><mi>K</mi><mo separator="true">,</mo><mi>V</mi><mo stretchy="false">)</mo><mo>=</mo><mtext>Concat</mtext><msubsup><mrow><mo fence="true">(</mo><mtext>softmax</mtext><mrow><mo fence="true">(</mo><mfrac><mrow><mi>Q</mi><msubsup><mi>W</mi><mi>i</mi><mi>Q</mi></msubsup><mo stretchy="false">(</mo><mi>K</mi><msubsup><mi>W</mi><mi>i</mi><mi>K</mi></msubsup><msup><mo stretchy="false">)</mo><mi>T</mi></msup></mrow><msqrt><msub><mi>d</mi><mi>k</mi></msub></msqrt></mfrac><mo fence="true">)</mo></mrow><mi>V</mi><msubsup><mi>W</mi><mi>i</mi><mi>V</mi></msubsup><mo fence="true">)</mo></mrow><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>h</mi></msubsup><msup><mi>W</mi><mi>O</mi></msup></mrow><annotation encoding="application/x-tex">\text{MultiHead}(Q,K,V) = \text{Concat}\left(\text{softmax}\left(\frac{QW_i^Q(KW_i^K)^T}{\sqrt{d_k}}\right)VW_i^V\right)_{i=1}^{h} W^O</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">MultiHead</span></span><span class="mopen">(</span><span class="mord mathnormal">Q</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3.2887em;vertical-align:-1.2997em;"></span><span class="mord text"><span class="mord">Concat</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">(</span></span><span class="mord text"><span class="mord">softmax</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6362em;"><span style="top:-2.2528em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8572em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.8172em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewBox="0 0 400000 1080" preserveAspectRatio="xMinYMin slice"><path d="M95,702c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429c69,-144,104.5,-217.7,106.5,-221l0 -0c5.3,-9.3,12,-14,20,-14H400000v40H845.2724s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47zM834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1828em;"><span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">Q</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9592em;"><span style="top:-2.4231em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.1809em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">Q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2769em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-2.4413em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2587em;"><span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.93em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size4">)</span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-2.453em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">V</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size4">)</span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.989em;"><span style="top:-1.4003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-4.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">h</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2997em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">O</span></span></span></span></span></span></span></span></span></span></span></span></p><h1>Attention</h1><p>Transformer 模型中的 <strong>Attention 机制</strong> 是其核心组成部分，主要用于捕捉输入序列中不同位置之间的依赖关系。Attention 的计算过程可以分为以下几个步骤：</p><hr><h2 id="1-输入表示">1. 输入表示</h2><p>假设我们有一个输入序列 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi><mo>=</mo><mo stretchy="false">[</mo><msub><mi>x</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>x</mi><mn>2</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>x</mi><mi>n</mi></msub><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">X = [x_1, x_2, \dots, x_n]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">]</span></span></span></span>，其中每个 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">x_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 是一个 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi></mrow><annotation encoding="application/x-tex">d</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">d</span></span></span></span>-维向量（例如词嵌入）。输入序列可以表示为矩阵：</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>X</mi><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>n</mi><mo>×</mo><mi>d</mi></mrow></msup></mrow><annotation encoding="application/x-tex">X \in \mathbb{R}^{n \times d}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7224em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8991em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8991em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">×</span><span class="mord mathnormal mtight">d</span></span></span></span></span></span></span></span></span></span></span></span></span></p><p>其中 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span> 是序列长度，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi></mrow><annotation encoding="application/x-tex">d</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">d</span></span></span></span> 是每个向量的维度。</p><hr><h2 id="2-线性变换">2. 线性变换</h2><p>首先，通过线性变换将输入 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi></mrow><annotation encoding="application/x-tex">X</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span> 映射到三个不同的空间：</p><ul><li><strong>Query (Q)</strong>：用于查询其他位置的信息。</li><li><strong>Key (K)</strong>：用于被其他位置查询。</li><li><strong>Value (V)</strong>：包含实际的信息。</li></ul><p>具体计算如下：</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>Q</mi><mo>=</mo><mi>X</mi><msub><mi>W</mi><mi>Q</mi></msub><mo separator="true">,</mo><mspace width="1em"/><mi>K</mi><mo>=</mo><mi>X</mi><msub><mi>W</mi><mi>K</mi></msub><mo separator="true">,</mo><mspace width="1em"/><mi>V</mi><mo>=</mo><mi>X</mi><msub><mi>W</mi><mi>V</mi></msub></mrow><annotation encoding="application/x-tex">Q = XW_Q, \quad K = XW_K, \quad V = XW_V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">Q</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">Q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:1em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:1em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">V</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></p><p>其中：</p><ul><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mi>Q</mi></msub><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>d</mi><mo>×</mo><msub><mi>d</mi><mi>k</mi></msub></mrow></msup></mrow><annotation encoding="application/x-tex">W_Q \in \mathbb{R}^{d \times d_k}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">Q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8491em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mbin mtight">×</span><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>、<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mi>K</mi></msub><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>d</mi><mo>×</mo><msub><mi>d</mi><mi>k</mi></msub></mrow></msup></mrow><annotation encoding="application/x-tex">W_K \in \mathbb{R}^{d \times d_k}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8491em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mbin mtight">×</span><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>、<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mi>V</mi></msub><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>d</mi><mo>×</mo><msub><mi>d</mi><mi>v</mi></msub></mrow></msup></mrow><annotation encoding="application/x-tex">W_V \in \mathbb{R}^{d \times d_v}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">V</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8491em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mbin mtight">×</span><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1645em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> 是可学习的权重矩阵。</li><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">d_k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">d_v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 分别是 Query/Key 和 Value 的维度（通常 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mi>k</mi></msub><mo>=</mo><msub><mi>d</mi><mi>v</mi></msub><mo>=</mo><mi>d</mi></mrow><annotation encoding="application/x-tex">d_k = d_v = d</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">d</span></span></span></span>）。</li></ul><hr><h2 id="3-计算-Attention-分数">3. 计算 Attention 分数</h2><p>Attention 分数表示序列中每个位置对其他位置的重要性。通过计算 Query 和 Key 的点积来得到：</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>Attention Scores</mtext><mo>=</mo><mi>Q</mi><msup><mi>K</mi><mi>T</mi></msup></mrow><annotation encoding="application/x-tex">\text{Attention Scores} = QK^T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord text"><span class="mord">Attention Scores</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0858em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">Q</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span></span></p><p>其中：</p><ul><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>n</mi><mo>×</mo><msub><mi>d</mi><mi>k</mi></msub></mrow></msup></mrow><annotation encoding="application/x-tex">Q \in \mathbb{R}^{n \times d_k}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">Q</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8491em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">×</span><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>n</mi><mo>×</mo><msub><mi>d</mi><mi>k</mi></msub></mrow></msup></mrow><annotation encoding="application/x-tex">K \in \mathbb{R}^{n \times d_k}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7224em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8491em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">×</span><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>，因此 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi><msup><mi>K</mi><mi>T</mi></msup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>n</mi><mo>×</mo><mi>n</mi></mrow></msup></mrow><annotation encoding="application/x-tex">QK^T \in \mathbb{R}^{n \times n}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0358em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">Q</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7713em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7713em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">×</span><span class="mord mathnormal mtight">n</span></span></span></span></span></span></span></span></span></span></span></span>。</li><li>每个元素 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>Q</mi><msup><mi>K</mi><mi>T</mi></msup><msub><mo stretchy="false">)</mo><mrow><mi>i</mi><mi>j</mi></mrow></msub></mrow><annotation encoding="application/x-tex">(QK^T)_{ij}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1274em;vertical-align:-0.2861em;"></span><span class="mopen">(</span><span class="mord mathnormal">Q</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span> 表示第 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> 个位置的 Query 与第 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi></mrow><annotation encoding="application/x-tex">j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span> 个位置的 Key 的相似度。</li></ul><hr><h2 id="4-缩放和-Softmax">4. 缩放和 Softmax</h2><p>为了稳定梯度，通常会对 Attention 分数进行缩放（Scaled Dot-Product Attention）：</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>Scaled Attention Scores</mtext><mo>=</mo><mfrac><mrow><mi>Q</mi><msup><mi>K</mi><mi>T</mi></msup></mrow><msqrt><msub><mi>d</mi><mi>k</mi></msub></msqrt></mfrac></mrow><annotation encoding="application/x-tex">\text{Scaled Attention Scores} = \frac{QK^T}{\sqrt{d_k}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord text"><span class="mord">Scaled Attention Scores</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4483em;vertical-align:-0.93em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.5183em;"><span style="top:-2.2528em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8572em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.8172em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewBox="0 0 400000 1080" preserveAspectRatio="xMinYMin slice"><path d="M95,702c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429c69,-144,104.5,-217.7,106.5,-221l0 -0c5.3,-9.3,12,-14,20,-14H400000v40H845.2724s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47zM834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1828em;"><span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">Q</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.93em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p><p>然后通过 Softmax 函数将分数转换为概率分布：</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>Attention Weights</mtext><mo>=</mo><mtext>Softmax</mtext><mrow><mo fence="true">(</mo><mfrac><mrow><mi>Q</mi><msup><mi>K</mi><mi>T</mi></msup></mrow><msqrt><msub><mi>d</mi><mi>k</mi></msub></msqrt></mfrac><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">\text{Attention Weights} = \text{Softmax}\left(\frac{QK^T}{\sqrt{d_k}}\right)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord">Attention Weights</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4684em;vertical-align:-0.95em;"></span><span class="mord text"><span class="mord">Softmax</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.5183em;"><span style="top:-2.2528em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8572em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.8172em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewBox="0 0 400000 1080" preserveAspectRatio="xMinYMin slice"><path d="M95,702c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429c69,-144,104.5,-217.7,106.5,-221l0 -0c5.3,-9.3,12,-14,20,-14H400000v40H845.2724s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47zM834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1828em;"><span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">Q</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.93em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">)</span></span></span></span></span></span></span></p><p>其中：</p><ul><li>Softmax 确保每个位置的权重和为 1。</li><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msqrt><msub><mi>d</mi><mi>k</mi></msub></msqrt></mrow><annotation encoding="application/x-tex">\sqrt{d_k}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.04em;vertical-align:-0.1828em;"></span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8572em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.8172em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewBox="0 0 400000 1080" preserveAspectRatio="xMinYMin slice"><path d="M95,702c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429c69,-144,104.5,-217.7,106.5,-221l0 -0c5.3,-9.3,12,-14,20,-14H400000v40H845.2724s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47zM834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1828em;"><span></span></span></span></span></span></span></span></span> 是缩放因子，用于防止点积值过大导致梯度消失。</li></ul><hr><h2 id="5-加权求和">5. 加权求和</h2><p>使用 Attention 权重对 Value 进行加权求和，得到每个位置的输出：</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>Output</mtext><mo>=</mo><mtext>Attention Weights</mtext><mo>⋅</mo><mi>V</mi></mrow><annotation encoding="application/x-tex">\text{Output} = \text{Attention Weights} \cdot V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord">Output</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord">Attention Weights</span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span></span></p><p>其中：</p><ul><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>n</mi><mo>×</mo><msub><mi>d</mi><mi>v</mi></msub></mrow></msup></mrow><annotation encoding="application/x-tex">V \in \mathbb{R}^{n \times d_v}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7224em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8491em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">×</span><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1645em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>，因此输出 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>Output</mtext><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>n</mi><mo>×</mo><msub><mi>d</mi><mi>v</mi></msub></mrow></msup></mrow><annotation encoding="application/x-tex">\text{Output} \in \mathbb{R}^{n \times d_v}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord">Output</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8491em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">×</span><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1645em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>。</li></ul><hr><h2 id="6-详细例子">6. 详细例子</h2><p>假设我们有一个输入序列 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi></mrow><annotation encoding="application/x-tex">X</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span> 包含 2 个词，每个词的嵌入维度 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mo>=</mo><mn>4</mn></mrow><annotation encoding="application/x-tex">d = 4</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">4</span></span></span></span>：</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>X</mi><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>2</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>3</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>4</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>4</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>3</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>2</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">X = \begin{bmatrix}1 &amp; 2 &amp; 3 &amp; 4 \\4 &amp; 3 &amp; 2 &amp; 1\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">4</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">3</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">4</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span></span></span></span></span></p><p>假设 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mi>Q</mi></msub></mrow><annotation encoding="application/x-tex">W_Q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">Q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span>、<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mi>K</mi></msub></mrow><annotation encoding="application/x-tex">W_K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>、<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mi>V</mi></msub></mrow><annotation encoding="application/x-tex">W_V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">V</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 分别为：</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>W</mi><mi>Q</mi></msub><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo separator="true">,</mo><mspace width="1em"/><msub><mi>W</mi><mi>K</mi></msub><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo separator="true">,</mo><mspace width="1em"/><msub><mi>W</mi><mi>V</mi></msub><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">W_Q = \begin{bmatrix}1 &amp; 0 \\0 &amp; 1 \\0 &amp; 0 \\0 &amp; 0\end{bmatrix}, \quadW_K = \begin{bmatrix}0 &amp; 1 \\1 &amp; 0 \\0 &amp; 0 \\0 &amp; 0\end{bmatrix}, \quadW_V = \begin{bmatrix}1 &amp; 0 \\0 &amp; 1 \\0 &amp; 0 \\0 &amp; 0\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">Q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:4.8em;vertical-align:-2.15em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em;"><span style="top:-4.65em;"><span class="pstrut" style="height:6.8em;"></span><span style="width:0.667em;height:4.800em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="4.800em" viewBox="0 0 667 4800"><path d="M403 1759 V84 H666 V0 H319 V1759 v1200 v1759 h347 v-84H403z M403 1759 V0 H319 V1759 v1200 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em;"><span style="top:-4.81em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em;"><span style="top:-4.81em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em;"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em;"><span style="top:-4.65em;"><span class="pstrut" style="height:6.8em;"></span><span style="width:0.667em;height:4.800em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="4.800em" viewBox="0 0 667 4800"><path d="M347 1759 V0 H0 V84 H263 V1759 v1200 v1759 H0 v84 H347zM347 1759 V0 H263 V1759 v1200 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em;"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:1em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:4.8em;vertical-align:-2.15em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em;"><span style="top:-4.65em;"><span class="pstrut" style="height:6.8em;"></span><span style="width:0.667em;height:4.800em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="4.800em" viewBox="0 0 667 4800"><path d="M403 1759 V84 H666 V0 H319 V1759 v1200 v1759 h347 v-84H403z M403 1759 V0 H319 V1759 v1200 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em;"><span style="top:-4.81em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em;"><span style="top:-4.81em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em;"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em;"><span style="top:-4.65em;"><span class="pstrut" style="height:6.8em;"></span><span style="width:0.667em;height:4.800em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="4.800em" viewBox="0 0 667 4800"><path d="M347 1759 V0 H0 V84 H263 V1759 v1200 v1759 H0 v84 H347zM347 1759 V0 H263 V1759 v1200 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em;"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:1em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">V</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:4.8em;vertical-align:-2.15em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em;"><span style="top:-4.65em;"><span class="pstrut" style="height:6.8em;"></span><span style="width:0.667em;height:4.800em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="4.800em" viewBox="0 0 667 4800"><path d="M403 1759 V84 H666 V0 H319 V1759 v1200 v1759 h347 v-84H403z M403 1759 V0 H319 V1759 v1200 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em;"><span style="top:-4.81em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em;"><span style="top:-4.81em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em;"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em;"><span style="top:-4.65em;"><span class="pstrut" style="height:6.8em;"></span><span style="width:0.667em;height:4.800em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="4.800em" viewBox="0 0 667 4800"><path d="M347 1759 V0 H0 V84 H263 V1759 v1200 v1759 H0 v84 H347zM347 1759 V0 H263 V1759 v1200 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em;"><span></span></span></span></span></span></span></span></span></span></span></span></p><h3 id="1-计算-Q、K、V">1. 计算 Q、K、V</h3><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>Q</mi><mo>=</mo><mi>X</mi><msub><mi>W</mi><mi>Q</mi></msub><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>2</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>4</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>3</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo separator="true">,</mo><mspace width="1em"/><mi>K</mi><mo>=</mo><mi>X</mi><msub><mi>W</mi><mi>K</mi></msub><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>2</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>3</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>4</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo separator="true">,</mo><mspace width="1em"/><mi>V</mi><mo>=</mo><mi>X</mi><msub><mi>W</mi><mi>V</mi></msub><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>2</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>4</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>3</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">Q = XW_Q = \begin{bmatrix}1 &amp; 2 \\4 &amp; 3\end{bmatrix}, \quadK = XW_K = \begin{bmatrix}2 &amp; 1 \\3 &amp; 4\end{bmatrix}, \quadV = XW_V = \begin{bmatrix}1 &amp; 2 \\4 &amp; 3\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">Q</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">Q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">4</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:1em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">4</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:1em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">V</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">4</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span></span></span></span></span></p><h3 id="2-计算-Attention-分数">2. 计算 Attention 分数</h3><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>Q</mi><msup><mi>K</mi><mi>T</mi></msup><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>2</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>4</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>3</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>2</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>3</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>4</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>4</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>11</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>11</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>24</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">QK^T = \begin{bmatrix}1 &amp; 2 \\4 &amp; 3\end{bmatrix}\begin{bmatrix}2 &amp; 3 \\1 &amp; 4\end{bmatrix}= \begin{bmatrix}4 &amp; 11 \\11 &amp; 24\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0858em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">Q</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">4</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">3</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">4</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">4</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">11</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">11</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">24</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span></span></span></span></span></p><h3 id="3-缩放和-Softmax">3. 缩放和 Softmax</h3><p>假设 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mi>k</mi></msub><mo>=</mo><mn>2</mn></mrow><annotation encoding="application/x-tex">d_k = 2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">2</span></span></span></span>，缩放后：</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mfrac><mrow><mi>Q</mi><msup><mi>K</mi><mi>T</mi></msup></mrow><msqrt><mn>2</mn></msqrt></mfrac><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>2.828</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>7.778</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>7.778</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>16.971</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">\frac{QK^T}{\sqrt{2}} = \begin{bmatrix}2.828 &amp; 7.778 \\7.778 &amp; 16.971\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.4483em;vertical-align:-0.93em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.5183em;"><span style="top:-2.2028em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9072em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord">2</span></span></span><span style="top:-2.8672em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewBox="0 0 400000 1080" preserveAspectRatio="xMinYMin slice"><path d="M95,702c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429c69,-144,104.5,-217.7,106.5,-221l0 -0c5.3,-9.3,12,-14,20,-14H400000v40H845.2724s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47zM834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1328em;"><span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">Q</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.93em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2.828</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">7.778</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">7.778</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">16.971</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span></span></span></span></span></p><p>Softmax 后：</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>Attention Weights</mtext><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0.016</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0.984</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0.000</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1.000</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">\text{Attention Weights} = \begin{bmatrix}0.016 &amp; 0.984 \\0.000 &amp; 1.000\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord">Attention Weights</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0.016</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0.000</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0.984</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1.000</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span></span></span></span></span></p><h3 id="4-加权求和">4. 加权求和</h3><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>Output</mtext><mo>=</mo><mtext>Attention Weights</mtext><mo>⋅</mo><mi>V</mi><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0.016</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0.984</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0.000</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1.000</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>2</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>4</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>3</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>3.952</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>2.984</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>4.000</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>3.000</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">\text{Output} = \text{Attention Weights} \cdot V = \begin{bmatrix}0.016 &amp; 0.984 \\0.000 &amp; 1.000\end{bmatrix}\begin{bmatrix}1 &amp; 2 \\4 &amp; 3\end{bmatrix}= \begin{bmatrix}3.952 &amp; 2.984 \\4.000 &amp; 3.000\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord">Output</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord">Attention Weights</span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0.016</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0.000</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0.984</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1.000</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">4</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">3.952</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">4.000</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2.984</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">3.000</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span></span></span></span></span></p><hr><h2 id="7-总结">7. 总结</h2><ul><li>Attention 的核心是计算 Query、Key 和 Value 之间的关系。</li><li>通过点积、缩放、Softmax 和加权求和，得到每个位置的输出。</li><li>多头 Attention 可以捕捉不同子空间的信息。</li></ul><h1>Multi-Head Attention</h1><p>Transformer 模型中的 <strong>Multi-Head Attention（多头注意力机制）</strong> 是其核心组成部分之一。它通过并行计算多个注意力头（Attention Heads），捕捉输入序列中不同子空间的信息，从而增强模型的表达能力。以下是多头注意力机制的具体实现步骤和详细例子。</p><hr><h2 id="1-多头注意力的核心思想">1. 多头注意力的核心思想</h2><ul><li><strong>单头注意力</strong>：计算一组 Query、Key 和 Value，得到一个注意力输出。</li><li><strong>多头注意力</strong>：将 Query、Key 和 Value 拆分为多个头，每个头独立计算注意力，最后将多个头的输出拼接起来。</li></ul><hr><h2 id="2-多头注意力的实现步骤">2. 多头注意力的实现步骤</h2><h3 id="1-输入表示-2">1. 输入表示</h3><p>假设输入序列 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi></mrow><annotation encoding="application/x-tex">X</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span> 是一个矩阵：</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>X</mi><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>n</mi><mo>×</mo><mi>d</mi></mrow></msup></mrow><annotation encoding="application/x-tex">X \in \mathbb{R}^{n \times d}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7224em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8991em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8991em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">×</span><span class="mord mathnormal mtight">d</span></span></span></span></span></span></span></span></span></span></span></span></span></p><p>其中：</p><ul><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span> 是序列长度。</li><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi></mrow><annotation encoding="application/x-tex">d</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">d</span></span></span></span> 是每个向量的维度。</li></ul><h3 id="2-线性变换-2">2. 线性变换</h3><p>将输入 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi></mrow><annotation encoding="application/x-tex">X</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span> 通过线性变换映射到 Query、Key 和 Value：</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>Q</mi><mo>=</mo><mi>X</mi><msub><mi>W</mi><mi>Q</mi></msub><mo separator="true">,</mo><mspace width="1em"/><mi>K</mi><mo>=</mo><mi>X</mi><msub><mi>W</mi><mi>K</mi></msub><mo separator="true">,</mo><mspace width="1em"/><mi>V</mi><mo>=</mo><mi>X</mi><msub><mi>W</mi><mi>V</mi></msub></mrow><annotation encoding="application/x-tex">Q = XW_Q, \quad K = XW_K, \quad V = XW_V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">Q</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">Q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:1em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:1em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">V</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></p><p>其中：</p><ul><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mi>Q</mi></msub><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>d</mi><mo>×</mo><msub><mi>d</mi><mi>k</mi></msub></mrow></msup></mrow><annotation encoding="application/x-tex">W_Q \in \mathbb{R}^{d \times d_k}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">Q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8491em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mbin mtight">×</span><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>、<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mi>K</mi></msub><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>d</mi><mo>×</mo><msub><mi>d</mi><mi>k</mi></msub></mrow></msup></mrow><annotation encoding="application/x-tex">W_K \in \mathbb{R}^{d \times d_k}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8491em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mbin mtight">×</span><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>、<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mi>V</mi></msub><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>d</mi><mo>×</mo><msub><mi>d</mi><mi>v</mi></msub></mrow></msup></mrow><annotation encoding="application/x-tex">W_V \in \mathbb{R}^{d \times d_v}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">V</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8491em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mbin mtight">×</span><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1645em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> 是可学习的权重矩阵。</li><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">d_k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">d_v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 分别是 Query/Key 和 Value 的维度（通常 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mi>k</mi></msub><mo>=</mo><msub><mi>d</mi><mi>v</mi></msub><mo>=</mo><mi>d</mi></mrow><annotation encoding="application/x-tex">d_k = d_v = d</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">d</span></span></span></span>）。</li></ul><h3 id="3-拆分多头">3. 拆分多头</h3><p>将 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi></mrow><annotation encoding="application/x-tex">Q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">Q</span></span></span></span>、<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span>、<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi></mrow><annotation encoding="application/x-tex">V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span> 拆分为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi></mrow><annotation encoding="application/x-tex">h</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">h</span></span></span></span> 个头（例如 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi><mo>=</mo><mn>8</mn></mrow><annotation encoding="application/x-tex">h = 8</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">h</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">8</span></span></span></span>）。假设 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mi>k</mi></msub><mo>=</mo><msub><mi>d</mi><mi>v</mi></msub><mo>=</mo><mi>d</mi></mrow><annotation encoding="application/x-tex">d_k = d_v = d</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">d</span></span></span></span>，则每个头的维度为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>d</mi><mi>k</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msubsup><mo>=</mo><msub><mi>d</mi><mi>k</mi></msub><mi mathvariant="normal">/</mi><mi>h</mi></mrow><annotation encoding="application/x-tex">d_k&#x27; = d_k / h</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.035em;vertical-align:-0.2831em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-2.4169em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2831em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">/</span><span class="mord mathnormal">h</span></span></span></span>，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>d</mi><mi>v</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msubsup><mo>=</mo><msub><mi>d</mi><mi>v</mi></msub><mi mathvariant="normal">/</mi><mi>h</mi></mrow><annotation encoding="application/x-tex">d_v&#x27; = d_v / h</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9989em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">/</span><span class="mord mathnormal">h</span></span></span></span>。</p><p>拆分后的 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi></mrow><annotation encoding="application/x-tex">Q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">Q</span></span></span></span>、<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span>、<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi></mrow><annotation encoding="application/x-tex">V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span> 分别为：</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>Q</mi><mi>i</mi></msub><mo>=</mo><mi>Q</mi><msub><mi>W</mi><msub><mi>Q</mi><mi>i</mi></msub></msub><mo separator="true">,</mo><mspace width="1em"/><msub><mi>K</mi><mi>i</mi></msub><mo>=</mo><mi>K</mi><msub><mi>W</mi><msub><mi>K</mi><mi>i</mi></msub></msub><mo separator="true">,</mo><mspace width="1em"/><msub><mi>V</mi><mi>i</mi></msub><mo>=</mo><mi>V</mi><msub><mi>W</mi><msub><mi>V</mi><mi>i</mi></msub></msub></mrow><annotation encoding="application/x-tex">Q_i = QW_{Q_i}, \quad K_i = KW_{K_i}, \quad V_i = VW_{V_i}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord mathnormal">Q</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:1em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.9334em;vertical-align:-0.2501em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:-0.0715em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2501em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:1em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.9334em;vertical-align:-0.2501em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:-0.2222em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2501em;"><span></span></span></span></span></span></span></span></span></span></span></p><p>其中：</p><ul><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><msub><mi>Q</mi><mi>i</mi></msub></msub><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><msub><mi>d</mi><mi>k</mi></msub><mo>×</mo><msubsup><mi>d</mi><mi>k</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msubsup></mrow></msup></mrow><annotation encoding="application/x-tex">W_{Q_i} \in \mathbb{R}^{d_k \times d_k&#x27;}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.9425em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9425em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span><span class="mbin mtight">×</span><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8278em;"><span style="top:-2.214em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>、<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><msub><mi>K</mi><mi>i</mi></msub></msub><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><msub><mi>d</mi><mi>k</mi></msub><mo>×</mo><msubsup><mi>d</mi><mi>k</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msubsup></mrow></msup></mrow><annotation encoding="application/x-tex">W_{K_i} \in \mathbb{R}^{d_k \times d_k&#x27;}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9334em;vertical-align:-0.2501em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:-0.0715em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2501em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.9425em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9425em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span><span class="mbin mtight">×</span><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8278em;"><span style="top:-2.214em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>、<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><msub><mi>V</mi><mi>i</mi></msub></msub><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><msub><mi>d</mi><mi>v</mi></msub><mo>×</mo><msubsup><mi>d</mi><mi>v</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msubsup></mrow></msup></mrow><annotation encoding="application/x-tex">W_{V_i} \in \mathbb{R}^{d_v \times d_v&#x27;}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9334em;vertical-align:-0.2501em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:-0.2222em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2501em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.9425em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9425em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1645em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mbin mtight">×</span><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8278em;"><span style="top:-2.214em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> 是每个头的可学习权重矩阵。</li><li>每个头的输出维度为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi mathvariant="double-struck">R</mi><mrow><mi>n</mi><mo>×</mo><msubsup><mi>d</mi><mi>k</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msubsup></mrow></msup></mrow><annotation encoding="application/x-tex">\mathbb{R}^{n \times d_k&#x27;}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9425em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9425em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">×</span><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8278em;"><span style="top:-2.214em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> 和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi mathvariant="double-struck">R</mi><mrow><mi>n</mi><mo>×</mo><msubsup><mi>d</mi><mi>v</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msubsup></mrow></msup></mrow><annotation encoding="application/x-tex">\mathbb{R}^{n \times d_v&#x27;}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9425em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9425em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">×</span><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8278em;"><span style="top:-2.214em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>。</li></ul><h3 id="4-计算每个头的注意力">4. 计算每个头的注意力</h3><p>对每个头 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span>，计算注意力输出：</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mtext>head</mtext><mi>i</mi></msub><mo>=</mo><mtext>Attention</mtext><mo stretchy="false">(</mo><msub><mi>Q</mi><mi>i</mi></msub><mo separator="true">,</mo><msub><mi>K</mi><mi>i</mi></msub><mo separator="true">,</mo><msub><mi>V</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\text{head}_i = \text{Attention}(Q_i, K_i, V_i)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord text"><span class="mord">head</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Attention</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p><p>其中：</p><ul><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>Attention</mtext></mrow><annotation encoding="application/x-tex">\text{Attention}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord text"><span class="mord">Attention</span></span></span></span></span> 是标准的缩放点积注意力机制。</li></ul><h3 id="5-拼接多头输出">5. 拼接多头输出</h3><p>将多个头的输出拼接起来：</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>MultiHead</mtext><mo stretchy="false">(</mo><mi>Q</mi><mo separator="true">,</mo><mi>K</mi><mo separator="true">,</mo><mi>V</mi><mo stretchy="false">)</mo><mo>=</mo><mtext>Concat</mtext><mo stretchy="false">(</mo><msub><mtext>head</mtext><mn>1</mn></msub><mo separator="true">,</mo><msub><mtext>head</mtext><mn>2</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mtext>head</mtext><mi>h</mi></msub><mo stretchy="false">)</mo><msub><mi>W</mi><mi>O</mi></msub></mrow><annotation encoding="application/x-tex">\text{MultiHead}(Q, K, V) = \text{Concat}(\text{head}_1, \text{head}_2, \dots, \text{head}_h)W_O</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">MultiHead</span></span><span class="mopen">(</span><span class="mord mathnormal">Q</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Concat</span></span><span class="mopen">(</span><span class="mord"><span class="mord text"><span class="mord">head</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord text"><span class="mord">head</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord text"><span class="mord">head</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">h</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">O</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></p><p>其中：</p><ul><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mi>O</mi></msub><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>h</mi><msubsup><mi>d</mi><mi>v</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msubsup><mo>×</mo><mi>d</mi></mrow></msup></mrow><annotation encoding="application/x-tex">W_O \in \mathbb{R}^{h d_v&#x27; \times d}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">O</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.9425em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9425em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">h</span><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8278em;"><span style="top:-2.214em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286em;"><span></span></span></span></span></span></span><span class="mbin mtight">×</span><span class="mord mathnormal mtight">d</span></span></span></span></span></span></span></span></span></span></span></span> 是输出权重矩阵。</li><li>最终输出的维度为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi mathvariant="double-struck">R</mi><mrow><mi>n</mi><mo>×</mo><mi>d</mi></mrow></msup></mrow><annotation encoding="application/x-tex">\mathbb{R}^{n \times d}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8491em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">×</span><span class="mord mathnormal mtight">d</span></span></span></span></span></span></span></span></span></span></span></span>。</li></ul><hr><h2 id="3-详细例子">3. 详细例子</h2><p>假设：</p><ul><li>输入序列 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi></mrow><annotation encoding="application/x-tex">X</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span> 包含 2 个词，每个词的嵌入维度 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mo>=</mo><mn>4</mn></mrow><annotation encoding="application/x-tex">d = 4</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">4</span></span></span></span>。</li><li>多头注意力的头数 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi><mo>=</mo><mn>2</mn></mrow><annotation encoding="application/x-tex">h = 2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">h</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">2</span></span></span></span>，因此每个头的维度 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>d</mi><mi>k</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msubsup><mo>=</mo><msubsup><mi>d</mi><mi>v</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msubsup><mo>=</mo><mn>2</mn></mrow><annotation encoding="application/x-tex">d_k&#x27; = d_v&#x27; = 2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.035em;vertical-align:-0.2831em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-2.4169em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2831em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.9989em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">2</span></span></span></span>。</li></ul><h3 id="1-输入表示-3">1. 输入表示</h3><p>输入序列 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi></mrow><annotation encoding="application/x-tex">X</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span>：</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>X</mi><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>2</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>3</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>4</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>4</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>3</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>2</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">X = \begin{bmatrix}1 &amp; 2 &amp; 3 &amp; 4 \\4 &amp; 3 &amp; 2 &amp; 1\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">4</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">3</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">4</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span></span></span></span></span></p><h3 id="2-线性变换-3">2. 线性变换</h3><p>假设 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mi>Q</mi></msub></mrow><annotation encoding="application/x-tex">W_Q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">Q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span>、<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mi>K</mi></msub></mrow><annotation encoding="application/x-tex">W_K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>、<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mi>V</mi></msub></mrow><annotation encoding="application/x-tex">W_V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">V</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 分别为：</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>W</mi><mi>Q</mi></msub><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo separator="true">,</mo><mspace width="1em"/><msub><mi>W</mi><mi>K</mi></msub><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo separator="true">,</mo><mspace width="1em"/><msub><mi>W</mi><mi>V</mi></msub><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">W_Q = \begin{bmatrix}1 &amp; 0 \\0 &amp; 1 \\1 &amp; 0 \\0 &amp; 1\end{bmatrix}, \quadW_K = \begin{bmatrix}0 &amp; 1 \\1 &amp; 0 \\0 &amp; 1 \\1 &amp; 0\end{bmatrix}, \quadW_V = \begin{bmatrix}1 &amp; 0 \\0 &amp; 1 \\1 &amp; 0 \\0 &amp; 1\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">Q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:4.8em;vertical-align:-2.15em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em;"><span style="top:-4.65em;"><span class="pstrut" style="height:6.8em;"></span><span style="width:0.667em;height:4.800em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="4.800em" viewBox="0 0 667 4800"><path d="M403 1759 V84 H666 V0 H319 V1759 v1200 v1759 h347 v-84H403z M403 1759 V0 H319 V1759 v1200 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em;"><span style="top:-4.81em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-1.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em;"><span style="top:-4.81em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em;"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em;"><span style="top:-4.65em;"><span class="pstrut" style="height:6.8em;"></span><span style="width:0.667em;height:4.800em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="4.800em" viewBox="0 0 667 4800"><path d="M347 1759 V0 H0 V84 H263 V1759 v1200 v1759 H0 v84 H347zM347 1759 V0 H263 V1759 v1200 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em;"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:1em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:4.8em;vertical-align:-2.15em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em;"><span style="top:-4.65em;"><span class="pstrut" style="height:6.8em;"></span><span style="width:0.667em;height:4.800em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="4.800em" viewBox="0 0 667 4800"><path d="M403 1759 V84 H666 V0 H319 V1759 v1200 v1759 h347 v-84H403z M403 1759 V0 H319 V1759 v1200 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em;"><span style="top:-4.81em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em;"><span style="top:-4.81em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-1.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em;"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em;"><span style="top:-4.65em;"><span class="pstrut" style="height:6.8em;"></span><span style="width:0.667em;height:4.800em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="4.800em" viewBox="0 0 667 4800"><path d="M347 1759 V0 H0 V84 H263 V1759 v1200 v1759 H0 v84 H347zM347 1759 V0 H263 V1759 v1200 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em;"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:1em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">V</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:4.8em;vertical-align:-2.15em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em;"><span style="top:-4.65em;"><span class="pstrut" style="height:6.8em;"></span><span style="width:0.667em;height:4.800em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="4.800em" viewBox="0 0 667 4800"><path d="M403 1759 V84 H666 V0 H319 V1759 v1200 v1759 h347 v-84H403z M403 1759 V0 H319 V1759 v1200 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em;"><span style="top:-4.81em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-1.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em;"><span style="top:-4.81em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em;"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em;"><span style="top:-4.65em;"><span class="pstrut" style="height:6.8em;"></span><span style="width:0.667em;height:4.800em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="4.800em" viewBox="0 0 667 4800"><path d="M347 1759 V0 H0 V84 H263 V1759 v1200 v1759 H0 v84 H347zM347 1759 V0 H263 V1759 v1200 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em;"><span></span></span></span></span></span></span></span></span></span></span></span></p><p>计算 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi></mrow><annotation encoding="application/x-tex">Q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">Q</span></span></span></span>、<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span>、<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi></mrow><annotation encoding="application/x-tex">V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span>：</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>Q</mi><mo>=</mo><mi>X</mi><msub><mi>W</mi><mi>Q</mi></msub><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>2</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>4</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>3</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo separator="true">,</mo><mspace width="1em"/><mi>K</mi><mo>=</mo><mi>X</mi><msub><mi>W</mi><mi>K</mi></msub><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>2</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>3</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>4</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo separator="true">,</mo><mspace width="1em"/><mi>V</mi><mo>=</mo><mi>X</mi><msub><mi>W</mi><mi>V</mi></msub><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>2</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>4</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>3</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">Q = XW_Q = \begin{bmatrix}1 &amp; 2 \\4 &amp; 3\end{bmatrix}, \quadK = XW_K = \begin{bmatrix}2 &amp; 1 \\3 &amp; 4\end{bmatrix}, \quadV = XW_V = \begin{bmatrix}1 &amp; 2 \\4 &amp; 3\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">Q</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">Q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">4</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:1em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">4</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:1em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">V</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">4</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span></span></span></span></span></p><h3 id="3-拆分多头-2">3. 拆分多头</h3><p>假设每个头的权重矩阵为：</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>W</mi><msub><mi>Q</mi><mn>1</mn></msub></msub><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo separator="true">,</mo><mspace width="1em"/><msub><mi>W</mi><msub><mi>K</mi><mn>1</mn></msub></msub><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo separator="true">,</mo><mspace width="1em"/><msub><mi>W</mi><msub><mi>V</mi><mn>1</mn></msub></msub><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">W_{Q_1} = \begin{bmatrix}1 &amp; 0 \\0 &amp; 1\end{bmatrix}, \quadW_{K_1} = \begin{bmatrix}0 &amp; 1 \\1 &amp; 0\end{bmatrix}, \quadW_{V_1} = \begin{bmatrix}1 &amp; 0 \\0 &amp; 1\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3173em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:1em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3173em;"><span style="top:-2.357em;margin-left:-0.0715em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2501em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:1em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3173em;"><span style="top:-2.357em;margin-left:-0.2222em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2501em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span></span></span></span></span></p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>W</mi><msub><mi>Q</mi><mn>2</mn></msub></msub><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo separator="true">,</mo><mspace width="1em"/><msub><mi>W</mi><msub><mi>K</mi><mn>2</mn></msub></msub><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo separator="true">,</mo><mspace width="1em"/><msub><mi>W</mi><msub><mi>V</mi><mn>2</mn></msub></msub><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">W_{Q_2} = \begin{bmatrix}1 &amp; 0 \\0 &amp; 1\end{bmatrix}, \quadW_{K_2} = \begin{bmatrix}0 &amp; 1 \\1 &amp; 0\end{bmatrix}, \quadW_{V_2} = \begin{bmatrix}1 &amp; 0 \\0 &amp; 1\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3173em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:1em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3173em;"><span style="top:-2.357em;margin-left:-0.0715em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2501em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:1em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3173em;"><span style="top:-2.357em;margin-left:-0.2222em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2501em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span></span></span></span></span></p><p>计算每个头的 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Q</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">Q_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>、<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>K</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">K_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>、<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>V</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">V_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>：</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>Q</mi><mn>1</mn></msub><mo>=</mo><mi>Q</mi><msub><mi>W</mi><msub><mi>Q</mi><mn>1</mn></msub></msub><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>2</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>4</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>3</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo separator="true">,</mo><mspace width="1em"/><msub><mi>K</mi><mn>1</mn></msub><mo>=</mo><mi>K</mi><msub><mi>W</mi><msub><mi>K</mi><mn>1</mn></msub></msub><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>2</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>3</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>4</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo separator="true">,</mo><mspace width="1em"/><msub><mi>V</mi><mn>1</mn></msub><mo>=</mo><mi>V</mi><msub><mi>W</mi><msub><mi>V</mi><mn>1</mn></msub></msub><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>2</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>4</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>3</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">Q_1 = QW_{Q_1} = \begin{bmatrix}1 &amp; 2 \\4 &amp; 3\end{bmatrix}, \quadK_1 = KW_{K_1} = \begin{bmatrix}2 &amp; 1 \\3 &amp; 4\end{bmatrix}, \quadV_1 = VW_{V_1} = \begin{bmatrix}1 &amp; 2 \\4 &amp; 3\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord mathnormal">Q</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3173em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">4</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:1em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.9334em;vertical-align:-0.2501em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3173em;"><span style="top:-2.357em;margin-left:-0.0715em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2501em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">4</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:1em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.9334em;vertical-align:-0.2501em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3173em;"><span style="top:-2.357em;margin-left:-0.2222em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2501em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">4</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span></span></span></span></span></p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>Q</mi><mn>2</mn></msub><mo>=</mo><mi>Q</mi><msub><mi>W</mi><msub><mi>Q</mi><mn>2</mn></msub></msub><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>2</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>4</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>3</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo separator="true">,</mo><mspace width="1em"/><msub><mi>K</mi><mn>2</mn></msub><mo>=</mo><mi>K</mi><msub><mi>W</mi><msub><mi>K</mi><mn>2</mn></msub></msub><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>2</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>3</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>4</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo separator="true">,</mo><mspace width="1em"/><msub><mi>V</mi><mn>2</mn></msub><mo>=</mo><mi>V</mi><msub><mi>W</mi><msub><mi>V</mi><mn>2</mn></msub></msub><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>2</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>4</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>3</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">Q_2 = QW_{Q_2} = \begin{bmatrix}1 &amp; 2 \\4 &amp; 3\end{bmatrix}, \quadK_2 = KW_{K_2} = \begin{bmatrix}2 &amp; 1 \\3 &amp; 4\end{bmatrix}, \quadV_2 = VW_{V_2} = \begin{bmatrix}1 &amp; 2 \\4 &amp; 3\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord mathnormal">Q</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3173em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">4</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:1em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.9334em;vertical-align:-0.2501em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3173em;"><span style="top:-2.357em;margin-left:-0.0715em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2501em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">4</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:1em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.9334em;vertical-align:-0.2501em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3173em;"><span style="top:-2.357em;margin-left:-0.2222em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2501em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">4</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span></span></span></span></span></p><h3 id="4-计算每个头的注意力-2">4. 计算每个头的注意力</h3><p>对每个头 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span>，计算注意力输出：</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mtext>head</mtext><mi>i</mi></msub><mo>=</mo><mtext>Attention</mtext><mo stretchy="false">(</mo><msub><mi>Q</mi><mi>i</mi></msub><mo separator="true">,</mo><msub><mi>K</mi><mi>i</mi></msub><mo separator="true">,</mo><msub><mi>V</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\text{head}_i = \text{Attention}(Q_i, K_i, V_i)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord text"><span class="mord">head</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Attention</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p><p>以第一个头为例：</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mtext>Attention Scores</mtext><mn>1</mn></msub><mo>=</mo><msub><mi>Q</mi><mn>1</mn></msub><msubsup><mi>K</mi><mn>1</mn><mi>T</mi></msubsup><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>2</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>4</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>3</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>2</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>3</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>4</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>4</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>11</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>11</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>24</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">\text{Attention Scores}_1 = Q_1K_1^T = \begin{bmatrix}1 &amp; 2 \\4 &amp; 3\end{bmatrix}\begin{bmatrix}2 &amp; 3 \\1 &amp; 4\end{bmatrix}= \begin{bmatrix}4 &amp; 11 \\11 &amp; 24\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord text"><span class="mord">Attention Scores</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.1383em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-2.453em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">4</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">3</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">4</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">4</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">11</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">11</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">24</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span></span></span></span></span></p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mtext>Scaled Attention Scores</mtext><mn>1</mn></msub><mo>=</mo><mfrac><msub><mtext>Attention Scores</mtext><mn>1</mn></msub><msqrt><mn>2</mn></msqrt></mfrac><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>2.828</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>7.778</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>7.778</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>16.971</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">\text{Scaled Attention Scores}_1 = \frac{\text{Attention Scores}_1}{\sqrt{2}} = \begin{bmatrix}2.828 &amp; 7.778 \\7.778 &amp; 16.971\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord text"><span class="mord">Scaled Attention Scores</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.2903em;vertical-align:-0.93em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3603em;"><span style="top:-2.2028em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9072em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord">2</span></span></span><span style="top:-2.8672em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewBox="0 0 400000 1080" preserveAspectRatio="xMinYMin slice"><path d="M95,702c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429c69,-144,104.5,-217.7,106.5,-221l0 -0c5.3,-9.3,12,-14,20,-14H400000v40H845.2724s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47zM834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1328em;"><span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord text"><span class="mord">Attention Scores</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.93em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2.828</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">7.778</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">7.778</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">16.971</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span></span></span></span></span></p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mtext>Attention Weights</mtext><mn>1</mn></msub><mo>=</mo><mtext>Softmax</mtext><mrow><mo fence="true">(</mo><mfrac><mrow><msub><mi>Q</mi><mn>1</mn></msub><msubsup><mi>K</mi><mn>1</mn><mi>T</mi></msubsup></mrow><msqrt><mn>2</mn></msqrt></mfrac><mo fence="true">)</mo></mrow><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0.016</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0.984</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0.000</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1.000</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">\text{Attention Weights}_1 = \text{Softmax}\left(\frac{Q_1K_1^T}{\sqrt{2}}\right) = \begin{bmatrix}0.016 &amp; 0.984 \\0.000 &amp; 1.000\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9386em;vertical-align:-0.2441em;"></span><span class="mord"><span class="mord text"><span class="mord">Attention Weights</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.207em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4684em;vertical-align:-0.95em;"></span><span class="mord text"><span class="mord">Softmax</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.5183em;"><span style="top:-2.2028em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9072em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord">2</span></span></span><span style="top:-2.8672em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewBox="0 0 400000 1080" preserveAspectRatio="xMinYMin slice"><path d="M95,702c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429c69,-144,104.5,-217.7,106.5,-221l0 -0c5.3,-9.3,12,-14,20,-14H400000v40H845.2724s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47zM834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1328em;"><span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-2.4519em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2481em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.93em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">)</span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0.016</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0.000</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0.984</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1.000</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span></span></span></span></span></p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mtext>head</mtext><mn>1</mn></msub><mo>=</mo><msub><mtext>Attention Weights</mtext><mn>1</mn></msub><mo>⋅</mo><msub><mi>V</mi><mn>1</mn></msub><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0.016</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0.984</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0.000</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1.000</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>2</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>4</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>3</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>3.952</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>2.984</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>4.000</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>3.000</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">\text{head}_1 = \text{Attention Weights}_1 \cdot V_1 = \begin{bmatrix}0.016 &amp; 0.984 \\0.000 &amp; 1.000\end{bmatrix}\begin{bmatrix}1 &amp; 2 \\4 &amp; 3\end{bmatrix}= \begin{bmatrix}3.952 &amp; 2.984 \\4.000 &amp; 3.000\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord text"><span class="mord">head</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.9386em;vertical-align:-0.2441em;"></span><span class="mord"><span class="mord text"><span class="mord">Attention Weights</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.207em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0.016</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0.000</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0.984</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1.000</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">4</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">3.952</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">4.000</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2.984</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">3.000</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span></span></span></span></span></p><p>同理，计算第二个头的输出 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mtext>head</mtext><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">\text{head}_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord text"><span class="mord">head</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>。</p><h3 id="5-拼接多头输出-2">5. 拼接多头输出</h3><p>将两个头的输出拼接起来：</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>MultiHead</mtext><mo stretchy="false">(</mo><mi>Q</mi><mo separator="true">,</mo><mi>K</mi><mo separator="true">,</mo><mi>V</mi><mo stretchy="false">)</mo><mo>=</mo><mtext>Concat</mtext><mo stretchy="false">(</mo><msub><mtext>head</mtext><mn>1</mn></msub><mo separator="true">,</mo><msub><mtext>head</mtext><mn>2</mn></msub><mo stretchy="false">)</mo><msub><mi>W</mi><mi>O</mi></msub></mrow><annotation encoding="application/x-tex">\text{MultiHead}(Q, K, V) = \text{Concat}(\text{head}_1, \text{head}_2)W_O</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">MultiHead</span></span><span class="mopen">(</span><span class="mord mathnormal">Q</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Concat</span></span><span class="mopen">(</span><span class="mord"><span class="mord text"><span class="mord">head</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord text"><span class="mord">head</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">O</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></p><p>假设 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mi>O</mi></msub></mrow><annotation encoding="application/x-tex">W_O</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">O</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 为单位矩阵，则最终输出为：</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>MultiHead</mtext><mo stretchy="false">(</mo><mi>Q</mi><mo separator="true">,</mo><mi>K</mi><mo separator="true">,</mo><mi>V</mi><mo stretchy="false">)</mo><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>3.952</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>2.984</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>3.952</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>2.984</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>4.000</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>3.000</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>4.000</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>3.000</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">\text{MultiHead}(Q, K, V) = \begin{bmatrix}3.952 &amp; 2.984 &amp; 3.952 &amp; 2.984 \\4.000 &amp; 3.000 &amp; 4.000 &amp; 3.000\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">MultiHead</span></span><span class="mopen">(</span><span class="mord mathnormal">Q</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">3.952</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">4.000</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2.984</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">3.000</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">3.952</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">4.000</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2.984</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">3.000</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span></span></span></span></span></p><hr><h2 id="4-总结">4. 总结</h2><ul><li>多头注意力通过并行计算多个注意力头，捕捉输入序列中不同子空间的信息。</li><li>每个头独立计算注意力，最后将多个头的输出拼接起来，并通过线性变换得到最终输出。</li></ul><h1>Self-Attention &amp; Cross-Attention</h1><h2 id="一、Self-Attention-是什么？">一、Self-Attention 是什么？</h2><p>Self-Attention（自注意力）是指：<strong>Query、Key、Value 都来自同一个输入序列</strong>，用于捕捉序列内部 token 之间的关系。</p><h3 id="结构公式：">结构公式：</h3><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>Attention</mtext><mo stretchy="false">(</mo><mi>Q</mi><mo separator="true">,</mo><mi>K</mi><mo separator="true">,</mo><mi>V</mi><mo stretchy="false">)</mo><mo>=</mo><mtext>softmax</mtext><mrow><mo fence="true">(</mo><mfrac><mrow><mi>Q</mi><msup><mi>K</mi><mi>T</mi></msup></mrow><msqrt><msub><mi>d</mi><mi>k</mi></msub></msqrt></mfrac><mo fence="true">)</mo></mrow><mi>V</mi></mrow><annotation encoding="application/x-tex">\text{Attention}(Q, K, V) = \text{softmax}\left(\frac{QK^T}{\sqrt{d_k}}\right) V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Attention</span></span><span class="mopen">(</span><span class="mord mathnormal">Q</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4684em;vertical-align:-0.95em;"></span><span class="mord text"><span class="mord">softmax</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.5183em;"><span style="top:-2.2528em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8572em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.8172em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewBox="0 0 400000 1080" preserveAspectRatio="xMinYMin slice"><path d="M95,702c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429c69,-144,104.5,-217.7,106.5,-221l0 -0c5.3,-9.3,12,-14,20,-14H400000v40H845.2724s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47zM834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1828em;"><span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">Q</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.93em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">)</span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span></span></p><p>其中：</p><ul><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi><mo>=</mo><mi>X</mi><msup><mi>W</mi><mi>Q</mi></msup></mrow><annotation encoding="application/x-tex">Q = XW^Q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">Q</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8413em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">Q</span></span></span></span></span></span></span></span></span></span></span>，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi><mo>=</mo><mi>X</mi><msup><mi>W</mi><mi>K</mi></msup></mrow><annotation encoding="application/x-tex">K = XW^K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8413em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span></span></span></span></span></span></span></span>，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi><mo>=</mo><mi>X</mi><msup><mi>W</mi><mi>V</mi></msup></mrow><annotation encoding="application/x-tex">V = XW^V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8413em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">V</span></span></span></span></span></span></span></span></span></span></span>，X 是输入序列（n 个 token）</li><li>所以 Q/K/V 来自同一个 X，但经过不同的线性变换（<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>W</mi><mi>Q</mi></msup><mo separator="true">,</mo><msup><mi>W</mi><mi>K</mi></msup><mo separator="true">,</mo><msup><mi>W</mi><mi>V</mi></msup></mrow><annotation encoding="application/x-tex">W^Q, W^K, W^V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0358em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">Q</span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">V</span></span></span></span></span></span></span></span></span></span></span> 是可学习参数矩阵）</li></ul><h3 id="特点：">特点：</h3><ul><li>输入 = 输出长度</li><li>无信息遮挡（可看到前后文）</li><li>多用于表征学习、序列理解</li></ul><h3 id="使用场景：">使用场景：</h3><ul><li>Encoder 中（如 BERT）</li><li>Decoder 中（如 GPT, 作为 Masked Self-Attention）</li></ul><hr><h2 id="二、Cross-Attention-是什么？">二、Cross-Attention 是什么？</h2><p>Cross-Attention 是指：<strong>Query 来自 Decoder，Key 和 Value 来自 Encoder 的输出</strong>，用于捕捉“源-目标”之间的对齐关系。</p><h3 id="结构公式：-2">结构公式：</h3><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>Attention</mtext><mo stretchy="false">(</mo><msup><mi>Q</mi><mrow><mi>d</mi><mi>e</mi><mi>c</mi></mrow></msup><mo separator="true">,</mo><msup><mi>K</mi><mrow><mi>e</mi><mi>n</mi><mi>c</mi></mrow></msup><mo separator="true">,</mo><msup><mi>V</mi><mrow><mi>e</mi><mi>n</mi><mi>c</mi></mrow></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\text{Attention}(Q^{dec}, K^{enc}, V^{enc})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1491em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Attention</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8991em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">ec</span></span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7144em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">n</span><span class="mord mathnormal mtight">c</span></span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7144em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">n</span><span class="mord mathnormal mtight">c</span></span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p><p>其中：</p><ul><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi><mo>=</mo><msup><mi>X</mi><mrow><mi>d</mi><mi>e</mi><mi>c</mi></mrow></msup><msup><mi>W</mi><mi>Q</mi></msup><mtext>，</mtext><mi>K</mi><mo>=</mo><msup><mi>X</mi><mrow><mi>e</mi><mi>n</mi><mi>c</mi></mrow></msup><msup><mi>W</mi><mi>K</mi></msup><mtext>，</mtext><mi>V</mi><mo>=</mo><msup><mi>X</mi><mrow><mi>e</mi><mi>n</mi><mi>c</mi></mrow></msup><msup><mi>W</mi><mi>V</mi></msup></mrow><annotation encoding="application/x-tex">Q = X^{dec}W^Q，K = X^{enc}W^K，V = X^{enc}W^V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">Q</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8491em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">ec</span></span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">Q</span></span></span></span></span></span></span></span><span class="mord cjk_fallback">，</span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8413em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6644em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">n</span><span class="mord mathnormal mtight">c</span></span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span></span></span></span></span><span class="mord cjk_fallback">，</span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8413em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6644em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">n</span><span class="mord mathnormal mtight">c</span></span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">V</span></span></span></span></span></span></span></span></span></span></span></li><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>X</mi><mrow><mi>d</mi><mi>e</mi><mi>c</mi></mrow></msup></mrow><annotation encoding="application/x-tex">X^{dec}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8491em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">ec</span></span></span></span></span></span></span></span></span></span></span></span> 是 Decoder 的当前输入，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>X</mi><mrow><mi>e</mi><mi>n</mi><mi>c</mi></mrow></msup></mrow><annotation encoding="application/x-tex">X^{enc}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6644em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">n</span><span class="mord mathnormal mtight">c</span></span></span></span></span></span></span></span></span></span></span></span> 是 Encoder 的输出</li><li>同样需要通过三个独立的 projection 矩阵获得 Q/K/V，不能直接使用原向量</li></ul><h3 id="特点：-2">特点：</h3><ul><li>Q ≠ K/V，跨序列计算注意力</li><li>Decoder 用它来访问 Encoder 的上下文信息</li><li>在 Encoder-Decoder 架构中使用</li></ul><h3 id="使用场景：-2">使用场景：</h3><ul><li>Decoder 模块中（T5, BART）</li><li>多模态模型中（图文、音文对齐）</li></ul><hr><h2 id="三、对比总结表">三、对比总结表</h2><table><thead><tr><th>对比项</th><th>Self-Attention</th><th>Cross-Attention</th></tr></thead><tbody><tr><td>Q</td><td>来自当前序列</td><td>来自 Decoder</td></tr><tr><td>K/V</td><td>来自当前序列</td><td>来自 Encoder</td></tr><tr><td>是否乘参数矩阵</td><td>是（<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>W</mi><mi>Q</mi></msup><mo separator="true">,</mo><msup><mi>W</mi><mi>K</mi></msup><mo separator="true">,</mo><msup><mi>W</mi><mi>V</mi></msup></mrow><annotation encoding="application/x-tex">W^Q, W^K, W^V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0358em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">Q</span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">V</span></span></span></span></span></span></span></span></span></span></span>）</td><td>是（<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>W</mi><mi>Q</mi></msup><mo separator="true">,</mo><msup><mi>W</mi><mi>K</mi></msup><mo separator="true">,</mo><msup><mi>W</mi><mi>V</mi></msup></mrow><annotation encoding="application/x-tex">W^Q, W^K, W^V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0358em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">Q</span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">V</span></span></span></span></span></span></span></span></span></span></span>）</td></tr><tr><td>应用位置</td><td>Encoder / Decoder</td><td>Decoder</td></tr><tr><td>是否跨序列</td><td>否</td><td>是</td></tr><tr><td>是否有 masking</td><td>有（Decoder 中）/无（Encoder）</td><td>无</td></tr></tbody></table><hr><h2 id="四、在-Decoder-中的顺序结构">四、在 Decoder 中的顺序结构</h2><p>每一层 Decoder 都包含如下结构：</p><ol><li>Masked Self-Attention（只看前文）</li><li>Cross-Attention（看 Encoder 输出）</li><li>Feed-Forward Network</li></ol><p>其中 Cross-Attention 的 K/V 来自 Encoder 最后一层的输出，是固定的，不随 Decoder 层数变化。</p><hr><h2 id="五、小结">五、小结</h2><ul><li>无论是 Self-Attention 还是 Cross-Attention，Q、K、V 都是通过线性变换得到的，即使它们来自同一个或不同的序列。</li><li>Cross-Attention 的关键在于：Q 来自 Decoder，K/V 来自 Encoder，但依然要分别乘各自的可学习参数矩阵（<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>W</mi><mi>Q</mi></msup><mo separator="true">,</mo><msup><mi>W</mi><mi>K</mi></msup><mo separator="true">,</mo><msup><mi>W</mi><mi>V</mi></msup></mrow><annotation encoding="application/x-tex">W^Q, W^K, W^V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0358em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">Q</span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">V</span></span></span></span></span></span></span></span></span></span></span>）。</li><li>这种结构确保了模型能灵活、有效地实现信息对齐与融合。</li></ul><h1>Encoder &amp; Decoder</h1><h2 id="一、Encoder-Block-结构">一、Encoder Block 结构</h2><p>用于提取输入序列的上下文信息（双向表示）。</p><h3 id="每层结构：">每层结构：</h3><ol><li><strong>Self-Attention</strong>（无 mask，允许双向关注）</li><li><strong>Feed-Forward Network (FFN)</strong></li><li><strong>Add &amp; LayerNorm</strong>（残差连接 + 归一化）</li></ol><h3 id="特点：-3">特点：</h3><ul><li>可并行处理整个序列</li><li>所有 token 能看到全局</li><li>用于理解型任务（分类、检索）</li></ul><hr><h2 id="二、Decoder-Block-结构">二、Decoder Block 结构</h2><p>用于生成序列，每一步基于之前已生成的内容。</p><h3 id="每层结构：-2">每层结构：</h3><ol><li><strong>Masked Self-Attention</strong>（遮挡未来 token）</li><li><strong>Cross-Attention</strong>（对 Encoder 输出做 attention）</li><li><strong>Feed-Forward Network (FFN)</strong></li><li><strong>Add &amp; LayerNorm</strong>（残差连接 + 归一化）</li></ol><h3 id="特点：-4">特点：</h3><ul><li>自回归生成（逐 token）</li><li>可访问 Encoder 编码信息</li><li>用于生成型任务（翻译、对话）</li></ul><hr><h2 id="三、三类模型架构对比">三、三类模型架构对比</h2><table><thead><tr><th>架构类型</th><th>结构组成</th><th>应用场景</th><th>代表模型</th></tr></thead><tbody><tr><td><strong>Encoder-only</strong></td><td>只用 Encoder Stack</td><td>分类、理解、检索等</td><td>BERT、RoBERTa</td></tr><tr><td><strong>Decoder-only</strong></td><td>只用 Decoder Stack</td><td>文本生成、续写、补全</td><td>GPT、LLaMA</td></tr><tr><td><strong>Encoder-Decoder</strong></td><td>编码 + 解码两部分</td><td>翻译、摘要、多模态生成</td><td>T5、BART、Flan-T5</td></tr></tbody></table><h3 id="特别说明：">特别说明：</h3><ul><li>Encoder-only 中 Self-Attention 是双向的；</li><li>Decoder-only 中 Self-Attention 是 masked 的；</li><li>Encoder-Decoder 架构中，Decoder 每层都包含 Cross-Attention。</li></ul><hr><h2 id="四、应用建议">四、应用建议</h2><table><thead><tr><th>任务类型</th><th>建议架构</th></tr></thead><tbody><tr><td>情感分类、NER</td><td>Encoder-only</td></tr><tr><td>对话、语言建模</td><td>Decoder-only</td></tr><tr><td>翻译、摘要</td><td>Encoder-Decoder</td></tr></tbody></table>]]></content>
      
      
      <categories>
          
          <category> Research Blogs </category>
          
      </categories>
      
      
        <tags>
            
            <tag> NLP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>AllReduce &amp; Bucketing</title>
      <link href="/blogs/2025/04/07/AllReduce%20&amp;%20Bucketing/"/>
      <url>/blogs/2025/04/07/AllReduce%20&amp;%20Bucketing/</url>
      
        <content type="html"><![CDATA[<p>本文主要介绍了 AllReduce 和 Bucketing 分别是什么，和他们之间的联系。</p><h1>一、AllReduce 是什么？</h1><p>AllReduce 是分布式训练中的一种集体通信操作，<br>用于在多个 GPU（worker）之间同步张量（通常是梯度）。</p><p>典型流程如下：</p><ol><li>每个 GPU 独立计算自己的梯度张量（如 grad）。</li><li>所有 GPU 通过 AllReduce 操作，将各自的张量求和/平均，获得全局一致的梯度。</li><li>每个 GPU 使用这个同步后的梯度更新模型参数。</li></ol><p>AllReduce 是数据并行训练中实现模型同步的关键机制。</p><hr><h1>二、为什么 AllReduce 会成为性能瓶颈？</h1><ul><li>模型中参数众多，梯度张量数量也很多。</li><li>每个张量如果单独 AllReduce，通信次数极多。</li><li>小张量通信无法充分利用带宽，且频繁启动通信带来显著延迟（latency）。</li></ul><hr><h1>三、Bucketing 是什么？</h1><p>Bucketing 是一种<strong>优化 AllReduce 通信效率的策略</strong>，<br>将多个小张量合并成一个大 “bucket”，再一次性执行 AllReduce。</p><p><strong>核心思想：Batch Small Reduces into One Large Reduce</strong></p><h2 id="举例：">举例：</h2><ul><li>原始做法：<ul><li>grad1 → AllReduce</li><li>grad2 → AllReduce</li><li>grad3 → AllReduce</li></ul></li><li>Bucketing 后：<ul><li>[grad1 + grad2 + grad3] → 合并成 bucket → 一次 AllReduce</li></ul></li></ul><hr><h1>四、Bucketing 的优势</h1><table><thead><tr><th>优势</th><th>说明</th></tr></thead><tbody><tr><td>降低通信启动次数</td><td>小张量太多会频繁触发 AllReduce，带来启动延迟</td></tr><tr><td>提高带宽利用率</td><td>大张量通信更接近理论带宽上限，传输更高效</td></tr><tr><td>便于通信计算重叠</td><td>bucket 可以在张量准备好后提前通信，提升整体吞吐</td></tr></tbody></table><hr><h1>五、在 PyTorch 等系统中的实际应用</h1><h2 id="PyTorch-DDP（DistributedDataParallel）">PyTorch DDP（DistributedDataParallel）:</h2><ul><li>默认启用 bucketing 策略。</li><li>使用参数 <code>bucket_cap_mb</code> 控制 bucket 的大小（如 25MB）。</li><li>当 bucket 填满或梯度 ready，即可触发一次 AllReduce。</li></ul><h2 id="DeepSpeed-Megatron-等">DeepSpeed, Megatron 等:</h2><ul><li>通常会设计多级 bucket，例如按照张量类型（权重/偏置）或位置（layer-wise）划分。</li><li>有时还结合流式调度（streaming）和异步通信。</li></ul><hr><h1>六、Bucketing 与 MoE 的关系</h1><ul><li>在 MoE 训练中，专家参数（expert weights）通常不需要 AllReduce（它们是局部的）。</li><li>但非专家参数（如 Attention, LayerNorm 等）仍然共享，需要 AllReduce 同步。</li><li>Bucketing 同样可用于这些参数的通信优化。</li></ul><hr><h1>七、小结</h1><ul><li>AllReduce 是实现数据并行训练中参数同步的核心通信操作。</li><li>Bucketing 是一种提升 AllReduce 效率的关键优化策略，特别适用于张量数量多、小张量多的场景。</li><li>二者关系是协作：Bucketing 让 AllReduce 更高效，AllReduce 是 Bucketing 的目标操作。</li></ul>]]></content>
      
      
      <categories>
          
          <category> Research Blogs </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MLSys </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MoE 中 All-to-All 通信机制</title>
      <link href="/blogs/2025/04/07/MoE%20%E4%B8%AD%20All-to-All%20%E9%80%9A%E4%BF%A1%E6%9C%BA%E5%88%B6/"/>
      <url>/blogs/2025/04/07/MoE%20%E4%B8%AD%20All-to-All%20%E9%80%9A%E4%BF%A1%E6%9C%BA%E5%88%B6/</url>
      
        <content type="html"><![CDATA[<p>本文主要介绍了 All-to-All 通信机制，以及为什么需要这个机制。</p><h1>一、All-to-All 是什么？</h1><p>在分布式 Mixture-of-Experts（MoE）模型中，All-to-All 是一种通信操作，<br>用于在多个 GPU 之间<strong>交换 token 和专家（Expert）之间的数据</strong>。</p><p>每个 GPU 上都有输入 token，而每个 Expert 分布在多个不同的 GPU 上。<br>Gate 网络决定每个 token 应该由哪些专家处理，因此 token 需要被动态发送到目标 Expert 所在的 GPU。</p><p>这正是 All-to-All：每个 GPU 既向其他 GPU 发送数据，也接收来自其他 GPU 的数据。</p><hr><h1>二、为什么 MoE 模型需要 All-to-All？</h1><h2 id="1-Expert-是独立的，但-Token-是全局的">1. Expert 是独立的，但 Token 是全局的</h2><ul><li>每个 Expert 的参数是本地的，只存在于某个 GPU 上。</li><li>但 token 是通过数据并行划分的，分布在所有 GPU 上。</li><li>每个 token 的 gate 结果可能指向任意 GPU 上的 Expert。</li></ul><p>因此，token 必须被跨设备发送到它所选中的 expert，产生 All-to-All 通信。</p><h2 id="2-Forward-和-Backward-各需要-2-次-All-to-All">2. Forward 和 Backward 各需要 2 次 All-to-All</h2><ul><li>Forward：<ul><li>Dispatch（token -&gt; expert）</li><li>Combine（expert -&gt; token 原始设备）</li></ul></li><li>Backward：<ul><li>Gradient dispatch（token grad -&gt; expert）</li><li>Gradient combine（expert grad -&gt; token）</li></ul></li></ul><p>共计 4 次 All-to-All 调用。</p><hr><h1>三、为什么不能一开始就把 token 发给对应 GPU？</h1><h2 id="1-Gate-是动态计算出来的">1. Gate 是动态计算出来的</h2><ul><li>Gate 网络的输入是 MoE 层前一层的 hidden state。</li><li>只有在前向传播过程中执行到 MoE 层前，才能计算出每个 token 该去哪几个 Expert。</li><li>所以，在模型最开始时，无法预先知道 token 的目标 Expert 所在 GPU。</li></ul><h2 id="2-提前分发负载不均衡，复杂度高">2. 提前分发负载不均衡，复杂度高</h2><ul><li>如果尝试预分发 token，可能导致 GPU 负载不均衡。</li><li>需要提前构建全局路由表，系统实现复杂。</li><li>还会失去 All-to-All 的隐式负载均衡能力。</li></ul><hr><h1>四、为什么 All-to-All 会阻塞计算？</h1><ul><li>All-to-All 是集体通信（collective communication），所有参与设备必须同时完成。</li><li>通信完成前，Expert 计算无法启动，导致<strong>强同步依赖</strong>。</li><li>所以 All-to-All 通常会“阻塞”后续的 Expert 前向或反向计算。</li></ul><hr><h1>五、为什么 All-reduce 更容易和计算重叠？</h1><table><thead><tr><th>通信类型</th><th>模式特征</th><th>数据规律性</th><th>是否依赖 gate</th><th>是否阻塞计算</th></tr></thead><tbody><tr><td>All-reduce</td><td>规则通信（梯度聚合）</td><td>固定大小</td><td>否</td><td>否，可重叠</td></tr><tr><td>All-to-All</td><td>动态通信（token 路由）</td><td>不均匀</td><td>是</td><td>是，强依赖</td></tr></tbody></table><ul><li>All-reduce 使用 ring/tree 算法，可切分为多个小通信步骤，与计算并行。</li><li>All-to-All 通信量不均，且结果决定后续 Expert 才能开始计算，难以重叠。</li></ul><hr><h1>六、系统优化策略示例</h1><h2 id="Lina">Lina:</h2><ul><li>使用 tensor partitioning，将大张量切分为 micro-ops。</li><li>通过优先调度保证 All-to-All 优先获得带宽，All-reduce 在空闲时执行。</li><li>实现通信和 Expert 计算的流水线（pipelining）。</li></ul><h2 id="NetMoE">NetMoE:</h2><ul><li>不优化通信本身，而是动态调整 sample placement，使 token 分布更贴合 expert 分布。</li><li>减少跨节点通信量，从系统层缓解 All-to-All 压力。</li></ul><h2 id="FasterMoE">FasterMoE:</h2><ul><li>提出 Dynamic Shadowing，对热点 Expert 进行复制，降低通信负载。</li></ul><hr><h1>七、小结</h1><ul><li>All-to-All 是 MoE 模型中不可避免的通信操作，核心原因是 token 是分布式的，expert 是分布式的，gate 是动态的。</li><li>当前系统优化主要集中在通信调度、专家复制、数据重分布等方向。</li><li>要理解 All-to-All 的必要性，关键是要明确 token 与 expert 的动态映射关系。</li></ul>]]></content>
      
      
      <categories>
          
          <category> Research Blogs </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MLSys </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>读书笔记---AI System（1）</title>
      <link href="/blogs/2025/04/06/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0---AI%20System/"/>
      <url>/blogs/2025/04/06/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0---AI%20System/</url>
      
        <content type="html"><![CDATA[<p>这本书发现的也算，比较曲折，是看到有一个人写的一篇知乎里推荐了一位博主吧，叫 <a href="https://space.bilibili.com/517221395">ZOMI酱</a>。虽然是在知乎发现的，但是他基本上是一个视频博主，所以B站看的话更方便，看了一个介绍视频之后发现了他这个AISys的开源书，发现直接看书也可以。目前感觉还是不错的。</p><h1>AI 系统概述</h1><p>这个 chapter 里面就全是介绍，感觉没啥说的，但反正读起来还算很顺，我觉得这种教科书性质的读起来很顺就很可以了。但如果你完全没有任何背景知识的话，估计读完就读完了，也不会有什么感受，如果你有一些背景知识的话，就算是帮你梳理一下体系。</p><h1>AI 硬件体系结构</h1><h2 id="AI-计算体系概述">AI 计算体系概述</h2><h3 id="AI-计算模式">AI 计算模式</h3><p>这里遇到了一些以前不知道的知识。</p><p>模型量化和网络剪枝，这两个技术都是为了解决模型太大，占用的内存太多的问题。</p><img src="./读书笔记---AI System/CleanShot 2025-04-07 at 11.58.11@2x.png" alt="CleanShot 2025-04-07 at 11.58.11@2x" style="zoom:67%;" /><p>模型量化还有两种，非对称量化和对称量化。</p><img src="./读书笔记---AI System/CleanShot 2025-04-07 at 11.59.47@2x.png" alt="CleanShot 2025-04-07 at 11.59.47@2x" style="zoom:67%;" /><h4 id="量化">量化</h4><blockquote><p>将浮点数（如 FP32）映射为整数（如 INT8、UINT8），以减小模型体积、加速推理。</p></blockquote><hr><h5 id="对称量化（Symmetric-Quantization）">对称量化（Symmetric Quantization）</h5><h6 id="概念">概念</h6><ul><li>假设数据以 0 为中心对称分布</li><li>映射到整数范围 <code>[-128, 127]</code>（INT8）</li><li><code>zero_point = 0</code></li></ul><h6 id="公式">公式</h6><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">scale = max_abs / 127<br>zero_point = 0<br>q = round(r / scale)<br></code></pre></td></tr></table></figure><p>反量化：</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">r ≈ scale * q<br></code></pre></td></tr></table></figure><h6 id="示例（实际范围-500-1000-）">示例（实际范围 <code>[-500, 1000]</code>）</h6><ol><li>取最大绝对值：<code>max_abs = 1000</code></li><li>映射区间设为 <code>[-1000, 1000]</code></li><li>计算：</li></ol><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">scale = 1000 / 127 ≈ 7.874<br>zero_point = 0<br></code></pre></td></tr></table></figure><table><thead><tr><th>实际值 r</th><th>量化值 q</th></tr></thead><tbody><tr><td>-1000</td><td>-127</td></tr><tr><td>0</td><td>0</td></tr><tr><td>1000</td><td>127</td></tr></tbody></table><hr><h5 id="非对称量化（Asymmetric-Quantization）">非对称量化（Asymmetric Quantization）</h5><h6 id="概念-2">概念</h6><ul><li>适配非对称分布（如 ReLU 输出）</li><li>映射到 <code>[0, 255]</code>（UINT8）</li><li>需要 <code>zero_point ≠ 0</code></li></ul><h6 id="公式-2">公式</h6><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">scale = (r_max - r_min) / 255<br>zero_point = round(-r_min / scale)<br>q = round(r / scale + zero_point)<br></code></pre></td></tr></table></figure><p>反量化：</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">r ≈ scale * (q - zero_point)<br></code></pre></td></tr></table></figure><h6 id="示例（实际范围-500-1000-）-2">示例（实际范围 <code>[-500, 1000]</code>）</h6><ol><li>不需要扩展区间，直接使用 <code>[-500, 1000]</code></li><li>计算：</li></ol><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">scale = (1000 - (-500)) / 255 ≈ 5.882<br>zero_point = round(500 / 5.882) ≈ 85<br></code></pre></td></tr></table></figure><table><thead><tr><th>实际值 r</th><th>量化值 q</th></tr></thead><tbody><tr><td>-500</td><td>0</td></tr><tr><td>0</td><td>85</td></tr><tr><td>1000</td><td>255</td></tr></tbody></table><hr><h5 id="对比总结表">对比总结表</h5><table><thead><tr><th>特性</th><th>对称量化</th><th>非对称量化</th></tr></thead><tbody><tr><td>是否以 0 为中心</td><td>✅ 是</td><td>❌ 否</td></tr><tr><td>是否有 zero_point</td><td>❌ 无（固定为 0）</td><td>✅ 有</td></tr><tr><td>整数范围</td><td><code>[-128, 127]</code> (INT8)</td><td><code>[0, 255]</code> (UINT8)</td></tr><tr><td>精度表现</td><td>中等</td><td>更好（适合偏移数据）</td></tr><tr><td>计算效率</td><td>高（无需偏移）</td><td>稍慢（多一个偏移量）</td></tr><tr><td>常见应用</td><td>权重量化</td><td>激活量化</td></tr></tbody></table><hr><h5 id="一句话总结">一句话总结</h5><ul><li><strong>对称量化</strong>：适合数据以 0 为中心的情况，速度快，常用于权重。</li><li><strong>非对称量化</strong>：适合分布偏移的数据（如激活值），精度更高但计算更复杂。</li></ul><p>当然还有别的量化方法，书里没有具体介绍，只稍微提了一下。</p><h4 id="剪枝">剪枝</h4><img src="./读书笔记---AI System/CleanShot 2025-04-07 at 13.30.57@2x.png" alt="CleanShot 2025-04-07 at 13.30.57@2x" style="zoom:67%;" /><h4 id="卷积层计算原理总结">卷积层计算原理总结</h4><h5 id="卷积层参数量计算公式">卷积层参数量计算公式</h5><p>对于一个输入大小为 W × H × Ci 的特征图：</p><ul><li>卷积核大小为 k × k</li><li>输入通道数为 Ci</li><li>输出通道数为 Co</li></ul><p>该卷积层的参数总量为：</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">Params = (k × k × Ci + 1) × Co<br></code></pre></td></tr></table></figure><p>说明：</p><ul><li>k × k × Ci 是每个输出通道的权重数量（每个输入通道都有独立的一套权重）</li><li>+1 表示 bias（每个输出通道对应一个偏置项）</li><li>× Co 表示有 Co 个输出通道</li></ul><p>每个卷积核是一个三维体积（k × k × Ci），负责融合多个输入通道的信息。</p><hr><h5 id="每个输出点的计算过程">每个输出点的计算过程</h5><p>对于输出特征图中每个位置 (i, j) 和输出通道 co，对应的计算为：</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">output[i][j][co] = sum_&#123;ci=0&#125;^&#123;Ci-1&#125; <br>conv(input_patch[i][j][ci], weight[co][ci]) + bias[co]<br></code></pre></td></tr></table></figure><p>步骤如下：</p><ol><li>对每个输入通道 ci，取出其上的 k × k 区域 patch。</li><li>将该 patch 和该通道对应的卷积核权重做逐元素乘法并求和。</li><li>对所有通道的结果加总。</li><li>最后加上 bias，得到一个输出标量。</li></ol><hr><h5 id="FLOPs-浮点运算次数计算">FLOPs 浮点运算次数计算</h5><p>FLOPs 表示模型中执行的浮点操作数量。</p><p>对于上述卷积操作，其 FLOPs 为：</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">FLOPs = W × H × (k × k × Ci + 1) × Co<br></code></pre></td></tr></table></figure><p>说明：</p><ul><li>每个输出位置需要 k × k × Ci 次乘加（MAC）</li><li>+1 表示加上 bias</li><li>W × H 表示输出特征图的空间位置数</li><li>Co 表示输出通道数量</li></ul><p>注意：有些库或论文将乘法和加法各算 1 次 FLOP，此时 FLOPs 约为 2 × W × H × k² × Ci × Co</p><hr><h5 id="总结要点">总结要点</h5><ul><li>卷积核在每个输入通道上都有独立的权重。</li><li>每个输出通道对应一整组输入通道上的卷积核。</li><li>卷积计算是“多通道 patch 和权重的加权求和”。</li><li>参数量和 FLOPs 都随输入通道数、卷积核大小、输出通道数线性增长。</li></ul><h4 id="卷积核分解：VGG-与-Inception-方法总结">卷积核分解：VGG 与 Inception 方法总结</h4><hr><h5 id="一、背景">一、背景</h5><p>这其实是一种模型轻量化的方法，VGG 和 Inception 都是在模型设计着手，希望减少内存的使用。</p><p>在卷积神经网络中，大卷积核（如 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>5</mn><mo>×</mo><mn>5</mn></mrow><annotation encoding="application/x-tex">5 \times 5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">5</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">5</span></span></span></span>、<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>7</mn><mo>×</mo><mn>7</mn></mrow><annotation encoding="application/x-tex">7 \times 7</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">7</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">7</span></span></span></span>）具有较大的感受野，但带来更多参数和更高的计算成本。因此，现代网络架构（如 VGG 和 Inception）采用了卷积核分解策略，在保持相似感受野的前提下显著降低参数量和 FLOPs。</p><hr><h5 id="二、VGG-的分解方式">二、VGG 的分解方式</h5><h6 id="1-思路">1. 思路</h6><p>使用两个连续的 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>3</mn><mo>×</mo><mn>3</mn></mrow><annotation encoding="application/x-tex">3 \times 3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">3</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">3</span></span></span></span> 卷积层来替代一个 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>5</mn><mo>×</mo><mn>5</mn></mrow><annotation encoding="application/x-tex">5 \times 5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">5</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">5</span></span></span></span> 卷积层。</p><ul><li>每个 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>3</mn><mo>×</mo><mn>3</mn></mrow><annotation encoding="application/x-tex">3 \times 3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">3</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">3</span></span></span></span> 卷积感受野是 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>3</mn></mrow><annotation encoding="application/x-tex">3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">3</span></span></span></span></li><li>两个堆叠后感受野变为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>5</mn></mrow><annotation encoding="application/x-tex">5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">5</span></span></span></span></li></ul><h6 id="2-感受野推导">2. 感受野推导</h6><p>假设每层卷积核大小为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi><mo>=</mo><mn>3</mn></mrow><annotation encoding="application/x-tex">k=3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">3</span></span></span></span>，堆叠 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mo>=</mo><mn>2</mn></mrow><annotation encoding="application/x-tex">L=2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">L</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">2</span></span></span></span> 层，stride=1，padding=1，则感受野为：</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>R</mi><mo>=</mo><mn>1</mn><mo>+</mo><mo stretchy="false">(</mo><mi>k</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo>×</mo><mi>L</mi><mo>=</mo><mn>1</mn><mo>+</mo><mo stretchy="false">(</mo><mn>3</mn><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo>×</mo><mn>2</mn><mo>=</mo><mn>5</mn></mrow><annotation encoding="application/x-tex">R = 1 + (k - 1) \times L = 1 + (3 - 1) \times 2 = 5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">L</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">2</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">5</span></span></span></span></span></p><h6 id="3-参数量对比（假设输入输出通道数均为-C）">3. 参数量对比（假设输入输出通道数均为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>C</mi></mrow><annotation encoding="application/x-tex">C</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span></span></span></span>）</h6><ul><li>原始 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>5</mn><mo>×</mo><mn>5</mn></mrow><annotation encoding="application/x-tex">5 \times 5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">5</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">5</span></span></span></span> 卷积参数量为：<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>25</mn><msup><mi>C</mi><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">25C^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord">25</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></li><li>两个 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>3</mn><mo>×</mo><mn>3</mn></mrow><annotation encoding="application/x-tex">3 \times 3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">3</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">3</span></span></span></span> 卷积为：<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn><mo>×</mo><mn>9</mn><msup><mi>C</mi><mn>2</mn></msup><mo>=</mo><mn>18</mn><msup><mi>C</mi><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">2 \times 9C^2 = 18C^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord">9</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord">18</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></li><li>相对节省：<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mn>18</mn><mn>25</mn></mfrac><mo>=</mo><mn>72</mn><mi mathvariant="normal">%</mi></mrow><annotation encoding="application/x-tex">\frac{18}{25} = 72\%</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1901em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8451em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">25</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">18</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8056em;vertical-align:-0.0556em;"></span><span class="mord">72%</span></span></span></span></li></ul><hr><h5 id="三、Inception-的分解方式">三、Inception 的分解方式</h5><h6 id="1-思路-2">1. 思路</h6><p>将二维的 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>5</mn><mo>×</mo><mn>5</mn></mrow><annotation encoding="application/x-tex">5 \times 5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">5</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">5</span></span></span></span> 卷积拆解为两个一维卷积：先做垂直方向的 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>5</mn><mo>×</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">5 \times 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">5</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span>，再做水平方向的 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mo>×</mo><mn>5</mn></mrow><annotation encoding="application/x-tex">1 \times 5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">5</span></span></span></span> 卷积。</p><h6 id="2-操作过程">2. 操作过程</h6><ul><li>第一步：<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>5</mn><mo>×</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">5 \times 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">5</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span> 卷积在输入图像上纵向滑动，融合每列中上下 5 个像素的信息</li><li>第二步：<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mo>×</mo><mn>5</mn></mrow><annotation encoding="application/x-tex">1 \times 5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">5</span></span></span></span> 卷积在中间特征图上横向滑动，融合每行左右 5 个像素的信息</li><li>最终输出感受野覆盖原图中的 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>5</mn><mo>×</mo><mn>5</mn></mrow><annotation encoding="application/x-tex">5 \times 5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">5</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">5</span></span></span></span> 区域</li></ul><h6 id="3-参数量对比（输入输出通道为-C）">3. 参数量对比（输入输出通道为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>C</mi></mrow><annotation encoding="application/x-tex">C</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span></span></span></span>）</h6><ul><li>原始 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>5</mn><mo>×</mo><mn>5</mn></mrow><annotation encoding="application/x-tex">5 \times 5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">5</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">5</span></span></span></span> 卷积参数量为：<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>25</mn><msup><mi>C</mi><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">25C^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord">25</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></li><li>分解卷积参数量为：<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>5</mn><msup><mi>C</mi><mn>2</mn></msup><mo>+</mo><mn>5</mn><msup><mi>C</mi><mn>2</mn></msup><mo>=</mo><mn>10</mn><msup><mi>C</mi><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">5C^2 + 5C^2 = 10C^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8974em;vertical-align:-0.0833em;"></span><span class="mord">5</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord">5</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord">10</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></li><li>相对节省：<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mn>10</mn><mn>25</mn></mfrac><mo>=</mo><mn>40</mn><mi mathvariant="normal">%</mi></mrow><annotation encoding="application/x-tex">\frac{10}{25} = 40\%</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1901em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8451em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">25</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">10</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8056em;vertical-align:-0.0556em;"></span><span class="mord">40%</span></span></span></span></li></ul><hr><h5 id="四、两种分解方式对比总结">四、两种分解方式对比总结</h5><table><thead><tr><th>方法</th><th>感受野</th><th>参数量</th><th>相对节省</th></tr></thead><tbody><tr><td>原始 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>5</mn><mo>×</mo><mn>5</mn></mrow><annotation encoding="application/x-tex">5 \times 5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">5</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">5</span></span></span></span> 卷积</td><td><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>5</mn><mo>×</mo><mn>5</mn></mrow><annotation encoding="application/x-tex">5 \times 5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">5</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">5</span></span></span></span></td><td><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>25</mn><msup><mi>C</mi><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">25C^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord">25</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></td><td>-</td></tr><tr><td>两个 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>3</mn><mo>×</mo><mn>3</mn></mrow><annotation encoding="application/x-tex">3 \times 3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">3</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">3</span></span></span></span> 卷积</td><td><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>5</mn><mo>×</mo><mn>5</mn></mrow><annotation encoding="application/x-tex">5 \times 5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">5</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">5</span></span></span></span></td><td><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>18</mn><msup><mi>C</mi><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">18C^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord">18</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></td><td>28%</td></tr><tr><td><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>5</mn><mo>×</mo><mn>1</mn><mo>+</mo><mn>1</mn><mo>×</mo><mn>5</mn></mrow><annotation encoding="application/x-tex">5 \times 1 + 1 \times 5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">5</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">5</span></span></span></span> 卷积</td><td><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>5</mn><mo>×</mo><mn>5</mn></mrow><annotation encoding="application/x-tex">5 \times 5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">5</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">5</span></span></span></span></td><td><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>10</mn><msup><mi>C</mi><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">10C^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord">10</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></td><td>60%</td></tr></tbody></table><hr><h5 id="五、结论与适用场景">五、结论与适用场景</h5><ul><li>VGG 的堆叠卷积方式简单直接，适用于一般结构的构建与替代</li><li>Inception 的分解卷积方式更高效、参数更少，适用于模块化组合（如 Inception 模块）</li></ul><p>两者都遵循一个核心思想：</p><blockquote><p>通过卷积核分解，在保持感受野不变的前提下，减少计算量与参数量，从而构建更高效的深度网络结构</p></blockquote><h4 id="其他模型轻量化方法">其他模型轻量化方法</h4><img src="./读书笔记---AI System/CleanShot 2025-04-07 at 15.55.21@2x.png" alt="CleanShot 2025-04-07 at 15.55.21@2x" style="zoom:67%;" /><p>这个写的还是挺明白的。</p><p>后面还讲了讲并行，覆盖的还算比较全面。</p><h3 id="关键设计指标">关键设计指标</h3><p>前面有一些指标感觉比较重要。</p><p>后面计算某个操作是计算受限型还是内存受限型还是比较有意思的。</p><p>最后 Roofline 的概念感觉也是经常可以在论文里看到，就计算某个系统的理论极值。</p><h3 id="核心计算之矩阵乘">核心计算之矩阵乘</h3><p>这里就是怎么把卷积换成矩阵乘法，感觉还比较有意义。</p><img src="./读书笔记---AI System/CleanShot 2025-04-08 at 09.40.27.png" alt="CleanShot 2025-04-08 at 09.40.27" style="zoom:80%;" /><img src="./读书笔记---AI System/CleanShot 2025-04-08 at 09.39.41.png" alt="CleanShot 2025-04-08 at 09.39.41" style="zoom:80%;" /><p>这个图就很直观</p><p>然后就是计算机实现矩阵乘法的一些优化，说实话没太看懂，也没仔细看。</p><h3 id="计算之比特位宽">计算之比特位宽</h3><p>这个基本讲的就是各种浮点数的标准，比如最标准的单精度浮点数的 32 个 bits 是怎么分配的，这个一般 OS 课应该会详细讲。后面还大概介绍了一下别的新的标准。</p><h2 id="AI-芯片基础">AI 芯片基础</h2><h3 id="CPU-基础">CPU 基础</h3><p>感觉全是各种历史，梦回大一计算机导论。</p><p>冯诺依曼结构，电路，各种寄存器。感觉 ECE 的同学主要就是学这些。</p><h3 id="CPU-指令集架构">CPU 指令集架构</h3><p>这个讲了很多 CISC 和 RISC 的东西。一般 OS 有三节课，感觉基本上就是 OS 第一节课会讲的，看一看就行，还是历史相关的内容比较多。CISC 和 RISC 都是 ISA 的分类，后面还讲了 CPU 并行处理架构。比如什么 SISD 之类的。</p><p>里面有几个图还挺好的。</p><img src="./读书笔记---AI System/CleanShot 2025-04-11 at 10.27.32@2x.png" alt="CleanShot 2025-04-11 at 10.27.32@2x" style="zoom:80%;" /><h3 id="CPU-计算本质">CPU 计算本质</h3><p>讲了一些参数，讲了一下 CPU，服务器之类的东西这几年来的发展。</p><h3 id="CPU-计算时延">CPU 计算时延</h3><p>用了一个例子分析了计算时延，基本上大头还是 load data 造成的。</p><h3 id="GPU-基础">GPU 基础</h3><p>基本上就是 GPU 发展的过程，NVIDIA 占据一大块，比国有个神奇的公司 ATI 从来没听说过，在这里戏份挺足。后面 ATI 被 AMD 收购了，AMD显卡的技术就来自于 ATI。</p><h3 id="NPU-基础">NPU 基础</h3><p>感觉真正做出来的 NPU 也就只有 Google 的 TPU。</p><p>主要就是 DSA（Domain-Specific Architecture）。</p><h3 id="超异构计算">超异构计算</h3><p>这个说的就是不拘泥于原来的提醒，把 CPU，GPU，TPU 什么的都整合到一个芯片上，用来应对比较复杂的问题。</p><p>而且其实就常规的 CPU + GPU 也算是异构计算，但他有两个独立的 memory。</p><p>不过我觉得最好的例子还是 Apple 的 M 系列芯片，尤其是 M4，统一内存，然后还有 GPU 核心，还有 CPU核心，还非常成功。</p><p>不过 Apple 的 M 系列芯是算异构还是超异构，其实我也不太清楚，毕竟这些都是比较新的概念，但感觉超异构的概念还是再说那种大型的计算中心。</p><h2 id="图形处理器-GPU">图形处理器 GPU</h2><h3 id="GPU-工作原理">GPU 工作原理</h3><p>GPU 里用的内存主要是 <strong>HBM（High Bandwidth Memory，高带宽内存）</strong>，是一种专门为<strong>高性能计算和图形处理器</strong>设计的先进内存技术。</p><img src="./读书笔记---AI System/CleanShot 2025-04-12 at 12.27.45.png" alt="CleanShot 2025-04-12 at 12.27.45" style="zoom:80%;" /><p>这个图很清楚。</p><h3 id="为什么-GPU-适用于-AI">为什么 GPU 适用于 AI</h3><p>又讲了很长的卷积，甚至还有矩阵计算，稍有重叠。</p><p>一个新的概念，tensor core。我的理解基本就是为了更好做矩阵计算的。</p><h3 id="GPU-架构与-CUDA-关系">GPU 架构与 CUDA 关系</h3><p>我的理解，一个线程就是一个 cuda core。</p><h3 id="GPU-架构回顾">GPU 架构回顾</h3><p>介绍 NVIDIA 的 GPU 历史了，但不得不说，NVIDIA 那么多显卡种类，那么多架构，一般人还真是都不知道，就知道一个 RTX。</p><p>稀疏化矩阵怎么计算的，这里也有稍微讲一下。</p><img src="./读书笔记---AI System/CleanShot 2025-04-12 at 19.27.04.png" alt="CleanShot 2025-04-12 at 19.27.04" style="zoom:80%;" /><p>但大部分还都是各种架构 GPU 的参数，其实挺无聊的。不过确实是能感受到 NVIDIA 的技术重心，最开始基本上就是帮助计算图像的，还有单独的图像处理单元，到最近基本上 all in AI，全都是围绕 AI 去做的产品。</p><h2 id="英伟达-GPU-详解">英伟达 GPU 详解</h2><p>前面一章已经讲了 GPU，这一章专门讲 Nvidia 的 GPU。</p><p>在 Nvidia 的 GPU 架构里，有三种主要核心：CUDA Core、Tensor Core 和 RT Core。</p><h3 id="Tensor-Core-基本原理">Tensor Core 基本原理</h3><p>这个小节讨论的就是 Tensor Core，又是用卷积来作为讨论，感觉卷积已经不太火了，但是本文很多具体的例子都是卷积相关的，可能当时写的时候 NLP 或者 LLM 还没很火吧。</p><p>最开始的处理核心是 Stream Processor（SPs）。</p><p>后来有了 Stream Multiprocessor（SMs）。</p><p>再后来才有的 CUDA Core，之后 AI 火了，为了加速矩阵运算才有的 Tensor Core。RT Core 则是光追单元，功能也是比较特殊。</p><p>之前其实就见到过，卷积操作可以变成矩阵乘法，这个操作叫做 Im2Col。</p><p>反正很神奇，我只能说我大概好像看懂具体是怎么操作的里，想法大致是了解的，但是具体的变换计算我也不知道书里写的对不对。</p><p>大致讲了一下混和精度训练，大致就是 FP32 的参数，转化为 FP16 进行 Forward，最后更新梯度的时候转回 FP32。</p><p>Tensor Core 的一大用处就是混合精度训练，因为混合精度训练一般需要硬件支持。</p><h3 id="Tensor-Core-架构演进">Tensor Core 架构演进</h3><p>这一章又讲了一点历史，但是还讲了很多芯片架构相关的知识，有很多架构图，还是比较清晰的。</p><h3 id="Tensor-Core-深度剖析">Tensor Core 深度剖析</h3><p>这个深度讲了 Tensor Core 的设计，非常神奇，他电路直接设计的就是做矩阵乘法，而不是我们正常设计的乘法器和加法器。</p><p>总的来说就是在计算的时候把大矩阵切成小矩阵去算，切成小矩阵的时候把数据放到共享内存或者更进一步放到 register 里，给 Tensor Core 里的计算单元去用。</p><h3 id="分布式通信与-NVLink">分布式通信与 NVLink</h3><p>讲了并行，就是什么 DP，PP，TP 啥的。</p><p>讲完并行之后引出了分布式训练，其实并行和分布式训练时联系在一起的。你把模型做切割就是为了放到不同的机器上做并行，你放到不同的机器上就是分布式训练了。</p><p>然后还介绍了通讯，硬件上比如说什么 PCIe、NVLink 之类的，但是就只是简单说了下。最后还有 NVLink 和 NVSwitch 每一代的演进。</p><p>还有各种通信的抽象类型，底下这个图还是比较清晰的。</p><img src="./读书笔记---AI System/CleanShot 2025-04-23 at 10.35.24@2x.png" alt="CleanShot 2025-04-23 at 10.35.24@2x" style="zoom:80%;" /><h3 id="NVLink-原理剖析">NVLink 原理剖析</h3><p>这章提到了两个概念，算存互联和算力互联。这两个方面感觉确实是很重要，很多时候训练的瓶颈都是卡在了通信上，而通信基本上就是在算存与算力之间通信。</p><p>最开始的时候只有 PCIe，但很明显 PCIe 速度比较比较慢，然后 Nvidia 就开卡了 NVLink，现在你基本如果想要组一个 Nvidia 的 GPU 集群的话，必要NVLink 或者 NVSwitch，价格也是很感人。</p><p>后面有一点技术细节，硬件上基本看不懂，信号传输，冗余什么的还能看懂一点。</p><p>最后又讲了一下这个发展历程，感觉发展历程讲了好几次。</p><h2 id="国外-AI-芯片">国外 AI 芯片</h2><h3 id="谷歌-TPU-历史发展">谷歌 TPU 历史发展</h3><p>就讲讲历史，感觉没啥的。</p><h3 id="谷歌-TPU-v1-脉动阵列">谷歌 TPU v1 脉动阵列</h3><p>这个脉动阵列和 Nvidia 的 tensor core 很像，都是直接一下子算个矩阵乘法。</p><img src="./读书笔记---AI System/CleanShot 2025-04-30 at 13.26.50.png" alt="CleanShot 2025-04-30 at 13.26.50" style="zoom:80%;" /><p>上面这图比较清楚。</p><h3 id="谷歌-TPU-v2-训练芯片">谷歌 TPU v2 训练芯片</h3><p>V2 我记得是可以进行训练了，v1 是纯推理卡。</p><p>然后 V2 加了互联的模块，就更适合连载一起组一个大的集群。</p><h3 id="谷歌-TPU-v3-POD-形态">谷歌 TPU v3 POD 形态</h3><p>V3 就是 V2 的算力加强版本，没太多架构上的变化，就制程工艺的进步，同样的大小塞的计算单元更多了。</p><h3 id="谷歌-TPUv4-与光路交换">谷歌 TPUv4 与光路交换</h3><p>TPU v4 用了很久才推出的，更新比较多。</p><p>感觉这个架构图比较重要。</p><img src="./读书笔记---AI System/CleanShot 2025-04-30 at 16.13.52.png" alt="CleanShot 2025-04-30 at 16.13.52" style="zoom:80%;" /><p>主要的变化是加了 Sparse Core 这个单元，然后就是在组计算单元的时候用了 3D-Torus。</p><p>Sparse Core 感觉就是主要为 NLP 做的，因为 NLP 我们 embedding 之后基本上就是一个很大的稀疏矩阵。</p><p>这个 notes 不得不说如果每章都写的话没啥意思，我自己看都没意思，还是写一些有意思的或者我自己的思考吧。</p>]]></content>
      
      
      <categories>
          
          <category> 书评 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MLSys </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Reading Notes for FasterMoE</title>
      <link href="/blogs/2025/03/28/FasterMoE/"/>
      <url>/blogs/2025/03/28/FasterMoE/</url>
      
        <content type="html"><![CDATA[<h1>Summary</h1><h2 id="Abstract-Introduction-Background-and-Challenges">Abstract &amp; Introduction &amp;  Background and Challenges</h2><p>前面又是简单介绍MoE，基本都一样。</p><p>这个也是training方向的，说了三个challenges：</p><ol><li><p><strong>dynamic load imbalance</strong></p><p>在intro里，叫<strong>Dynamic expert selection</strong>，就也比较明显，就是每次选的experts不一样。</p></li><li><p><strong>inefficient synchronous execution mode</strong></p><p>在intro里，叫<strong>Inefficient synchronous operations</strong>，就是expert有dependency，就需要别的worker的data，要等。</p></li><li><p><strong>congested all-to-all communication</strong></p><p>在intro里，叫<strong>Mismatch of model design and network topology</strong>，感觉他的意思是现在的system只管摆放experts的computation load，不管experts之间的communication。</p></li></ol><p>从abstract这里感觉他还是主要是关于解决communication方面的问题。</p><p>Intro前面又讲了很久介绍，还附了个图：</p><img src="./FasterMoE/CleanShot 2025-03-28 at 21.11.26.png" alt="CleanShot 2025-03-28 at 21.11.26" style="zoom:67%;" /><p>提出了一个 precise performance model，就在offline的时候根据MoE model and system configuration去预测latency。</p><p>三个方法，分别去解决上面的问题：Dynamic shadowing，A fine-grained smart scheduling strategy，a congestion-avoiding expert selection strategy。</p><p>contribution也是经典，一个a performance model，一个roofline-like model，加上上面三个方法，最合组合一起，整了一个system。六点贡献。</p><img src="./FasterMoE/CleanShot 2025-03-30 at 15.12.46.png" alt="CleanShot 2025-03-30 at 15.12.46" style="zoom:67%;" /> <p>又是一个新的transformer block的结构图。</p><img src="./FasterMoE/CleanShot 2025-03-30 at 15.39.19.png" alt="CleanShot 2025-03-30 at 15.39.19" style="zoom:67%;" /><p>这篇论文又说可以选好几个experts，我目前还是感觉一个token只能用选一个expert，这个论文里说的可能是一个sequence里面会用不同的，有点迷惑。</p><p>再次具体的说了一下这三个challenges。</p><img src="./FasterMoE/CleanShot 2025-03-30 at 18.07.29.png" alt="CleanShot 2025-03-30 at 18.07.29" style="zoom:67%;" /><p>Figure 4主要说的是第一个challenge，就是分配不均衡的这个问题。</p><p>第二个就是这个communication，一般我们喜欢尽量异步，但是all-to-all communication里面有一些dependency，所以很难异步。</p><p>第三个他虽然有说一遍，但我还是没太看懂，唯一理解是这个expert assignment确实有可以优化的地方。</p><h2 id="Performance-Modeling">Performance Modeling</h2><h2 id="Model-Guided-Optimization-Approaches">Model-Guided Optimization Approaches</h2><h2 id="Evaluation-Related-Work-Conclusion">Evaluation &amp; Related Work &amp; Conclusion</h2><h1>Thoughts</h1>]]></content>
      
      
      <categories>
          
          <category> Reading Paper </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MLSys </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Reading Notes for SmartMoE</title>
      <link href="/blogs/2025/03/27/SmartMoE/"/>
      <url>/blogs/2025/03/27/SmartMoE/</url>
      
        <content type="html"><![CDATA[<h1>Summary</h1><h2 id="Abstract-Introduction-Background-and-Motivation">Abstract &amp; Introduction &amp; Background and Motivation</h2><p>Deep neural network（DNN）现在越来越大，除了dense model，就是比较传统的model之外，越来越多的人开始关注sparsely activated model。针对dense model，之前有很多auto-parallelization的方法，但是这些方法对sparsely activated model，比如说MoE架构的模型就没那么好用了。所以他们主要做的就是实现对sparsely activated model做自动并行的分布式训练的方法。</p><p>Intro就先说一下来龙去脉，就众所周知，scaling law目前对DNN一直没有失效，所以各家基本上就是一直往上堆参数。但模型变大了就练不动了，所以就要找efficient method去做训练。一种就是从系统上，你去想办法去做并行训练，这样相同的计算资源，相同的时间，你能训练更大模型。要不然就是你对模型做改进，比如说MoE，虽然参数量很大，但因为每次训练的时候都只用activate一部分参数，所以就训练开销会降下来。</p><p>他们想说的就是没人把这两个结合起来，或者说有人在做MoE的时候，顺便针对他们的MoE有做这种并行训练的优化，但是没有太多去做通用一些的，automatic的并行方法给MoE。作者就说现有的模型都用是specific expert parallelism，但是这个方法又会影响training efficiency，是有一些方法来降低这个expert parallelism的cost，但是他们都“require special system expertise”，其实就还是再讲通用性的问题。然后又讲了自动化的问题，就说现有的automatic parallelization training systems都是为dense model服务的。这些基本都是在说research gap，就当前这个领域的空缺，或者也是一个为什么作者他们要做这个的原因。</p><img src="./SmartMoE/CleanShot 2025-03-27 at 14.51.39.png" alt="CleanShot 2025-03-27 at 14.51.39" style="zoom:67%;" /><p>这里放了个图，大概展示了一下dense model和MoE model的区别。</p><p>MoE有这么一个比较独特的结构，肯定就有一些独特的property。这里作者强调的是“dynamic and imbalanced property”。其实也很好理解，每次不一样的数据，gate选的expert就不一样，就很明显dynamic。然后肯定有的experts用的多，有的experts用的少，这就是imbalanced。而且这些都是和每次的数据直接相关的，所以他们强调了一个概念：<strong>data-sensitive</strong>。</p><p>既然MoE有data- sensitive的性质，那么当前的parallelization</p><p>approaches肯定就有不好的地方。这里说了两个limitation：</p><ul><li><p><strong>Limited Optimization Space</strong></p><p>这个说的是，data- sensitive可以让我们做更多的优化，但是现在的并没有考虑这么多可以做优化的地方，因为他们是base dense model的。</p></li><li><p><strong>Large Searching Overhead</strong></p><p>MoE因为data- sensitive，所以每次各个expert的workload都不一样，所以其实每次的execution plan应该也都不一样，所以我们希望可以每次都换到一个合适的execution plan。但是现在方法，用一些规划方法，算plan的时间太久了，很明显就没法满足这种比较高的换plan的方法。</p></li></ul><p>他们的方法就是我先算一堆比较好的plan，叫做<strong>static pool</strong>，然后又用了一个很快的算法去实时从这个pool里选plan。同时，他们还实现了一种机制，我也不知道该不该叫它一种机制，叫做<strong>awareness of workload</strong>。反正就是可以知道每个experts的workload，这样根据这个我们就可以选那些experts放到一个机器上，或者我们应该怎么并行。</p><p>在background里还介绍了各种并行，什么data parallelism（DP）， pipeline model parallelism（PP）， tensor model parallelism（TP）， expert parallelism（EP）。反正关于并行这里，就名称不统一，基本上就是横着切模型（PP），竖着切模型（TP），或者复制很多歌模型（DP）。EP是“a combination of Data Parallelism and Tensor Model Parallelism specialized for the MoE scenario”。这里也给了图，也算清楚吧。</p><img src="./SmartMoE/CleanShot 2025-03-27 at 16.07.46.png" alt="CleanShot 2025-03-27 at 16.07.46" style="zoom:67%;" /><p>主要还是图c，MoE part竖着切的，所谓的TP，但是Multi-Head那里又是复制了很多块，所以可以做DP。其实很合理的，因为你想MoE每次只用一个expert，但是前面的attention操作每一次都要做。所以前面每次都要做的我们用DP，后面E个expert只选一个的我们用TP。如果运气好，我们E个data做数据并行，到gate的时候正好assign到E个不同的experts，十分完美。</p><p>当然我们基本都用<strong>Hybrid Parallelism</strong>，就把不同的parallelism拼起来，你是怎么拼的，就是一个 <strong>parallel execution plan</strong>。也有一些automatic parallelization，但是time- consuming。</p><p>他们总结了关于提出一个automatic parallelization training system的难点：</p><ul><li><p><strong>Space of Hybrid Parallelism</strong></p><p>一个sytem不一定可以用所有的并行技术，你要知道这个space有多大，而且要尽量让他大。</p></li><li><p><strong>Performance Modeling</strong></p><p>怎么知道你选出来的plan好还是差。</p></li><li><p><strong>Searching Algorithm</strong></p><p>怎么从space里快速的选。</p></li></ul><img src="./SmartMoE/CleanShot 2025-03-27 at 16.30.16.png" alt="CleanShot 2025-03-27 at 16.30.16" style="zoom:67%;" /><p>Figure 3我感觉就是非常清楚的说了为什么要change plan，为什么要workload aware performance modeling。</p><h2 id="Overview-Enlarged-Space-for-Hybrid-Parallelism">Overview &amp; Enlarged Space for Hybrid Parallelism</h2><p>“Beyond prior works that generate optimal execution plans based on <em>model</em> architecture and <em>hardware</em> specification, we take the <strong>workload</strong> into account for data-sensitive models.”</p><img src="./SmartMoE/CleanShot 2025-03-28 at 15.37.41.png" alt="CleanShot 2025-03-28 at 15.37.41" style="zoom:67%;" /><p>这里分阶段讲了一下Two-Stage Auto-Parallelization。</p><p>第一个阶段是<strong>Offline Pool Construction</strong>。就是构建一个plan <strong>pool</strong>，都是一些比较好的execution plans。需要注意的就是他专门选的是那种相互之间比较好换的，要不然肯定不可行。</p><p>第二个阶段就是<strong>Online Adaptive Parallelization</strong>。这个时候就是已经开始训练了，就是用一个轻量级的算法去实时的找合适的execution plan。</p><p>这里有个概念感觉要提一下，<strong>expert slot</strong>，就是对于每一个expert（FFN）是用的什么并行。</p><img src="./SmartMoE/CleanShot 2025-03-28 at 16.08.47.png" alt="CleanShot 2025-03-28 at 16.08.47" style="zoom:70%;" /><p>还有一个concrete example，但其实我有点没看懂。</p><img src="./SmartMoE/CleanShot 2025-03-28 at 17.26.05.png" alt="CleanShot 2025-03-28 at 17.26.05" style="zoom:67%;" /><p>还说了一个<strong>expert placement</strong>，我感觉这个和Helix<a href="Helix">2</a>做的差不多，只不过Helix主要是在说inference，这个主要说的是训练而已。</p><h2 id="Offline-Pool-Construction-Online-Adaptive-Parallelization">Offline Pool Construction &amp;  Online Adaptive Parallelization</h2><h2 id="Evaluation-Related-Work-Conclusion">Evaluation &amp; Related Work &amp; Conclusion</h2><h1>Thoughts</h1><h2 id="About-their-method">About their method</h2><p>他这个方法我感觉主要应该还是侧重在这个automatic这一块，就是想要提出一个比较通用的方法，他在文章里我感觉也是一直在暗暗强调。</p><p>他们方法感觉也就是他们自己说的那个contribution：</p><ol><li>更多的并行组合方法，所谓的“enlarge the combination space of hybrid parallelism”。</li><li>Offline构建一个execution pool，online的时候用一个light-weight算法能实时从pool里选好的。</li><li>实现2需要“awareness of workload”，还需要一个light- weight算法。</li></ol><p>基本上就是这些。</p><h2 id="About-MoE-Framework">About MoE Framework</h2><p>有关MoE架构那里，有一点点跟我之前的理解稍有出入。他的MoE网络每一次经过gate，只会assign到<strong>一个</strong>最合适的expert。我之前的理解是可以随便组合expert，尤其是这个explicitly说了，一个FFN就是一个expert，也就是说expert之间应该是没有communication的。我之前的理解有点像backbone，backbone就是随机冻住一部分参数，就也是为了能够去训练比较大的网络。然后MoE的就是网络只有第一层是全连接，后面的不是全连接，但是我们gate去选expert其实就是选FFN的第一层的node。但不得不说现在看完他这种独立的说法，我觉得我以前的理解确实是有点误区，毕竟就是如果不是全连接的话，你怎么连接又是个问题。我现在就每个FFN就是个expert，然后都一样都是全连接网络，相互独立的，然后每次选一个最合适的，确实就是在实际训练的时候可行性更高。尤其是你要memory efficient，你有的时候要offload到别的地方去储存，然后在用的时候再load回来，确实需要一个个expert独立。</p><p>不过我现在就在想，每一个FFN反正就是都是全连接嘛，最后我把一些week connection直接drop掉呢。不知道distill是不是这么干的。</p><h2 id="About-Expert-Parallelism">About Expert Parallelism</h2><p>就是如果我们有这个gata了，其实就是说我们大概知道每个expert在一个workload里被用几次，那有没有可能我们把用的次数多的expert复制几个，就他们在做一个小的DP，这样是不是当用几个data同时assign到同一个expert的时候不用等了。或者至少inference的时候我们可以这么搞。</p><p>他这个Figure 5，我也是有点小问题，每一层的experts一定要一样数量，呀这个layer的意思是一个expert里面的层数还是experts的层数，有点不清楚，但是我还是比较倾向于一个expert（FFN）的层数</p><h2 id="Confusion-Guess">Confusion &amp; Guess</h2><p>这篇文章里比较重要的一个执行单元是“worker”，但其实我也没太懂他这一个worker到底是什么，我猜可能是一个GPU或者一个node。如果这样的话反正应该也要有一个assign任务的节点了。</p><h1>Reference</h1>]]></content>
      
      
      <categories>
          
          <category> Reading Paper </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MLSys </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>GitHub 实现多 page site（Hexo框架）</title>
      <link href="/blogs/2025/03/26/GitHub%20%E5%AE%9E%E7%8E%B0%E5%A4%9A%20page%20sit/"/>
      <url>/blogs/2025/03/26/GitHub%20%E5%AE%9E%E7%8E%B0%E5%A4%9A%20page%20sit/</url>
      
        <content type="html"><![CDATA[<p>如果你是用通过网上搜到的一些教程去 GitHub 上实现你自己的个人主页的话，你可能会发现大家都会强调你把你的 GitHub repo 的名字命名为 <code>username.github.io</code>。但实际上你可以在任意把任意的 repo 设置成你的项目主页，网上你可以搜到几个相关 GitHub 设置多 page 的帖子，随便放在这里<a href="https://segmentfault.com/a/1190000003946969">一个</a>，感兴趣可以去再看看。</p><p>总之，如果你只想把你基于 Hexo 的 blog deploy 到 GitHub 的话，很简单，只需要改两个 config。</p><p>在你的 <code>_config.yml</code> 文件里，把 <code>url</code> 改成 <code>https://&lt;username&gt;.github.io/&lt;reponame&gt;</code>。然后再加一个 <code>root</code> , 这个填成 <code>/&lt;reponame&gt;/</code> 。其他就正常配置就好了。</p><img src="./GitHub 实现多 page sit/CleanShot 2025-03-26 at 15.23.34.png" alt="CleanShot 2025-03-26 at 15.23.34" style="zoom:70%;" /><p>我唯一遇到的，可能会出问题的地方，是在那个 page setting 那里。</p><img src="./GitHub 实现多 page sit/CleanShot 2025-03-26 at 15.31.56.png" alt="CleanShot 2025-03-26 at 15.31.56" style="zoom:67%;" /><p>这里可能不能用 GitHub action，不过我也不确定，但我之前调到 GitHub action 的时候会出问题。如果你发现你 deploy 到 github 上之后，他并没有生成一个 page site，你可以试一试把这个改一下。</p><p>这就是全部内容了，希望对你有用。</p>]]></content>
      
      
      <categories>
          
          <category> Tech Blogs </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Web </tag>
            
            <tag> Personal Blog Website </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Typora+Hexo工作流</title>
      <link href="/blogs/2025/03/25/Typora+Hexo%E5%B7%A5%E4%BD%9C%E6%B5%81/"/>
      <url>/blogs/2025/03/25/Typora+Hexo%E5%B7%A5%E4%BD%9C%E6%B5%81/</url>
      
        <content type="html"><![CDATA[<p>你想实现本地Typora进行写作，然后丝滑的推倒你的blog网站吗？本篇blog可以帮你实现这一效果。</p><h1>为什么会需要解决这个问题？</h1><p>通常我们建立一个个人博客网站之后，尤其是如果你是基于Hexo建站的话，你的post全部都是基于md文件的。那么如果正好，你已经习惯了用md文件进行本地写作，那么你一定想要快速的直接把本地的md文件deploy到你的网站上。</p><p>如果你没有使用过图床，或者你专门想要把你每个md文件插入的图片放到一个专门的位置。比如说我，我就是用Typora的高级功能，指定了存图片的地点，这样你的图片即在本地，又分门别类，十分好找。</p><p>现在你再deply到你的blog网站上时，你就会遇到问题了，因为Hexo generate出来的public文件夹里的各个post文件夹里并没有相应的图片。本篇就旨在让你丝滑的将本地文件deply到你的个人blog网站。</p><h1>Hexo Settings</h1><p>想要实现以上的功能，首先对于每一个post，你需要有一个文件夹来存你这post里面的图片。</p><p>你需要将 <code>post_asset_folder: false</code> 改成 <code>post_asset_folder: true</code> 来对每一个post都创建一个文件夹来存这个post里面的图片。</p><p>效果如下：</p><p>使用<code>hexo new post &quot;Hello World&quot;  </code> 创建一个新post。</p><img src="Typora+Hexo工作流/CleanShot 2025-03-25 at 20.01.11.png" alt="CleanShot 2025-03-25 at 20.01.11" style="zoom:75%;" /><p>在你的 <code>source/_post</code> 文件夹里，你应该可以看到一个<code>Hello-World</code> 文件夹和一个 <code>Hello-World.md</code> 文件。</p><img src="Typora+Hexo工作流/CleanShot 2025-03-25 at 20.02.41.png" alt="CleanShot 2025-03-25 at 20.02.41" style="zoom:100%;" /><p>但是如果你直接 <code>hexo generate</code> 的话，你会在public文件夹，得到一个post文件夹，里面有你的md文件和相应的图片。</p><p>比如在这里，我有 <code>Typora+Hexo工作流.md</code>文件和一个相对应的 <code>Typora+Hexo工作流</code>。</p><img src="Typora+Hexo工作流/CleanShot 2025-03-25 at 20.08.30.png" alt="CleanShot 2025-03-25 at 20.08.30" style="zoom:75%;" /><p>但是当我 <code>hexo generate</code> 之后，我会只得到一个文件夹。</p><img src="Typora+Hexo工作流/CleanShot 2025-03-25 at 20.10.26.png" alt="CleanShot 2025-03-25 at 20.10.26" style="zoom:75%;" /><p>这就会使得之前的md文件里的图片路径有问题。</p><p>我的解决办法就是把这些图片再塞到一个同名文件夹里，相应的代码在<a href="https://github.com/S-tanley/Typora-Hexo">这里</a>。将<code>organize_images.py</code> 放在你的Hexo项目根目录下，执行 <code>python organize_images.py</code> 效果如下：</p><img src="Typora+Hexo工作流/CleanShot 2025-03-25 at 20.13.14.png" alt="CleanShot 2025-03-25 at 20.13.14" style="zoom:75%;" /><p>这样你的md文件里的图片路径就没有问题啦。</p><p>需要注意的是，我使用的theme是Bytterfly，我不确定是不是所有的theme创建的public文件都是根据日期去创建post文件的，如果不是的话，我的这个文件可能不会work。但是这是一个非常简单的文件，你可以自行更改。</p><h1>Typora Setting</h1><p>如果你是比较会用typora，知道怎么样子才能设置自动保存图片。那你就可以略过这个section，如果你还不太知道，可以继续看。</p><p>非常简单，打开你的Typora，进入<code>Format &gt; Image &gt; Global Image Settings</code>。设置成图片里的样子就可以啦！</p><img src="Typora+Hexo工作流/CleanShot 2025-03-25 at 20.18.30.png" alt="CleanShot 2025-03-25 at 20.18.30" style="zoom:80%;" /><ol><li>这个的意思就是同路径下，如果没有的话创建一个跟你md文件同名的folder去存你的图片，如果有的话直接存到这个同名的folder里。这个是专门和Hexo的相匹配上的。</li><li>这个意思是使用相对路径，必须要使用相对路径。</li><li>这个可以加，可以不加，我个人习惯加。但其实如果你deploy到GitHub或者别的网站上的话其实正常应该不叫。但反正加了也能work。</li></ol><p>如果你的不是mac或者你是中文，或者版本不一样，你可以自行搜索一下如何进行修改。</p><p>其实我当时随便搜了一下，就搜到了两三个Hexo来解决这个问题，但是他们都有bug而且没有解决，而且感觉也不会解决了（非常老的repo）。这个问题我感觉也不需要插件这么麻烦，就一个非常简答的脚本就可以解决。</p><p>大概就是这样啦，希望能对你有用，如果你有什么问题，可以发到评论区里。</p>]]></content>
      
      
      <categories>
          
          <category> Tech Blogs </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Web </tag>
            
            <tag> Personal Blog Website </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>一个 CS 大三学生的碎碎念</title>
      <link href="/blogs/2025/03/25/%E4%B8%80%E4%B8%AA%E5%A4%A7%E4%B8%89%20CS%20%E5%AD%A6%E7%94%9F%E7%9A%84%E7%A2%8E%E7%A2%8E%E5%BF%B5/"/>
      <url>/blogs/2025/03/25/%E4%B8%80%E4%B8%AA%E5%A4%A7%E4%B8%89%20CS%20%E5%AD%A6%E7%94%9F%E7%9A%84%E7%A2%8E%E7%A2%8E%E5%BF%B5/</url>
      
        <content type="html"><![CDATA[<p>在这里随便写点东西，做一个小小的总结吧。</p><p>感觉这三年学了很多东西，但还是很迷茫，不知道以后应该干什么。马上就大四了，感觉工作也找不到，博士也很难伸到，暑研也伸不到，唯一感觉做的比较好的就是绩点维持的挺好，而且大部分课都是有比较认真的学，确实是会了一些东西，但感觉都很理论，也不知道怎么用。找工作的时候需要的技术栈基本都不会，或者只会一点皮毛，真的遇到大型项目就啥也不会，也无从下手；找 research 也是，要读很多导师方向的论文，感觉之前学的一些东西也基本用不上，就感觉很多东西都匹配不上。但其实也没什么可抱怨的，毕竟感觉自己确实是有点三天打鱼两天晒网，很多东西想要自学但是从没有坚持做完过，虽然已经快大四了，感觉再开始自学一些东西已经有点晚了，但还是希望自己在最后一年真的完整的自学完几门网课，毕竟现在感觉已经明确了自己未来的方向了，就不能在松懈了。</p><p>最近也看到了很多大佬的总结，感觉大部分都是大一大二就已经很强，至少也是有明确道路了，空闲时间大部分都在提升自己的技术。我大一的时候在想，刚上大学，不用对自己太苛刻。应该只有在上大学之前的暑假系统的学了一下C语言，又因为要 transfer，要学托福，这个占用了很多的时间，包括大一到大二的暑假，还有大二的寒假。最后 transfer 来到 UW-Madison，还是很喜欢这个学校的，发现学业压力甚至更重了，因为要上很多之前上过的课，我又傻傻的 double 了一个 STAT 的 major。其实根本不应该 double，当时觉得学一学 STAT 的课很不错，但其实 CS 有那么多的方向可以去学，真的没必要再去涉猎 STAT。于是乎，现在就导致我没有一门精的。</p><p>25 Spring 这个学期可以说是我压力最大的一个学期，因为我找了一个 remote intern，还有一个 remote research。但是发现如果去找工，自己的技术根本不够用，但是又因为这个 intern 占据了我一定的时间，再加上学业上真的压力很重，我这个学期连续5周，每周至少一个 midterm，放了一个一周的 Spring break，回来之后又是连着两周有考试，在之后两周就就是 final。Remote research 导师人也很放羊，但不得不说导师我感觉人很好了，毕竟我确实啥也不会，也愿意跟我meeting 一下，给我一些 paper list，虽然也不花太多时间吧，但我感觉还是挺好的。这样毕竟压力很小，导致我基本没有进展，因为更多的时间都花在了另外两项上。如果硬要说的话，一天我差不多有 10 - 12 个小时是可以用来做事情的，如果这 10 - 12 个小时，我一分钟都不玩，我觉得确实可以同时 handle 这三项，但是太难了，我唯一的娱乐就是踢球，或者看小说，真的确实是做不到一点娱乐都没有。这就导致确实没办法平衡好，😮‍💨，还是太菜了。而且我这个 remote intern，给我的心里压力比较大，虽然我当时就是随机投了一个，然后也是 unpaid，但是当时确实是有承诺会好好做，感觉也没有做的很好，有的时候就感觉压力很大，因为会有自己没有说到做到的内疚。</p><p>但毕竟也不是完全没有收获，我感觉至少我未来的学习方向清晰了一点，要系统的学一学前端；其次就是学一学 HPC，disturbed sys，并行计算方向的课程；最后就是从假期开始每日一题，在做题的同时学一学算法。</p><p>这个暑假一定要好好利用好💪，不能在空耗时间了，给自己狠狠的立 flag。</p>]]></content>
      
      
      <categories>
          
          <category> Life Blogs </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 随笔 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>建立个人 Blog 网站</title>
      <link href="/blogs/2025/03/25/%E5%BB%BA%E7%AB%8B%E4%B8%AA%E4%BA%BABlog%E7%BD%91%E7%AB%99/"/>
      <url>/blogs/2025/03/25/%E5%BB%BA%E7%AB%8B%E4%B8%AA%E4%BA%BABlog%E7%BD%91%E7%AB%99/</url>
      
        <content type="html"><![CDATA[<p>耗时两天，也算是成功搭建起了自己的Blog网站，其实之前就有试过搭网站，用的WordPress，其实也算成功，但是似懂非懂，当时又是为了找一个Intern才专门看了看，最后也没被录取，就没继续看相关的技术了，最近正好有时间，就有看了看怎么搭网站，终于成功了，还是挺有意思的，那么作为正式的第一篇Tech Blog，就简单写一下我搭建网站的整个过程吧，希望对你有帮助。</p><h1>Gmeek</h1><p>我首先是在哔哩哔哩上看到了一个<a href="https://www.bilibili.com/video/BV1GM4m1m7ZD">视频</a>，确实是非常简单，如果对自己的blog网站没什么，可以直接用这个<a href="https://blog.meekdai.com/post/Gmeek-kuai-su-shang-shou.html">Gmeek</a>。不得不说，麻雀虽小，五脏俱全。</p><h2 id="Limitation">Limitation</h2><p>他的优点当然就是很简单很清爽，但是当然还是会有一些小问题。</p><ul><li><p>工作流不匹配</p><p>他这个博客框架主要依托于GitHub的issue，所以每次写blog你都相当于是在issue那里面写，虽然怪但还是可以接受。但我还是想要能够做到本地写，然后push到github，这样的工作流。如果你想要这样的工作流，那么Gmeek就没办法满足你了。</p></li><li><p>批量管理</p><p>如果你在别的平台有blog，是基于md文件的，通常来讲你想要在别的平台发布是比较简单的，但是他这个你就只能一个一个粘过去，肯定是不太方便的。</p></li></ul><h2 id="Unresolved-Problems">Unresolved Problems</h2><p>我在用这个框架的时候，甚至还遇到了一些问题，现在也没解决，当然可能是我个人的问题。</p><ul><li><p>使用custom domain</p><p>因为那个视频里只说了用cloudfare的方法，但我个人用的又是sitground。反正我基本上就是用同样的方法去做的，但是出现了神奇的bug，甚至我还提了一个<a href="https://github.com/Meekdai/Gmeek/issues/251">issue</a>。目前我来看可能是因为，创建一个cname需要时间，但也不确定，当时就是一直不好用，我就直接删掉那个repository换了一个技术路线了。</p></li><li><p>其实就是上面这个问题的后续，我再根据Gmeek重新建一个Blog repository之后，全局生成是对的，但是每一个issue的生成会失败，非常的神奇，也没有找到原因。</p></li></ul><h1>Hexo+GitHub</h1><p>最后还是走到了这个经典道路，主要根据的是这个<a href="https://www.bilibili.com/video/BV1nY6xYmEw7">视频</a>。里main重复的内容我就不多说了，所以我这个blog并没有具体的怎么搭建网络的教程，跟着视频走就可以啦。我最后也没有把网站托管到别的平台上，就只用了GitHub的静态网页。</p><p>然后我用的Hexo theme是<a href="https://github.com/jerryc127/hexo-theme-butterfly">butterfly</a>，一个比较复杂的主题，用的人也很多，可以实现非常多的功能。还是非常有趣的。</p><h2 id="Deploy">Deploy</h2><p>我们正常在本地去看我们的网站的方法是用<code>hexo generate &amp;&amp; hexo server</code>。 <code>hexo generate</code>就是生成了一个public文件夹，<code>hexo server</code>里面有网站运行需要的东西；就是整了一个本地端口为4000的浏览器。</p><p>需要注意的一个问题就是，你的图片的后缀，比如<code>.jpg</code> 和<code>.JPG</code>在你本地（Mac）上是不会区分的，但是到了GitHub上，他是严格区分的。我当时因为这个至少找了半个小时bug。</p><p>其次就是你真正部署到GitHub上的命令：<code>hexo clean &amp;&amp; hexo generate &amp;&amp; hexo deploy</code>，其实这三个是可以分开的，<code>hexo clean</code>其实就会死把你之前生成的<code>public</code>文件夹和里面的东西都给一起删了；<code>hexo deploy</code>就是把你的<code>public</code>文件夹给push到GitHub上（如果你按照视频改了<code>_config.yml</code>文件的话）。</p><p>如果你每次改完东西，你就可以重新执行一遍上面这三个命令，你的网站就应该会更新。</p><h3 id="自定义">自定义</h3><p>不管你用的是什么Hexo theme，应该都会有很多自定义的配置，你可以根据他们的<a href="https://butterfly.js.org/categories/Docs%E6%96%87%E6%AA%94/">官方文档</a>进行修改。他们有官网，你也可以提issue，也可以发到discussion里，就我目测回复频率还是提高的。</p><p>以上就是全部内容啦！希望对你有用。</p>]]></content>
      
      
      <categories>
          
          <category> Tech Blogs </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Web </tag>
            
            <tag> Personal Blog Website </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>生活日志(2025-3-24)</title>
      <link href="/blogs/2025/03/24/%E7%94%9F%E6%B4%BB%E6%97%A5%E5%BF%97(2025-3-24)/"/>
      <url>/blogs/2025/03/24/%E7%94%9F%E6%B4%BB%E6%97%A5%E5%BF%97(2025-3-24)/</url>
      
        <content type="html"><![CDATA[<p>其实没有太多可以说的，今天再次尝试了搭建个人网页，尝试了很久，还挺有意思，就是太耗时了。之后写了一篇相关的 <a href="https://s-tanley.github.io/blogs/2025/03/25/%E5%BB%BA%E7%AB%8B%E4%B8%AA%E4%BA%BABlog%E7%BD%91%E7%AB%99/?highlight=%E5%BB%BA%E7%AB%8B">blog</a>，也算是记录一下。</p>]]></content>
      
      
      <categories>
          
          <category> Life Blogs </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 日记 </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
